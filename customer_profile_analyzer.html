<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê³ ê° í”„ë¡œíŒŒì¼ ë¶„ì„</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<style>
:root {
  --primary: #1E88E5;
  --primary-light: #E3F2FD;
  --primary-dark: #1565C0;
  --success: #43A047;
  --success-light: #E8F5E9;
  --warning: #FB8C00;
  --warning-light: #FFF3E0;
  --danger: #E53935;
  --gray-50: #FAFAFA;
  --gray-100: #F5F5F5;
  --gray-200: #EEEEEE;
  --gray-300: #E0E0E0;
  --gray-500: #9E9E9E;
  --gray-700: #616161;
  --gray-900: #212121;
  --radius: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
  background: var(--gray-50);
  color: var(--gray-900);
  line-height: 1.6;
}
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }

/* Header */
.header {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  padding: 24px 32px;
  border-radius: var(--radius);
  margin-bottom: 24px;
  box-shadow: var(--shadow-md);
}
.header h1 { font-size: 24px; font-weight: 700; }
.header p { font-size: 14px; opacity: 0.85; margin-top: 4px; }

/* Cards */
.card {
  background: white;
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
}
.card h2 {
  font-size: 16px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Upload Area */
.upload-area {
  border: 2px dashed var(--gray-300);
  border-radius: var(--radius);
  padding: 40px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--gray-50);
}
.upload-area:hover, .upload-area.dragover {
  border-color: var(--primary);
  background: var(--primary-light);
}
.upload-area .icon { font-size: 48px; margin-bottom: 12px; }
.upload-area p { color: var(--gray-700); font-size: 14px; }
.upload-area input { display: none; }

/* Status Cards */
.status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; }
.status-card {
  padding: 16px;
  border-radius: var(--radius);
  border: 1px solid var(--gray-200);
}
.status-card.loaded {
  border-color: var(--success);
  background: var(--success-light);
}
.status-card.empty {
  border-color: var(--warning);
  background: var(--warning-light);
}
.status-card .dim-name { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
.status-card .dim-info { font-size: 12px; color: var(--gray-700); }

/* Controls */
.controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
.control-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-700);
  margin-bottom: 6px;
}
.control-group select, .control-group input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
  background: white;
}
.control-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(30,136,229,0.15);
}
.checkbox-group {
  display: flex;
  gap: 20px;
  align-items: center;
  margin-top: 8px;
}
.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  cursor: pointer;
  font-weight: 400;
  color: var(--gray-900);
}

/* Tabs */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--gray-200);
  margin-bottom: 20px;
}
.tab-btn {
  padding: 10px 24px;
  border: none;
  background: none;
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-500);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
  font-family: inherit;
}
.tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}
.tab-btn:hover { color: var(--primary-dark); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Metrics Row */
.metrics-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
.metric-card {
  background: var(--gray-100);
  padding: 12px 16px;
  border-radius: 6px;
  text-align: center;
}
.metric-card .label { font-size: 12px; color: var(--gray-500); }
.metric-card .value { font-size: 20px; font-weight: 700; color: var(--primary); }

/* Table */
.table-wrapper { overflow-x: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
thead th {
  background: var(--primary);
  color: white;
  padding: 10px 12px;
  text-align: center;
  font-weight: 600;
  white-space: nowrap;
  position: sticky;
  top: 0;
}
thead th:first-child { text-align: left; }
tbody td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--gray-200);
  text-align: center;
  white-space: nowrap;
}
tbody td:first-child { text-align: left; font-weight: 500; }
tbody tr:hover { background: var(--primary-light); }
tbody tr:nth-child(even) { background: var(--gray-50); }
tbody tr:nth-child(even):hover { background: var(--primary-light); }

/* Highlight max value in row */
td.max-val { background: #E3F2FD; font-weight: 700; color: var(--primary-dark); }

/* Buttons */
.btn {
  padding: 8px 20px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;
}
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--gray-200); color: var(--gray-700); }
.btn-secondary:hover { background: var(--gray-300); }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #C62828; }
.btn-group { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

/* Chart */
.chart-container { max-width: 900px; margin: 0 auto; }
.chart-controls { display: flex; gap: 8px; margin-bottom: 16px; }
.chart-controls .btn.active { background: var(--primary); color: white; }

/* Integrated View */
.integrated-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
.integrated-card {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  padding: 16px;
}
.integrated-card h4 {
  font-size: 15px;
  color: var(--primary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--primary-light);
}
.attr-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.attr-bar .name { width: 80px; font-size: 13px; font-weight: 500; text-align: right; flex-shrink: 0; }
.attr-bar .bar-bg {
  flex: 1;
  height: 24px;
  background: var(--gray-200);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}
.attr-bar .bar-fill {
  height: 100%;
  background: var(--primary);
  border-radius: 4px;
  transition: width 0.5s ease;
  min-width: 2px;
}
.attr-bar .pct { width: 55px; font-size: 13px; font-weight: 600; text-align: right; flex-shrink: 0; }

/* Drilldown */
.drilldown-controls { display: flex; gap: 12px; align-items: flex-end; margin-bottom: 16px; flex-wrap: wrap; }
.breadcrumb { font-size: 13px; color: var(--gray-500); margin-bottom: 12px; }
.breadcrumb span { color: var(--primary); font-weight: 600; }

/* Hidden */
.hidden { display: none !important; }

/* Info */
.info-box {
  background: var(--primary-light);
  border: 1px solid #BBDEFB;
  border-radius: 6px;
  padding: 16px;
  font-size: 14px;
  color: var(--primary-dark);
  text-align: center;
}

/* Radio buttons styled */
.radio-group { display: flex; gap: 0; }
.radio-group label {
  padding: 6px 16px;
  border: 1px solid var(--gray-300);
  font-size: 13px;
  cursor: pointer;
  background: white;
  transition: all 0.2s;
  font-weight: 400;
  color: var(--gray-700);
}
.radio-group label:first-child { border-radius: 6px 0 0 6px; }
.radio-group label:last-child { border-radius: 0 6px 6px 0; }
.radio-group label:not(:last-child) { border-right: none; }
.radio-group input { display: none; }
.radio-group input:checked + span {
  /* handled via JS by adding .active class to label */
}
.radio-group label.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}
</style>
</head>
<body>
<div class="container">

<!-- Header -->
<div class="header">
  <h1>ê³ ê° í”„ë¡œíŒŒì¼ ë¶„ì„</h1>
  <p>ìƒí’ˆë³„ ê³ ê° í”„ë¡œíŒŒì¼(ìë…€ë‚˜ì´, ê²°í˜¼ìƒíƒœ, ê°€êµ¬ë‹¹ì¸ì›) ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê³  ì¹´í…Œê³ ë¦¬ë³„ ë¹„ì¤‘ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p>
</div>

<!-- Section 1: Upload -->
<div class="card">
  <h2>1. ë°ì´í„° ì—…ë¡œë“œ</h2>
  <div class="upload-area" id="uploadArea">
    <div class="icon">ğŸ“‚</div>
    <p><b>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸</b>í•˜ì—¬ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
    <p style="font-size:12px; margin-top:8px; color:#999;">íŒŒì¼ëª… íŒ¨í„´: ìƒí’ˆ_ê³ ê°í”„ë¡œíŒŒì¼_{ì†ì„±}_{ì‹œì‘ì¼}_{ì¢…ë£Œì¼}.xlsx (ìµœëŒ€ 3ê°œ)</p>
    <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
  </div>
  <div class="status-grid" id="statusGrid">
    <div class="status-card empty" id="status-ìë…€ë‚˜ì´">
      <div class="dim-name">ìë…€ë‚˜ì´</div>
      <div class="dim-info">ë¯¸ì—…ë¡œë“œ</div>
    </div>
    <div class="status-card empty" id="status-ê²°í˜¼ìƒíƒœ">
      <div class="dim-name">ê²°í˜¼ìƒíƒœ</div>
      <div class="dim-info">ë¯¸ì—…ë¡œë“œ</div>
    </div>
    <div class="status-card empty" id="status-ê°€êµ¬ë‹¹ì¸ì›">
      <div class="dim-name">ê°€êµ¬ë‹¹ì¸ì›</div>
      <div class="dim-info">ë¯¸ì—…ë¡œë“œ</div>
    </div>
  </div>
  <div class="btn-group">
    <button class="btn btn-danger hidden" id="resetBtn" onclick="resetData()">ë°ì´í„° ì´ˆê¸°í™”</button>
  </div>
</div>

<!-- Section: Convex DB -->
<div class="card" id="convexCard">
  <h2>ë°ì´í„° ê´€ë¦¬ (Convex DB)</h2>
  <div style="display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;">
    <div class="control-group" style="flex:1; min-width:200px;">
      <label>ê¸°ê°„ ì„ íƒ</label>
      <select id="selPeriod" onchange="loadPeriodData()">
        <option value="">-- ê¸°ê°„ ì„ íƒ --</option>
        <option value="__ALL__">ì „ì²´ ëˆ„ì </option>
      </select>
    </div>
    <button class="btn btn-primary hidden" id="btnSaveConvex" onclick="saveToConvex()">DBì— ì €ì¥</button>
    <button class="btn btn-secondary" onclick="refreshPeriods()">ìƒˆë¡œê³ ì¹¨</button>
  </div>
  <div id="convexProgress" class="hidden" style="margin-top:12px;">
    <div style="background:var(--gray-200); border-radius:4px; height:8px; overflow:hidden;">
      <div id="progressBar" style="width:0%; height:100%; background:var(--primary); transition:width 0.3s;"></div>
    </div>
    <div id="progressText" style="font-size:12px; color:var(--gray-500); margin-top:4px;">ì¤€ë¹„ ì¤‘...</div>
  </div>
  <div id="convexStatus" style="font-size:12px; color:var(--gray-500); margin-top:8px;"></div>
</div>

<!-- Section 2: Controls -->
<div class="card hidden" id="controlsCard">
  <h2>2. ë¶„ì„ ì„¤ì •</h2>
  <div class="controls-grid">
    <div class="control-group">
      <label>ë¶„ì„ ì°¨ì›</label>
      <select id="selDimension" onchange="runAnalysis()"></select>
    </div>
    <div class="control-group">
      <label>ì§‘ê³„ ìˆ˜ì¤€</label>
      <select id="selLevel" onchange="runAnalysis()">
        <option value="ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)">ëŒ€ë¶„ë¥˜</option>
        <option value="ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)" selected>ì¤‘ë¶„ë¥˜</option>
        <option value="ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)">ì†Œë¶„ë¥˜</option>
        <option value="ìƒí’ˆ">ìƒí’ˆ</option>
      </select>
    </div>
    <div class="control-group">
      <label>ì§€í‘œ</label>
      <div class="radio-group" id="metricGroup">
        <label class="active" onclick="selectMetric(this, 'ê²°ì œê¸ˆì•¡')"><span>ê²°ì œê¸ˆì•¡</span></label>
        <label onclick="selectMetric(this, 'ê²°ì œìˆ˜')"><span>ê²°ì œìˆ˜</span></label>
        <label onclick="selectMetric(this, 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰')"><span>ê²°ì œìƒí’ˆìˆ˜ëŸ‰</span></label>
      </div>
    </div>
    <div class="control-group">
      <label>ì˜µì…˜</label>
      <div class="checkbox-group">
        <label><input type="checkbox" id="chkExcludeUnknown" checked onchange="runAnalysis()"> (ì•Œìˆ˜ì—†ìŒ) ì œì™¸</label>
        <label><input type="checkbox" id="chkShowAbsolute" onchange="renderCurrentTab()"> ì ˆëŒ€ê°’ í‘œì‹œ</label>
      </div>
    </div>
  </div>
</div>

<!-- Section 3: Results -->
<div class="card hidden" id="resultsCard">
  <h2>3. ë¶„ì„ ê²°ê³¼</h2>

  <div class="metrics-row" id="metricsRow"></div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('table')">í…Œì´ë¸” ë³´ê¸°</button>
    <button class="tab-btn" onclick="switchTab('chart')">ì°¨íŠ¸ ë³´ê¸°</button>
    <button class="tab-btn" onclick="switchTab('integrated')">í†µí•© ë³´ê¸°</button>
  </div>

  <!-- Tab 1: Table -->
  <div class="tab-content active" id="tab-table">
    <div style="margin-bottom:12px;">
      <input type="text" id="searchInput" placeholder="ì¹´í…Œê³ ë¦¬/ìƒí’ˆëª… ê²€ìƒ‰..." oninput="filterAndRender()"
        style="width:100%; max-width:400px; padding:8px 12px; border:1px solid var(--gray-300); border-radius:6px; font-size:14px; font-family:inherit;">
    </div>
    <div class="table-wrapper" id="mainTable"></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="exportExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--gray-200);">
    <h3 style="font-size:15px; font-weight:600; margin-bottom:12px;">ë“œë¦´ë‹¤ìš´ ë¶„ì„</h3>
    <div class="drilldown-controls" id="drilldownControls"></div>
    <div id="drilldownResult"></div>
  </div>

  <!-- Tab 2: Chart -->
  <div class="tab-content" id="tab-chart">
    <div class="chart-controls" id="chartTypeGroup">
      <button class="btn btn-primary" onclick="selectChartType('bar-h')">ê°€ë¡œ ë§‰ëŒ€</button>
      <button class="btn btn-secondary" onclick="selectChartType('bar-v')">ì„¸ë¡œ ë§‰ëŒ€</button>
      <button class="btn btn-secondary" onclick="selectChartType('pie')">íŒŒì´</button>
    </div>
    <div id="pieSelector" class="hidden" style="margin-bottom:16px;">
      <div class="control-group" style="max-width:300px;">
        <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
        <select id="selPieCategory" onchange="renderPieChart()"></select>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="mainChart"></canvas>
    </div>
  </div>

  <!-- Tab 3: Integrated -->
  <div class="tab-content" id="tab-integrated">
    <div id="integratedContent"></div>
  </div>
</div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Constants
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIMENSIONS = {
  'ìë…€ë‚˜ì´': ['ì´ˆë“±í•™ìƒ', 'ë¯¸ì·¨í•™', 'ìë…€ì—†ìŒ', 'ì¤‘ê³ ë“±í•™ìƒ', '0-24ê°œì›”', 'ì„±ì¸', '(ì•Œìˆ˜ì—†ìŒ)'],
  'ê²°í˜¼ìƒíƒœ': ['ê¸°í˜¼', 'ë¯¸í˜¼', '(ì•Œìˆ˜ì—†ìŒ)'],
  'ê°€êµ¬ë‹¹ì¸ì›': ['2ì¸ì´ìƒ', '1ì¸', '(ì•Œìˆ˜ì—†ìŒ)'],
};
// ì‹¤ì œ ì—‘ì…€ ì»¬ëŸ¼ëª… ë§¤í•‘
const CATEGORY_COLUMNS = ['ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì„¸)', 'ìƒí’ˆëª…', 'ìƒí’ˆID'];
const PAYMENT_METRICS = ['ê²°ì œê¸ˆì•¡', 'ê²°ì œìˆ˜', 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰'];
const REFUND_METRICS = ['í™˜ë¶ˆê¸ˆì•¡', 'í™˜ë¶ˆê±´ìˆ˜', 'í™˜ë¶ˆìˆ˜ëŸ‰'];
const ALL_METRICS = [...PAYMENT_METRICS, ...REFUND_METRICS];
const UNKNOWN_VALUE = '(ì•Œìˆ˜ì—†ìŒ)';
// 3ë‹¨ê³„ ì¹´í…Œê³ ë¦¬ (ì„¸ë¶„ë¥˜ëŠ” ëŒ€ë¶€ë¶„ "-"ì´ë¯€ë¡œ ì œì™¸)
const LEVEL_HIERARCHY = ['ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)', 'ìƒí’ˆ'];
const LEVEL_DISPLAY = {'ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)':'ëŒ€ë¶„ë¥˜', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)':'ì¤‘ë¶„ë¥˜', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)':'ì†Œë¶„ë¥˜', 'ìƒí’ˆ':'ìƒí’ˆ'};

// Convex ì„¤ì •
const CONVEX_URL = 'https://grateful-cheetah-178.convex.cloud';
const CHART_COLORS = [
  '#1E88E5','#43A047','#FB8C00','#E53935','#8E24AA','#00ACC1','#F4511E',
  '#3949AB','#7CB342','#FDD835','#6D4C41','#546E7A',
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let profileData = {};  // { dimension: { df: [...], attrValues: [...], filename, dateRange } }
let currentResult = null;
let currentMetric = 'ê²°ì œê¸ˆì•¡';
let currentChartType = 'bar-h';
let mainChartInstance = null;
let searchTerm = '';
let availableMonths = [];  // Convexì—ì„œ ë¡œë“œëœ ê¸°ê°„ ëª©ë¡

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// File Upload
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');

uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

function handleFiles(files) {
  for (const file of files) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { defval: 0 });
        if (json.length === 0) { alert(`ë¹ˆ íŒŒì¼ì…ë‹ˆë‹¤: ${file.name}`); return; }
        processFile(file.name, json);
      } catch (err) {
        alert(`íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ${file.name}\n${err.message}`);
      }
    };
    reader.readAsArrayBuffer(file);
  }
}

function processFile(filename, rows) {
  // Identify dimension
  let dimension = identifyFileType(filename, rows);
  if (!dimension) {
    alert(`íŒŒì¼ ìœ í˜•ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${filename}`);
    return;
  }

  // Detect attribute column or wide format
  const parsed = parseRows(rows, dimension);
  const dateRange = parseDateRange(filename);

  profileData[dimension] = {
    df: parsed,
    attrValues: DIMENSIONS[dimension],
    filename: filename,
    dateRange: dateRange,
  };

  updateStatus();
  showControls();
  runAnalysis();
}

function identifyFileType(filename, rows) {
  // Check filename
  for (const dim of Object.keys(DIMENSIONS)) {
    if (filename.includes(dim)) return dim;
  }
  // Check column headers
  const cols = rows.length > 0 ? Object.keys(rows[0]) : [];
  const colStr = cols.join(' ');
  for (const [dim, attrs] of Object.entries(DIMENSIONS)) {
    if (colStr.includes(dim)) return dim;
    const matches = attrs.filter(a => colStr.includes(a)).length;
    if (matches >= 2) return dim;
  }
  return null;
}

function parseDateRange(filename) {
  let m = filename.match(/_(\d{8})_(\d{8})/);
  if (m) {
    const s = m[1], e = m[2];
    return { start: `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`, end: `${e.slice(0,4)}-${e.slice(4,6)}-${e.slice(6,8)}` };
  }
  m = filename.match(/_(\d{4}-\d{2}-\d{2})_(\d{4}-\d{2}-\d{2})/);
  if (m) return { start: m[1], end: m[2] };
  return null;
}

function parseRows(rows, dimension) {
  if (rows.length === 0) return [];
  const cols = Object.keys(rows[0]);

  // Check if dimension name or attribute values exist as a column (long format)
  let attrCol = null;
  if (cols.includes(dimension)) {
    attrCol = dimension;
  } else {
    const attrValues = new Set(DIMENSIONS[dimension]);
    for (const col of cols) {
      if (CATEGORY_COLUMNS.includes(col) || ALL_METRICS.includes(col)) continue;
      const vals = new Set(rows.slice(0, 100).map(r => String(r[col]).trim()));
      const overlap = [...vals].filter(v => attrValues.has(v));
      if (overlap.length >= 2) { attrCol = col; break; }
    }
  }

  if (attrCol) {
    // Long format
    return rows.map(r => {
      const rec = { attribute_value: String(r[attrCol]).trim() };
      for (const cc of CATEGORY_COLUMNS) {
        if (r[cc] !== undefined) rec[cc] = r[cc];
      }
      for (const m of ALL_METRICS) {
        rec[m] = safeNum(r[m]);
      }
      return rec;
    });
  }

  // Wide format: attribute values are column prefixes
  const attrValues = DIMENSIONS[dimension];
  const result = [];
  for (const r of rows) {
    const catData = {};
    for (const cc of CATEGORY_COLUMNS) {
      if (r[cc] !== undefined) catData[cc] = r[cc];
    }
    for (const attr of attrValues) {
      const rec = { ...catData, attribute_value: attr };
      for (const m of ALL_METRICS) {
        const colName = findMetricColumn(Object.keys(r), attr, m);
        rec[m] = colName ? safeNum(r[colName]) : 0;
      }
      result.push(rec);
    }
  }
  return result;
}

function findMetricColumn(cols, attrValue, metric) {
  return cols.find(c => c.includes(attrValue) && c.includes(metric)) || null;
}

function safeNum(v) {
  if (v == null || v === '') return 0;
  const n = Number(v);
  return isNaN(n) ? 0 : n;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI Status
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStatus() {
  for (const dim of Object.keys(DIMENSIONS)) {
    const el = document.getElementById(`status-${dim}`);
    if (profileData[dim]) {
      const d = profileData[dim];
      const nRows = d.df.length;
      const dr = d.dateRange;
      el.className = 'status-card loaded';
      el.innerHTML = `
        <div class="dim-name">${dim} â€” ì—…ë¡œë“œ ì™„ë£Œ</div>
        <div class="dim-info">íŒŒì¼: ${d.filename}</div>
        <div class="dim-info">í–‰ ìˆ˜: ${nRows.toLocaleString()}ê°œ</div>
        ${dr ? `<div class="dim-info">ê¸°ê°„: ${dr.start} ~ ${dr.end}</div>` : ''}
      `;
    } else {
      el.className = 'status-card empty';
      el.innerHTML = `<div class="dim-name">${dim}</div><div class="dim-info">ë¯¸ì—…ë¡œë“œ</div>`;
    }
  }
  document.getElementById('resetBtn').classList.toggle('hidden', Object.keys(profileData).length === 0);
}

function resetData() {
  if (!confirm('ì—…ë¡œë“œëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  profileData = {};
  currentResult = null;
  updateStatus();
  document.getElementById('controlsCard').classList.add('hidden');
  document.getElementById('resultsCard').classList.add('hidden');
  fileInput.value = '';
}

function showControls() {
  const dims = Object.keys(profileData);
  if (dims.length === 0) return;

  document.getElementById('controlsCard').classList.remove('hidden');
  const sel = document.getElementById('selDimension');
  sel.innerHTML = dims.map(d => `<option value="${d}">${d}</option>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Analysis
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectMetric(el, metric) {
  currentMetric = metric;
  document.querySelectorAll('#metricGroup label').forEach(l => l.classList.remove('active'));
  el.classList.add('active');
  runAnalysis();
}

function runAnalysis() {
  const dimension = document.getElementById('selDimension').value;
  const level = document.getElementById('selLevel').value;
  const excludeUnknown = document.getElementById('chkExcludeUnknown').checked;

  if (!profileData[dimension]) return;

  const df = profileData[dimension].df;
  const result = computePercentageDistribution(df, level, currentMetric, excludeUnknown);

  let attrValues = DIMENSIONS[dimension].slice();
  if (excludeUnknown) attrValues = attrValues.filter(a => a !== UNKNOWN_VALUE);

  currentResult = { dimension, level, metric: currentMetric, excludeUnknown, data: result, attrValues };

  document.getElementById('resultsCard').classList.remove('hidden');
  renderMetrics();
  renderCurrentTab();
}

function computePercentageDistribution(df, aggLevel, metric, excludeUnknown) {
  let data = df;
  if (excludeUnknown) data = data.filter(r => r.attribute_value !== UNKNOWN_VALUE);

  const groupCol = aggLevel === 'ìƒí’ˆ' ? 'ìƒí’ˆëª…' : aggLevel;
  const displayLevel = LEVEL_DISPLAY[aggLevel] || aggLevel;

  // Group by category + attribute_value â†’ sum metric
  const map = {};
  for (const r of data) {
    const cat = r[groupCol] || '';
    if (!cat) continue;
    if (!map[cat]) map[cat] = {};
    const attr = r.attribute_value;
    map[cat][attr] = (map[cat][attr] || 0) + safeNum(r[metric]);
  }

  // Build result rows
  const rows = [];
  for (const [cat, attrs] of Object.entries(map)) {
    const total = Object.values(attrs).reduce((s, v) => s + v, 0);
    const row = { category: cat, 'í•©ê³„': total };
    for (const [attr, val] of Object.entries(attrs)) {
      row[attr] = total > 0 ? Math.round(val / total * 1000) / 10 : 0;
      row[`${attr}_abs`] = val;
    }
    rows.push(row);
  }

  rows.sort((a, b) => b['í•©ê³„'] - a['í•©ê³„']);
  return rows;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tabs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`#tab-${tabId}`).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(b => {
    if (b.textContent.includes(tabId === 'table' ? 'í…Œì´ë¸”' : tabId === 'chart' ? 'ì°¨íŠ¸' : 'í†µí•©'))
      b.classList.add('active');
  });
  renderCurrentTab();
}

function renderCurrentTab() {
  if (!currentResult) return;
  const active = document.querySelector('.tab-content.active');
  if (active.id === 'tab-table') renderTable();
  else if (active.id === 'tab-chart') renderChart();
  else if (active.id === 'tab-integrated') renderIntegrated();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Metrics Row
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMetrics() {
  if (!currentResult) return;
  const r = currentResult;
  const periodInfo = r.fromConvex && r.sessionIds
    ? (r.sessionIds.length > 1 ? `ëˆ„ì  (${r.sessionIds.length}ê°œì›”)` : 'ë‹¨ì¼ ê¸°ê°„')
    : 'ë¡œì»¬ ë°ì´í„°';
  document.getElementById('metricsRow').innerHTML = `
    <div class="metric-card"><div class="label">ì¹´í…Œê³ ë¦¬ ìˆ˜</div><div class="value">${r.data.length}ê°œ</div></div>
    <div class="metric-card"><div class="label">ë¶„ì„ ì°¨ì›</div><div class="value">${r.dimension}</div></div>
    <div class="metric-card"><div class="label">ì§‘ê³„ ìˆ˜ì¤€</div><div class="value">${LEVEL_DISPLAY[r.level] || r.level}</div></div>
    <div class="metric-card"><div class="label">ê¸°ê°„/ì§€í‘œ</div><div class="value">${periodInfo} Â· ${r.metric}</div></div>
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Table Rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterAndRender() {
  searchTerm = (document.getElementById('searchInput').value || '').trim().toLowerCase();
  renderTable();
}

function getFilteredData() {
  if (!currentResult) return [];
  if (!searchTerm) return currentResult.data;
  return currentResult.data.filter(row =>
    (row.category || '').toLowerCase().includes(searchTerm)
  );
}

function renderTable() {
  if (!currentResult) return;
  const { attrValues, level } = currentResult;
  const data = getFilteredData();
  const showAbs = document.getElementById('chkShowAbsolute').checked;

  const totalCount = currentResult.data.length;
  const filteredCount = data.length;
  const filterInfo = searchTerm ? ` <span style="font-size:12px; color:var(--gray-500);">(${filteredCount}/${totalCount}ê±´ í‘œì‹œ)</span>` : '';

  let html = filterInfo + '<table><thead><tr><th>ì¹´í…Œê³ ë¦¬</th>';
  for (const a of attrValues) html += `<th>${a}</th>`;
  html += '<th>í•©ê³„</th></tr></thead><tbody>';

  for (const row of data) {
    // Find max percentage value in this row
    let maxPct = -1;
    let maxAttr = '';
    for (const a of attrValues) {
      const pct = row[a] || 0;
      if (pct > maxPct) { maxPct = pct; maxAttr = a; }
    }

    html += `<tr><td>${row.category}</td>`;
    for (const a of attrValues) {
      const pct = row[a] || 0;
      const abs = row[`${a}_abs`] || 0;
      const isMax = a === maxAttr && maxPct > 0 ? ' class="max-val"' : '';
      const display = showAbs ? `${pct.toFixed(1)}% (${abs.toLocaleString()})` : `${pct.toFixed(1)}%`;
      html += `<td${isMax}>${display}</td>`;
    }
    html += `<td style="font-weight:600;">${(row['í•©ê³„'] || 0).toLocaleString()}</td></tr>`;
  }
  html += '</tbody></table>';

  document.getElementById('mainTable').innerHTML = html;
  renderDrilldown();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Drilldown
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDrilldown() {
  const { data, level } = currentResult;
  const idx = LEVEL_HIERARCHY.indexOf(level);
  const container = document.getElementById('drilldownControls');
  const resultDiv = document.getElementById('drilldownResult');
  resultDiv.innerHTML = '';

  if (idx >= LEVEL_HIERARCHY.length - 1) {
    container.innerHTML = '<div class="info-box">ìµœí•˜ìœ„ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ë” ì´ìƒ ë“œë¦´ë‹¤ìš´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const childLevel = LEVEL_HIERARCHY[idx + 1];
  const categories = data.map(r => r.category);
  const displayLevel = LEVEL_DISPLAY[level] || level;
  const displayChild = LEVEL_DISPLAY[childLevel] || childLevel;

  container.innerHTML = `
    <div class="control-group">
      <label>ë“œë¦´ë‹¤ìš´: ${displayLevel} â†’ ${displayChild}</label>
      <select id="selDrillCategory" onchange="executeDrilldown()">
        ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
      </select>
    </div>
    <button class="btn btn-primary" onclick="executeDrilldown()">ë¶„ì„</button>
  `;
}

function executeDrilldown() {
  const { dimension, level, metric, excludeUnknown, attrValues } = currentResult;
  const parentValue = document.getElementById('selDrillCategory').value;
  const idx = LEVEL_HIERARCHY.indexOf(level);
  const childLevel = LEVEL_HIERARCHY[idx + 1];

  // Convex ëª¨ë“œë©´ ì„œë²„ì—ì„œ ë“œë¦´ë‹¤ìš´
  if (currentResult.fromConvex && currentResult.sessionIds) {
    const levelMap = { 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)': 'L1', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)': 'L2', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)': 'L3', 'ìƒí’ˆ': 'product' };
    const metricMap = { 'ê²°ì œê¸ˆì•¡': 'paymentAmount', 'ê²°ì œìˆ˜': 'paymentCount', 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰': 'paymentQuantity' };
    convexCall('query', 'queryData:getDrilldown', {
      sessionIds: currentResult.sessionIds,
      dimension,
      parentLevel: levelMap[level] || 'L2',
      parentValue,
      metric: metricMap[metric] || 'paymentAmount',
      excludeUnknown,
    }).then(result => {
      const drillData = result.map(r => {
        const row = { category: r.category, 'í•©ê³„': r.total };
        for (const d of r.distribution) { row[d.attributeValue] = d.percentage; row[`${d.attributeValue}_abs`] = d.absoluteValue; }
        return row;
      });
      renderDrilldownTable(drillData, attrValues, level, childLevel, parentValue);
    }).catch(err => {
      document.getElementById('drilldownResult').innerHTML = `<div class="info-box">ë“œë¦´ë‹¤ìš´ ì‹¤íŒ¨: ${err.message}</div>`;
    });
    return;
  }

  const parentCol = level === 'ìƒí’ˆ' ? 'ìƒí’ˆëª…' : level;
  const df = profileData[dimension].df;
  const filtered = df.filter(r => r[parentCol] === parentValue);
  const drillData = computePercentageDistribution(filtered, childLevel, metric, excludeUnknown);

  renderDrilldownTable(drillData, attrValues, level, childLevel, parentValue);
}

function renderDrilldownTable(drillData, attrValues, level, childLevel, parentValue) {
  const showAbs = document.getElementById('chkShowAbsolute').checked;
  const resultDiv = document.getElementById('drilldownResult');

  if (drillData.length === 0) {
    resultDiv.innerHTML = '<div class="info-box">í•˜ìœ„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const displayLevel = LEVEL_DISPLAY[level] || level;
  const displayChild = LEVEL_DISPLAY[childLevel] || childLevel;
  let html = `<div class="breadcrumb">${displayLevel}: <span>${parentValue}</span> â†’ ${displayChild} í•˜ìœ„ ë¶„ì„</div>`;
  html += '<div class="table-wrapper"><table><thead><tr><th>ì¹´í…Œê³ ë¦¬</th>';
  for (const a of attrValues) html += `<th>${a}</th>`;
  html += '<th>í•©ê³„</th></tr></thead><tbody>';

  for (const row of drillData) {
    let maxPct = -1, maxAttr = '';
    for (const a of attrValues) { if ((row[a]||0) > maxPct) { maxPct = row[a]||0; maxAttr = a; } }

    html += `<tr><td>${row.category}</td>`;
    for (const a of attrValues) {
      const pct = row[a] || 0;
      const abs = row[`${a}_abs`] || 0;
      const isMax = a === maxAttr && maxPct > 0 ? ' class="max-val"' : '';
      const display = showAbs ? `${pct.toFixed(1)}% (${abs.toLocaleString()})` : `${pct.toFixed(1)}%`;
      html += `<td${isMax}>${display}</td>`;
    }
    html += `<td style="font-weight:600;">${(row['í•©ê³„']||0).toLocaleString()}</td></tr>`;
  }
  html += '</tbody></table></div>';
  resultDiv.innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Chart Rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectChartType(type) {
  currentChartType = type;
  document.querySelectorAll('#chartTypeGroup .btn').forEach(b => {
    b.className = 'btn ' + (b.textContent.includes(
      type === 'bar-h' ? 'ê°€ë¡œ' : type === 'bar-v' ? 'ì„¸ë¡œ' : 'íŒŒì´'
    ) ? 'btn-primary' : 'btn-secondary');
  });
  document.getElementById('pieSelector').classList.toggle('hidden', type !== 'pie');
  renderChart();
}

function renderChart() {
  if (!currentResult) return;
  if (currentChartType === 'pie') {
    populatePieSelector();
    renderPieChart();
  } else {
    document.getElementById('pieSelector').classList.add('hidden');
    renderBarChart();
  }
}

function renderBarChart() {
  const { attrValues, dimension, level, metric } = currentResult;
  const data = getFilteredData();
  if (mainChartInstance) mainChartInstance.destroy();

  const isHorizontal = currentChartType === 'bar-h';
  const labels = data.map(r => r.category);

  const datasets = attrValues.map((attr, i) => ({
    label: attr,
    data: data.map(r => r[attr] || 0),
    backgroundColor: CHART_COLORS[i % CHART_COLORS.length],
  }));

  const canvas = document.getElementById('mainChart');
  canvas.style.height = isHorizontal ? Math.max(400, data.length * 40) + 'px' : '500px';

  mainChartInstance = new Chart(canvas, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      indexAxis: isHorizontal ? 'y' : 'x',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: `${dimension} / ${LEVEL_DISPLAY[level] || level} / ${metric} ë¶„í¬`, font: { size: 16 } },
        legend: { position: 'top' },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw.toFixed(1)}%` } },
      },
      scales: {
        x: { stacked: true, ...(isHorizontal ? { max: 100, title: { display: true, text: 'ë¹„ìœ¨ (%)' } } : {}) },
        y: { stacked: true, ...(!isHorizontal ? { max: 100, title: { display: true, text: 'ë¹„ìœ¨ (%)' } } : {}) },
      },
    },
  });
}

function populatePieSelector() {
  if (!currentResult) return;
  const data = getFilteredData();
  const sel = document.getElementById('selPieCategory');
  sel.innerHTML = data.map(r => `<option value="${r.category}">${r.category}</option>`).join('');
}

function renderPieChart() {
  if (!currentResult) return;
  const category = document.getElementById('selPieCategory').value;
  const row = currentResult.data.find(r => r.category === category);
  if (!row) return;

  if (mainChartInstance) mainChartInstance.destroy();

  const labels = currentResult.attrValues;
  const values = labels.map(a => row[a] || 0);

  const canvas = document.getElementById('mainChart');
  canvas.style.height = '500px';

  mainChartInstance = new Chart(canvas, {
    type: 'pie',
    data: {
      labels,
      datasets: [{ data: values, backgroundColor: CHART_COLORS.slice(0, labels.length) }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: `${category} ê³ ê° í”„ë¡œíŒŒì¼`, font: { size: 16 } },
        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } },
      },
    },
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Integrated View
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderIntegrated() {
  const container = document.getElementById('integratedContent');
  const level = document.getElementById('selLevel').value;
  const excludeUnknown = document.getElementById('chkExcludeUnknown').checked;

  // Convex ëª¨ë“œ: í˜„ì¬ ë¶„ì„ ê²°ê³¼ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì‚¬ìš©
  if (currentResult && currentResult.fromConvex && currentResult.sessionIds) {
    const categories = currentResult.data.map(r => r.category);
    if (categories.length === 0) {
      container.innerHTML = '<div class="info-box">ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    container.innerHTML = `
      <div class="control-group" style="max-width:300px; margin-bottom:20px;">
        <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
        <select id="selIntCategory" onchange="renderIntegratedDetail()">
          ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div id="integratedDetail"></div>
    `;
    renderIntegratedDetail();
    return;
  }

  const dims = Object.keys(profileData);

  if (dims.length < 2) {
    container.innerHTML = '<div class="info-box">í†µí•© ë¶„ì„ì„ ìœ„í•´ 2ê°œ ì´ìƒì˜ í”„ë¡œíŒŒì¼ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>';
    return;
  }

  const groupCol = level === 'ìƒí’ˆ' ? 'ìƒí’ˆëª…' : level;

  // Get categories from first dimension
  const firstDf = profileData[dims[0]].df;
  const categories = [...new Set(firstDf.map(r => r[groupCol]).filter(Boolean))].sort();

  if (categories.length === 0) {
    container.innerHTML = '<div class="info-box">í•´ë‹¹ ì§‘ê³„ ìˆ˜ì¤€ì— ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  let html = `
    <div class="control-group" style="max-width:300px; margin-bottom:20px;">
      <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
      <select id="selIntCategory" onchange="renderIntegratedDetail()">
        ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
      </select>
    </div>
    <div id="integratedDetail"></div>
  `;
  container.innerHTML = html;
  renderIntegratedDetail();
}

function renderIntegratedDetail() {
  const category = document.getElementById('selIntCategory').value;
  const level = document.getElementById('selLevel').value;
  const excludeUnknown = document.getElementById('chkExcludeUnknown').checked;
  const container = document.getElementById('integratedDetail');

  // Convex ëª¨ë“œ
  if (currentResult && currentResult.fromConvex && currentResult.sessionIds) {
    const levelMap = { 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)': 'L1', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)': 'L2', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)': 'L3', 'ìƒí’ˆ': 'product' };
    const metricMap = { 'ê²°ì œê¸ˆì•¡': 'paymentAmount', 'ê²°ì œìˆ˜': 'paymentCount', 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰': 'paymentQuantity' };
    container.innerHTML = '<div class="info-box">í†µí•© ë¶„ì„ ë¡œë”© ì¤‘...</div>';
    convexCall('query', 'queryData:getIntegratedView', {
      sessionIds: currentResult.sessionIds,
      aggregationLevel: levelMap[level] || 'L2',
      category,
      metric: metricMap[currentMetric] || 'paymentAmount',
      excludeUnknown,
    }).then(results => {
      let html = '<div class="integrated-grid">';
      for (const dimResult of results) {
        html += `<div class="integrated-card"><h4>${dimResult.dimension}</h4>`;
        if (dimResult.distribution.length === 0) {
          html += '<div class="info-box">ë°ì´í„° ì—†ìŒ</div>';
        } else {
          for (let bi = 0; bi < dimResult.distribution.length; bi++) {
            const d = dimResult.distribution[bi];
            html += `
              <div class="attr-bar">
                <div class="name">${d.attributeValue}</div>
                <div class="bar-bg"><div class="bar-fill" style="width:${d.percentage}%; background:${CHART_COLORS[bi % CHART_COLORS.length]}"></div></div>
                <div class="pct">${d.percentage.toFixed(1)}%</div>
              </div>`;
          }
          html += `<div style="text-align:right; font-size:12px; color:#999; margin-top:8px;">í•©ê³„: ${dimResult.total.toLocaleString()}</div>`;
        }
        html += '</div>';
      }
      html += '</div>';
      container.innerHTML = html;
    }).catch(err => {
      container.innerHTML = `<div class="info-box">í†µí•© ë¶„ì„ ì‹¤íŒ¨: ${err.message}</div>`;
    });
    return;
  }

  const groupCol = level === 'ìƒí’ˆ' ? 'ìƒí’ˆëª…' : level;

  let html = '<div class="integrated-grid">';

  for (const [dim, data] of Object.entries(profileData)) {
    const filtered = data.df.filter(r => r[groupCol] === category);
    let work = filtered;
    if (excludeUnknown) work = work.filter(r => r.attribute_value !== UNKNOWN_VALUE);

    // Sum by attribute_value
    const sums = {};
    for (const r of work) {
      const attr = r.attribute_value;
      sums[attr] = (sums[attr] || 0) + safeNum(r[currentMetric]);
    }
    const total = Object.values(sums).reduce((s, v) => s + v, 0);

    // Sort by value descending
    const sorted = Object.entries(sums).sort((a, b) => b[1] - a[1]);

    html += `<div class="integrated-card"><h4>${dim}</h4>`;
    if (sorted.length === 0) {
      html += '<div class="info-box">ë°ì´í„° ì—†ìŒ</div>';
    } else {
      for (const [attr, val] of sorted) {
        const pct = total > 0 ? (val / total * 100) : 0;
        html += `
          <div class="attr-bar">
            <div class="name">${attr}</div>
            <div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${CHART_COLORS[sorted.indexOf([attr,val]) % CHART_COLORS.length]}"></div></div>
            <div class="pct">${pct.toFixed(1)}%</div>
          </div>
        `;
      }
      html += `<div style="text-align:right; font-size:12px; color:#999; margin-top:8px;">í•©ê³„: ${total.toLocaleString()}</div>`;
    }
    html += '</div>';
  }

  html += '</div>';
  container.innerHTML = html;

  // Fix bar colors (the indexOf trick won't work with array comparison)
  setTimeout(() => {
    document.querySelectorAll('.integrated-card').forEach((card, ci) => {
      card.querySelectorAll('.bar-fill').forEach((bar, bi) => {
        bar.style.background = CHART_COLORS[bi % CHART_COLORS.length];
      });
    });
  }, 0);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Excel Export
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportExcel() {
  if (!currentResult) return;
  const { data, attrValues, dimension, level, metric } = currentResult;
  const displayLevel = LEVEL_DISPLAY[level] || level;

  const rows = data.map(row => {
    const r = { 'ì¹´í…Œê³ ë¦¬': row.category };
    for (const attr of attrValues) {
      r[attr] = (row[attr] || 0) / 100;  // decimal for percentage format
    }
    r['í•©ê³„'] = row['í•©ê³„'] || 0;
    return r;
  });

  const ws = XLSX.utils.json_to_sheet(rows);

  // Set percentage format for attribute columns
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let R = range.s.r + 1; R <= range.e.r; R++) {
    for (let C = 1; C <= attrValues.length; C++) {
      const cell = ws[XLSX.utils.encode_cell({ r: R, c: C })];
      if (cell) cell.z = '0.0%';
    }
    // Number format for total
    const totalCell = ws[XLSX.utils.encode_cell({ r: R, c: attrValues.length + 1 })];
    if (totalCell) totalCell.z = '#,##0';
  }

  // Column widths
  ws['!cols'] = [{ wch: 25 }, ...attrValues.map(() => ({ wch: 14 })), { wch: 15 }];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, `${dimension}_${displayLevel}`);
  XLSX.writeFile(wb, `ê³ ê°í”„ë¡œíŒŒì¼_${dimension}_${displayLevel}_${metric}.xlsx`);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Convex DB Integration
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function convexCall(type, path, args) {
  const url = `${CONVEX_URL}/api/${type}`;
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path, args, format: 'json' }),
  });
  const json = await res.json();
  if (json.status === 'error') throw new Error(json.errorMessage || 'Convex error');
  return json.value;
}

function setProgress(pct, text) {
  document.getElementById('convexProgress').classList.remove('hidden');
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressText').textContent = text;
}

function hideProgress() {
  document.getElementById('convexProgress').classList.add('hidden');
}

function setConvexStatus(text, isError) {
  const el = document.getElementById('convexStatus');
  el.textContent = text;
  el.style.color = isError ? 'var(--danger)' : 'var(--success)';
}

// ê¸°ê°„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function refreshPeriods() {
  try {
    const months = await convexCall('query', 'queryData:getAvailableMonths', {});
    availableMonths = months;
    const sel = document.getElementById('selPeriod');
    sel.innerHTML = '<option value="">-- ê¸°ê°„ ì„ íƒ --</option><option value="__ALL__">ì „ì²´ ëˆ„ì </option>';
    for (const m of months) {
      const date = new Date(m.uploadedAt).toLocaleDateString('ko-KR');
      sel.innerHTML += `<option value="${m.sessionId}">${m.periodStart} ~ ${m.periodEnd} (${m.fileCount}ê°œ íŒŒì¼) - ${date}</option>`;
    }
    setConvexStatus(months.length > 0 ? `${months.length}ê°œ ê¸°ê°„ ë¡œë“œë¨` : 'DBì— ì €ì¥ëœ ë°ì´í„° ì—†ìŒ', false);
  } catch (err) {
    setConvexStatus('ê¸°ê°„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + err.message, true);
  }
}

// í˜„ì¬ ë°ì´í„°ë¥¼ Convexì— ì €ì¥
async function saveToConvex() {
  const dims = Object.keys(profileData);
  if (dims.length === 0) { alert('ì—…ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  if (!confirm(`${dims.length}ê°œ ì°¨ì› ë°ì´í„°ë¥¼ Convex DBì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  try {
    setProgress(5, 'ì„¸ì…˜ ìƒì„± ì¤‘...');
    let periodStart = '2025-01-01', periodEnd = '2025-12-31';
    for (const d of Object.values(profileData)) {
      if (d.dateRange) { periodStart = d.dateRange.start; periodEnd = d.dateRange.end; break; }
    }

    const newSessionId = await convexCall('mutation', 'uploadData:createSession', { periodStart, periodEnd });

    setProgress(10, 'ì¹´í…Œê³ ë¦¬ ë° ìƒí’ˆ ë“±ë¡ ì¤‘...');
    const categoryCache = {};
    const productCache = {};
    const firstDf = profileData[dims[0]].df;

    const uniqueCats = {};
    const uniqueProducts = {};
    for (const row of firstDf) {
      const l1 = row['ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)'] || '', l2 = row['ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)'] || '', l3 = row['ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)'] || '';
      const key = `${l1}|${l2}|${l3}`;
      if (!uniqueCats[key]) uniqueCats[key] = { categoryL1: l1, categoryL2: l2, categoryL3: l3 };
      const pid = row['ìƒí’ˆID'], pname = row['ìƒí’ˆëª…'] || '';
      if (pid && !uniqueProducts[pid]) uniqueProducts[pid] = { productId: Number(pid), productName: pname, catKey: key };
    }

    const catKeys = Object.keys(uniqueCats);
    for (let i = 0; i < catKeys.length; i++) {
      categoryCache[catKeys[i]] = await convexCall('mutation', 'uploadData:upsertCategory', uniqueCats[catKeys[i]]);
      setProgress(10 + Math.round(i / catKeys.length * 15), `ì¹´í…Œê³ ë¦¬ ë“±ë¡ ì¤‘... (${i + 1}/${catKeys.length})`);
    }

    const prodKeys = Object.keys(uniqueProducts);
    for (let i = 0; i < prodKeys.length; i++) {
      const p = uniqueProducts[prodKeys[i]];
      const catId = categoryCache[p.catKey];
      if (!catId) continue;
      productCache[prodKeys[i]] = await convexCall('mutation', 'uploadData:upsertProduct', {
        productId: p.productId, productName: p.productName, categoryId: catId,
      });
      if (i % 50 === 0) setProgress(25 + Math.round(i / prodKeys.length * 20), `ìƒí’ˆ ë“±ë¡ ì¤‘... (${i + 1}/${prodKeys.length})`);
    }

    let dimIdx = 0;
    for (const [dim, data] of Object.entries(profileData)) {
      const base = 45 + dimIdx * 15;
      setProgress(base, `${dim} ë°ì´í„° ì—…ë¡œë“œ ì¤‘...`);
      const records = [];
      for (const row of data.df) {
        const prodConvexId = productCache[row['ìƒí’ˆID']];
        if (!prodConvexId) continue;
        records.push({
          sessionId: newSessionId, productId: prodConvexId, dimension: dim,
          attributeValue: row.attribute_value || '',
          paymentAmount: safeNum(row['ê²°ì œê¸ˆì•¡']), paymentCount: safeNum(row['ê²°ì œìˆ˜']),
          paymentQuantity: safeNum(row['ê²°ì œìƒí’ˆìˆ˜ëŸ‰']), refundAmount: safeNum(row['í™˜ë¶ˆê¸ˆì•¡']),
          refundCount: safeNum(row['í™˜ë¶ˆê±´ìˆ˜']), refundQuantity: safeNum(row['í™˜ë¶ˆìˆ˜ëŸ‰']),
        });
      }
      const BATCH = 100;
      for (let i = 0; i < records.length; i += BATCH) {
        await convexCall('mutation', 'uploadData:insertProfileRecords', { records: records.slice(i, i + BATCH) });
        setProgress(base + Math.round((i / records.length) * 15), `${dim} ì—…ë¡œë“œ ì¤‘... (${Math.min(i + BATCH, records.length)}/${records.length})`);
      }
      await convexCall('mutation', 'uploadData:updateSessionFile', {
        sessionId: newSessionId, dimension: dim, filename: data.filename, rowCount: data.df.length,
      });
      dimIdx++;
    }

    setProgress(100, 'ì €ì¥ ì™„ë£Œ!');
    setConvexStatus('DB ì €ì¥ ì™„ë£Œ!', false);
    await refreshPeriods();
    setTimeout(hideProgress, 3000);
  } catch (err) {
    setConvexStatus('ì €ì¥ ì‹¤íŒ¨: ' + err.message, true);
    console.error('Convex save error:', err);
    hideProgress();
  }
}

// Convexì—ì„œ ê¸°ê°„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì „ì²´ ëˆ„ì  ë˜ëŠ” ì›”ë³„)
async function loadPeriodData() {
  const sel = document.getElementById('selPeriod').value;
  if (!sel) return;

  try {
    setProgress(10, 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

    // ì„¸ì…˜ ID ë°°ì—´ ê²°ì •
    let sessionIds = [];
    let periodLabel = '';

    if (sel === '__ALL__') {
      // ì „ì²´ ëˆ„ì : ëª¨ë“  ì„¸ì…˜ ID
      sessionIds = availableMonths.map(m => m.sessionId);
      periodLabel = 'ì „ì²´ ëˆ„ì ';
    } else {
      // íŠ¹ì • ê¸°ê°„
      sessionIds = [sel];
      const month = availableMonths.find(m => m.sessionId === sel);
      periodLabel = month ? `${month.periodStart} ~ ${month.periodEnd}` : 'ì„ íƒ ê¸°ê°„';
    }

    if (sessionIds.length === 0) {
      setConvexStatus('ì €ì¥ëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.', true);
      hideProgress();
      return;
    }

    // ì°¨ì› ëª©ë¡ ê²°ì • (ëª¨ë“  ì„¸ì…˜ì—ì„œ ê³µí†µ)
    const allDims = new Set();
    for (const m of availableMonths) {
      if (sessionIds.includes(m.sessionId)) {
        for (const d of m.dimensions) allDims.add(d);
      }
    }
    const dims = [...allDims];
    if (dims.length === 0) {
      setConvexStatus('ì„¸ì…˜ì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.', true);
      hideProgress();
      return;
    }

    setProgress(50, 'ë¶„ì„ ê²°ê³¼ ê³„ì‚° ì¤‘...');

    const defaultDim = dims[0];
    const result = await convexCall('query', 'queryData:getPercentageDistribution', {
      sessionIds,
      dimension: defaultDim,
      aggregationLevel: 'L2',
      metric: 'paymentAmount',
      excludeUnknown: true,
    });

    let attrValues = DIMENSIONS[defaultDim].filter(a => a !== UNKNOWN_VALUE);
    const localData = result.map(r => {
      const row = { category: r.category, 'í•©ê³„': r.total };
      for (const d of r.distribution) {
        row[d.attributeValue] = d.percentage;
        row[`${d.attributeValue}_abs`] = d.absoluteValue;
      }
      return row;
    });

    currentResult = {
      dimension: defaultDim, level: 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)', metric: 'ê²°ì œê¸ˆì•¡',
      excludeUnknown: true, data: localData, attrValues,
      fromConvex: true, sessionIds,
    };

    // UI ì—…ë°ì´íŠ¸
    document.getElementById('controlsCard').classList.remove('hidden');
    document.getElementById('selDimension').innerHTML = dims.map(d => `<option value="${d}">${d}</option>`).join('');

    // ìƒíƒœ ì¹´ë“œ ì—…ë°ì´íŠ¸
    for (const dim of dims) {
      const el = document.getElementById(`status-${dim}`);
      el.className = 'status-card loaded';
      el.innerHTML = `
        <div class="dim-name">${dim} â€” DB (${periodLabel})</div>
        <div class="dim-info">${sessionIds.length}ê°œ ì„¸ì…˜ í†µí•©</div>
      `;
    }

    document.getElementById('resultsCard').classList.remove('hidden');
    searchTerm = '';
    document.getElementById('searchInput').value = '';
    renderMetrics();
    renderCurrentTab();

    setProgress(100, 'ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
    setConvexStatus(`${periodLabel} ë¡œë“œ ì™„ë£Œ (${dims.join(', ')})`, false);
    setTimeout(hideProgress, 2000);
  } catch (err) {
    setConvexStatus('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + err.message, true);
    console.error('Convex load error:', err);
    hideProgress();
  }
}

// runAnalysisë¥¼ Convex ëª¨ë“œì—ì„œë„ ë™ì‘í•˜ë„ë¡ í™•ì¥
const _originalRunAnalysis = runAnalysis;
runAnalysis = function() {
  if (currentResult && currentResult.fromConvex && currentResult.sessionIds) {
    const dimension = document.getElementById('selDimension').value;
    const level = document.getElementById('selLevel').value;
    const excludeUnknown = document.getElementById('chkExcludeUnknown').checked;
    const levelMap = { 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)': 'L1', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)': 'L2', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)': 'L3', 'ìƒí’ˆ': 'product' };
    const metricMap = { 'ê²°ì œê¸ˆì•¡': 'paymentAmount', 'ê²°ì œìˆ˜': 'paymentCount', 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰': 'paymentQuantity' };

    convexCall('query', 'queryData:getPercentageDistribution', {
      sessionIds: currentResult.sessionIds, dimension,
      aggregationLevel: levelMap[level] || 'L2',
      metric: metricMap[currentMetric] || 'paymentAmount',
      excludeUnknown,
    }).then(result => {
      let attrValues = DIMENSIONS[dimension].slice();
      if (excludeUnknown) attrValues = attrValues.filter(a => a !== UNKNOWN_VALUE);
      const localData = result.map(r => {
        const row = { category: r.category, 'í•©ê³„': r.total };
        for (const d of r.distribution) { row[d.attributeValue] = d.percentage; row[`${d.attributeValue}_abs`] = d.absoluteValue; }
        return row;
      });
      currentResult = {
        dimension, level, metric: currentMetric, excludeUnknown,
        data: localData, attrValues,
        fromConvex: true, sessionIds: currentResult.sessionIds,
      };
      document.getElementById('resultsCard').classList.remove('hidden');
      renderMetrics();
      renderCurrentTab();
    }).catch(err => {
      setConvexStatus('ë¶„ì„ ì‹¤íŒ¨: ' + err.message, true);
    });
    return;
  }
  _originalRunAnalysis();
};

// ì—…ë¡œë“œ í›„ DB ì €ì¥ ë²„íŠ¼ í‘œì‹œ ë¡œì§ í™•ì¥
const _originalUpdateStatus = updateStatus;
updateStatus = function() {
  _originalUpdateStatus();
  document.getElementById('btnSaveConvex').classList.toggle('hidden', Object.keys(profileData).length === 0);
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ê°„ ëª©ë¡ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
refreshPeriods();
</script>
</body>
</html>
