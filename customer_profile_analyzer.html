<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë°ìŠ¤ì»¤ êµ¬ë§¤ ê³ ê° ë¶„ì„</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<style>
:root {
  --primary: #1E88E5;
  --primary-light: #E3F2FD;
  --primary-dark: #1565C0;
  --success: #43A047;
  --success-light: #E8F5E9;
  --warning: #FB8C00;
  --warning-light: #FFF3E0;
  --danger: #E53935;
  --gray-50: #FAFAFA;
  --gray-100: #F5F5F5;
  --gray-200: #EEEEEE;
  --gray-300: #E0E0E0;
  --gray-500: #9E9E9E;
  --gray-700: #616161;
  --gray-900: #212121;
  --radius: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
  background: var(--gray-50);
  color: var(--gray-900);
  line-height: 1.6;
}
/* Layout: sidebar + content */
.app-layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; min-width: 260px; background: #1a2233; color: #ccc; padding: 0;
  display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
  overflow-y: auto;
}
.sidebar-brand { padding: 20px 20px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-brand h1 { font-size: 17px; color: white; font-weight: 700; }
.sidebar-brand p { font-size: 11px; color: #8899aa; margin-top: 2px; }
.sidebar-section { padding: 12px 0 4px; }
.sidebar-section-title { padding: 0 20px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #667788; margin-bottom: 4px; }
.sidebar-item {
  display: block; padding: 9px 20px 9px 24px; font-size: 13px; color: #aabbcc; cursor: pointer;
  transition: all 0.15s; border-left: 3px solid transparent; text-decoration: none;
}
.sidebar-item:hover { background: rgba(255,255,255,0.05); color: white; }
.sidebar-item.active { background: rgba(30,136,229,0.15); color: #64B5F6; border-left-color: #1E88E5; font-weight: 600; }
.sidebar-item .icon { margin-right: 8px; font-size: 14px; }
.main-content { margin-left: 260px; flex: 1; padding: 24px 32px; max-width: 1200px; }

/* Header bar (inside content) */
.header-bar {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white; padding: 16px 24px; border-radius: var(--radius); margin-bottom: 20px;
  box-shadow: var(--shadow);
}
.header-bar h2 { font-size: 18px; font-weight: 700; }
.header-bar p { font-size: 12px; opacity: 0.8; margin-top: 2px; }

/* Cards */
.card {
  background: white;
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
}
.card h2 {
  font-size: 16px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Upload Area */
.upload-area {
  border: 2px dashed var(--gray-300);
  border-radius: var(--radius);
  padding: 40px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--gray-50);
}
.upload-area:hover, .upload-area.dragover {
  border-color: var(--primary);
  background: var(--primary-light);
}
.upload-area .icon { font-size: 48px; margin-bottom: 12px; }
.upload-area p { color: var(--gray-700); font-size: 14px; }
.upload-area input { display: none; }

/* Status Cards */
.status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; }
.status-card {
  padding: 16px;
  border-radius: var(--radius);
  border: 1px solid var(--gray-200);
}
.status-card.loaded {
  border-color: var(--success);
  background: var(--success-light);
}
.status-card.empty {
  border-color: var(--warning);
  background: var(--warning-light);
}
.status-card .dim-name { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
.status-card .dim-info { font-size: 12px; color: var(--gray-700); }

/* Controls */
.controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
.control-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-700);
  margin-bottom: 6px;
}
.control-group select, .control-group input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
  background: white;
}
.control-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(30,136,229,0.15);
}
.checkbox-group {
  display: flex;
  gap: 20px;
  align-items: center;
  margin-top: 8px;
}
.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  cursor: pointer;
  font-weight: 400;
  color: var(--gray-900);
}

/* Tabs */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--gray-200);
  margin-bottom: 20px;
}
.tab-btn {
  padding: 10px 24px;
  border: none;
  background: none;
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-500);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
  font-family: inherit;
}
.tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}
.tab-btn:hover { color: var(--primary-dark); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Metrics Row */
.metrics-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
.metric-card {
  background: var(--gray-100);
  padding: 12px 16px;
  border-radius: 6px;
  text-align: center;
}
.metric-card .label { font-size: 12px; color: var(--gray-500); }
.metric-card .value { font-size: 20px; font-weight: 700; color: var(--primary); }

/* Table */
.table-wrapper { overflow-x: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
thead th {
  background: var(--primary);
  color: white;
  padding: 10px 12px;
  text-align: center;
  font-weight: 600;
  white-space: nowrap;
  position: sticky;
  top: 0;
}
thead th:first-child { text-align: left; }
tbody td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--gray-200);
  text-align: center;
  white-space: nowrap;
}
tbody td:first-child { text-align: left; font-weight: 500; }
tbody tr:hover { background: var(--primary-light); }
tbody tr:nth-child(even) { background: var(--gray-50); }
tbody tr:nth-child(even):hover { background: var(--primary-light); }

/* Highlight max value in row */
td.max-val { background: #E3F2FD; font-weight: 700; color: var(--primary-dark); }

/* Buttons */
.btn {
  padding: 8px 20px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;
}
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--gray-200); color: var(--gray-700); }
.btn-secondary:hover { background: var(--gray-300); }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #C62828; }
.btn-group { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

/* Chart */
.chart-container { max-width: 900px; margin: 0 auto; }
.chart-controls { display: flex; gap: 8px; margin-bottom: 16px; }
.chart-controls .btn.active { background: var(--primary); color: white; }

/* Integrated View */
.integrated-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
.integrated-card {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  padding: 16px;
}
.integrated-card h4 {
  font-size: 15px;
  color: var(--primary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--primary-light);
}
.attr-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.attr-bar .name { width: 80px; font-size: 13px; font-weight: 500; text-align: right; flex-shrink: 0; }
.attr-bar .bar-bg {
  flex: 1;
  height: 24px;
  background: var(--gray-200);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}
.attr-bar .bar-fill {
  height: 100%;
  background: var(--primary);
  border-radius: 4px;
  transition: width 0.5s ease;
  min-width: 2px;
}
.attr-bar .pct { width: 55px; font-size: 13px; font-weight: 600; text-align: right; flex-shrink: 0; }

/* Drilldown */
.drilldown-controls { display: flex; gap: 12px; align-items: flex-end; margin-bottom: 16px; flex-wrap: wrap; }
.breadcrumb { font-size: 13px; color: var(--gray-500); margin-bottom: 12px; }
.breadcrumb span { color: var(--primary); font-weight: 600; }

/* Hidden */
.hidden { display: none !important; }

/* Info */
.info-box {
  background: var(--primary-light);
  border: 1px solid #BBDEFB;
  border-radius: 6px;
  padding: 16px;
  font-size: 14px;
  color: var(--primary-dark);
  text-align: center;
}

/* Radio buttons styled */
.radio-group { display: flex; gap: 0; }
.radio-group label {
  padding: 6px 16px;
  border: 1px solid var(--gray-300);
  font-size: 13px;
  cursor: pointer;
  background: white;
  transition: all 0.2s;
  font-weight: 400;
  color: var(--gray-700);
}
.radio-group label:first-child { border-radius: 6px 0 0 6px; }
.radio-group label:last-child { border-radius: 0 6px 6px 0; }
.radio-group label:not(:last-child) { border-right: none; }
.radio-group input { display: none; }
.radio-group input:checked + span {
  /* handled via JS by adding .active class to label */
}
.radio-group label.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

/* Selected product chips */
.chip-container { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px; min-height: 20px; }
.chip { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:16px; font-size:12px; background:var(--primary-light); color:var(--primary-dark); font-weight:500; }
.chip-x { cursor:pointer; font-weight:700; font-size:14px; color:var(--gray-500); margin-left:2px; line-height:1; }
.chip-x:hover { color:var(--danger); }

/* Review Cards */
.review-item { border:1px solid var(--gray-200); border-radius:var(--radius); padding:16px; margin-bottom:12px; transition:box-shadow 0.2s; }
.review-item:hover { box-shadow:var(--shadow-md); }
.review-header { display:flex; align-items:center; gap:8px; margin-bottom:6px; flex-wrap:wrap; }
.stars { color:#FFC107; font-size:14px; letter-spacing:1px; }
.badge { display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; }
.badge-month { background:#E8F5E9; color:#2E7D32; }
.badge-best { background:#FFF3E0; color:#E65100; }
.badge-photo { background:#E3F2FD; color:#1565C0; }
.review-product { font-size:12px; color:var(--gray-500); margin-bottom:4px; }
.review-body { font-size:14px; line-height:1.7; margin-bottom:8px; word-break:break-word; }
.review-photos { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
.review-photos img { width:80px; height:80px; object-fit:cover; border-radius:6px; cursor:pointer; border:1px solid var(--gray-200); }
.review-photos img:hover { border-color:var(--primary); }
.review-meta { font-size:12px; color:var(--gray-500); display:flex; gap:16px; flex-wrap:wrap; }

/* Gallery */
.gallery-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:12px; }
.gallery-item { position:relative; border-radius:var(--radius); overflow:hidden; aspect-ratio:1; cursor:pointer; }
.gallery-item img { width:100%; height:100%; object-fit:cover; transition:transform 0.2s; }
.gallery-item:hover img { transform:scale(1.05); }
.gallery-caption { position:absolute; bottom:0; left:0; right:0; padding:6px 8px; background:linear-gradient(transparent, rgba(0,0,0,0.7)); color:white; font-size:11px; }

/* Pagination */
.pagination { display:flex; justify-content:center; gap:4px; margin-top:20px; flex-wrap:wrap; }
.pagination button { min-width:36px; height:36px; border:1px solid var(--gray-300); border-radius:6px; background:white; font-size:13px; cursor:pointer; font-family:inherit; }
.pagination button.active { background:var(--primary); color:white; border-color:var(--primary); }
.pagination button:hover:not(.active) { background:var(--gray-100); }

/* Review Summary */
.review-summary { display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:12px; margin-top:16px; }
.summary-item { text-align:center; padding:12px; background:var(--gray-100); border-radius:6px; }
.summary-item .num { font-size:20px; font-weight:700; color:var(--primary); }
.summary-item .lbl { font-size:11px; color:var(--gray-500); }

/* Product search list */
.product-list { max-height:300px; overflow-y:auto; border:1px solid var(--gray-200); border-radius:6px; margin-top:8px; }
.product-item { padding:10px 12px; cursor:pointer; font-size:13px; border-bottom:1px solid var(--gray-100); display:flex; justify-content:space-between; align-items:center; gap:8px; }
.product-item span:first-child { flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.product-item:hover { background:var(--primary-light); }
.product-item.selected { background:var(--primary-light); font-weight:600; color:var(--primary); }
.product-item .cnt { font-size:12px; color:var(--gray-500); }

/* Image modal */
.img-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:1000; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; cursor:pointer; }
.img-modal.show { display:flex; }
.img-modal img { max-width:90vw; max-height:90vh; border-radius:8px; }

/* Keyword drilldown */
.kw-row { display:flex; align-items:center; gap:8px; margin-bottom:6px; cursor:pointer; border-radius:4px; padding:2px 4px; transition:background 0.15s; }
.kw-row:hover { background:rgba(0,0,0,0.04); }
.kw-row.active { background:rgba(0,0,0,0.07); }
.kw-drilldown { margin-top:20px; border-top:1px solid var(--gray-200); padding-top:16px; }
.kw-drilldown-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
</style>
</head>
<body>
<div class="app-layout">

<!-- ===== Sidebar ===== -->
<nav class="sidebar">
  <div class="sidebar-brand">
    <h1>ë°ìŠ¤ì»¤ êµ¬ë§¤ ê³ ê° ë¶„ì„</h1>
    <p>ê³ ê° íŠ¹ì„± ë° ë¦¬ë·° ë¶„ì„</p>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">êµ¬ë§¤ ê³ ê° íŠ¹ì„± ë¶„ì„</div>
    <a class="sidebar-item active" onclick="navigateTo('p-upload')"><span class="icon">ğŸ“‚</span>ë°ì´í„° ì—…ë¡œë“œ</a>
    <a class="sidebar-item" onclick="navigateTo('p-category')"><span class="icon">ğŸ“Š</span>ì¹´í…Œê³ ë¦¬ë³„ ê²°ê³¼</a>
    <a class="sidebar-item" onclick="navigateTo('p-product')"><span class="icon">ğŸ”</span>ìƒí’ˆë³„ ìƒì„¸</a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">êµ¬ë§¤ ê³ ê° ë¦¬ë·° ë¶„ì„</div>
    <a class="sidebar-item" onclick="navigateTo('r-upload')"><span class="icon">ğŸ“</span>ë°ì´í„° ì—…ë¡œë“œ</a>
    <a class="sidebar-item" onclick="navigateTo('r-reviews')"><span class="icon">ğŸ’¬</span>ë¦¬ë·° ë¦¬ìŠ¤íŠ¸</a>
    <a class="sidebar-item" onclick="navigateTo('r-keywords')"><span class="icon">ğŸ·ï¸</span>í‚¤ì›Œë“œ ë¶„ì„</a>
    <a class="sidebar-item" onclick="navigateTo('r-negative')"><span class="icon">âš ï¸</span>ë¶€ì •ì  ì˜ê²¬</a>
  </div>
</nav>

<!-- ===== Main Content ===== -->
<div class="main-content">

<!-- ========== P-UPLOAD: íŠ¹ì„±ë¶„ì„ ë°ì´í„° ì—…ë¡œë“œ ========== -->
<div class="page" id="page-p-upload">
  <div class="header-bar"><h2>êµ¬ë§¤ ê³ ê° íŠ¹ì„± ë¶„ì„ â€” ë°ì´í„° ì—…ë¡œë“œ</h2></div>

  <div class="card">
    <h2>ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h2>
    <div class="upload-area" id="uploadArea">
      <div class="icon">ğŸ“‚</div>
      <p><b>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸</b>í•˜ì—¬ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
      <p style="font-size:12px; margin-top:8px; color:#999;">íŒŒì¼ëª… íŒ¨í„´: ìƒí’ˆ_ê³ ê°í”„ë¡œíŒŒì¼_{ì†ì„±}_{ì‹œì‘ì¼}_{ì¢…ë£Œì¼}.xlsx (ìµœëŒ€ 3ê°œ)</p>
      <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
    </div>
    <div class="status-grid" id="statusGrid">
      <div class="status-card empty" id="status-ìë…€ë‚˜ì´"><div class="dim-name">ìë…€ë‚˜ì´</div><div class="dim-info">ë¯¸ì—…ë¡œë“œ</div></div>
      <div class="status-card empty" id="status-ê²°í˜¼ìƒíƒœ"><div class="dim-name">ê²°í˜¼ìƒíƒœ</div><div class="dim-info">ë¯¸ì—…ë¡œë“œ</div></div>
      <div class="status-card empty" id="status-ê°€êµ¬ë‹¹ì¸ì›"><div class="dim-name">ê°€êµ¬ë‹¹ì¸ì›</div><div class="dim-info">ë¯¸ì—…ë¡œë“œ</div></div>
    </div>
    <div class="btn-group">
      <button class="btn btn-danger hidden" id="resetBtn" onclick="resetData()">ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="card" id="convexCard">
    <h2>ë°ì´í„° ê´€ë¦¬ (Convex DB)</h2>
    <div style="display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;">
      <div class="control-group" style="flex:1; min-width:200px;">
        <label>ê¸°ê°„ ì„ íƒ</label>
        <select id="selPeriod" onchange="loadPeriodData()">
          <option value="">-- ê¸°ê°„ ì„ íƒ --</option>
          <option value="__ALL__">ì „ì²´ ëˆ„ì </option>
        </select>
      </div>
      <button class="btn btn-primary hidden" id="btnSaveConvex" onclick="saveToConvex()">DBì— ì €ì¥</button>
      <button class="btn btn-secondary" onclick="refreshPeriods()">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div id="convexProgress" class="hidden" style="margin-top:12px;">
      <div style="background:var(--gray-200); border-radius:4px; height:8px; overflow:hidden;">
        <div id="progressBar" style="width:0%; height:100%; background:var(--primary); transition:width 0.3s;"></div>
      </div>
      <div id="progressText" style="font-size:12px; color:var(--gray-500); margin-top:4px;">ì¤€ë¹„ ì¤‘...</div>
    </div>
    <div id="convexStatus" style="font-size:12px; color:var(--gray-500); margin-top:8px;"></div>
  </div>
</div>

<!-- ========== P-CATEGORY: ì¹´í…Œê³ ë¦¬ë³„ ê²°ê³¼ ========== -->
<div class="page hidden" id="page-p-category">
  <div class="header-bar"><h2>êµ¬ë§¤ ê³ ê° íŠ¹ì„± ë¶„ì„ â€” ì¹´í…Œê³ ë¦¬ë³„ ê²°ê³¼</h2></div>

  <!-- ë¶„ì„ ì„¤ì • (hidden until data) -->
  <div class="card hidden" id="controlsCard">
    <div class="controls-grid">
      <div class="control-group">
        <label>ë¶„ì„ ì°¨ì›</label>
        <select id="selDimension" onchange="runAnalysis()"></select>
      </div>
      <div class="control-group">
        <label>ì§‘ê³„ ìˆ˜ì¤€</label>
        <select id="selLevel" onchange="runAnalysis()">
          <option value="ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)">ëŒ€ë¶„ë¥˜</option>
          <option value="ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)" selected>ì¤‘ë¶„ë¥˜</option>
          <option value="ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)">ì†Œë¶„ë¥˜</option>
        </select>
      </div>
      <div class="control-group">
        <label>ì§€í‘œ</label>
        <div class="radio-group" id="metricGroup">
          <label class="active" onclick="selectMetric(this, 'ê²°ì œê¸ˆì•¡')"><span>ê²°ì œê¸ˆì•¡</span></label>
          <label onclick="selectMetric(this, 'ê²°ì œìˆ˜')"><span>ê²°ì œìˆ˜</span></label>
          <label onclick="selectMetric(this, 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰')"><span>ê²°ì œìƒí’ˆìˆ˜ëŸ‰</span></label>
        </div>
      </div>
      <div class="control-group">
        <label>ì˜µì…˜</label>
        <div class="checkbox-group">
          <label><input type="checkbox" id="chkExcludeUnknown" checked onchange="runAnalysis()"> (ì•Œìˆ˜ì—†ìŒ) ì œì™¸</label>
          <label><input type="checkbox" id="chkShowAbsolute" onchange="renderCurrentTab()"> ì ˆëŒ€ê°’ í‘œì‹œ</label>
        </div>
      </div>
    </div>
  </div>

  <div class="card hidden" id="resultsCard">
    <div class="metrics-row" id="metricsRow"></div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('table')">í…Œì´ë¸” ë³´ê¸°</button>
      <button class="tab-btn" onclick="switchTab('chart')">ì°¨íŠ¸ ë³´ê¸°</button>
      <button class="tab-btn" onclick="switchTab('integrated')">í†µí•© ë³´ê¸°</button>
    </div>

    <!-- Tab: Table -->
    <div class="tab-content active" id="tab-table">
      <div class="table-wrapper" id="mainTable"></div>
      <div class="btn-group"><button class="btn btn-primary" onclick="exportExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button></div>
      <hr style="margin:24px 0; border:none; border-top:1px solid var(--gray-200);">
      <h3 style="font-size:15px; font-weight:600; margin-bottom:12px;">ë“œë¦´ë‹¤ìš´ ë¶„ì„</h3>
      <div class="drilldown-controls" id="drilldownControls"></div>
      <div id="drilldownResult"></div>
    </div>

    <!-- Tab: Chart -->
    <div class="tab-content" id="tab-chart">
      <div class="chart-controls" id="chartTypeGroup">
        <button class="btn btn-primary" onclick="selectChartType('bar-h')">ê°€ë¡œ ë§‰ëŒ€</button>
        <button class="btn btn-secondary" onclick="selectChartType('bar-v')">ì„¸ë¡œ ë§‰ëŒ€</button>
        <button class="btn btn-secondary" onclick="selectChartType('pie')">íŒŒì´</button>
      </div>
      <div id="pieSelector" class="hidden" style="margin-bottom:16px;">
        <div class="control-group" style="max-width:300px;">
          <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
          <select id="selPieCategory" onchange="renderPieChart()"></select>
        </div>
      </div>
      <div class="chart-container"><canvas id="mainChart"></canvas></div>
    </div>

    <!-- Tab: Integrated -->
    <div class="tab-content" id="tab-integrated">
      <div id="integratedContent"></div>
    </div>
  </div>

  <div class="card hidden" id="noDataCard">
    <div class="info-box">ë¨¼ì € "ë°ì´í„° ì—…ë¡œë“œ" ë©”ë‰´ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ DBì—ì„œ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.</div>
  </div>
</div>

<!-- ========== P-PRODUCT: ìƒí’ˆë³„ ìƒì„¸ ========== -->
<div class="page hidden" id="page-p-product">
  <div class="header-bar"><h2>êµ¬ë§¤ ê³ ê° íŠ¹ì„± ë¶„ì„ â€” ìƒí’ˆë³„ ìƒì„¸</h2></div>
  <div class="card">
    <div class="control-group" style="max-width:500px; margin-bottom:16px;">
      <label>ìƒí’ˆëª… ê²€ìƒ‰</label>
      <input type="text" id="searchInput" placeholder="ìƒí’ˆëª… ë˜ëŠ” ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰..." oninput="filterAndRender()"
        style="width:100%; padding:10px 14px; border:1px solid var(--gray-300); border-radius:6px; font-size:14px; font-family:inherit;">
    </div>
    <div class="table-wrapper" id="productDetailTable"></div>
  </div>
</div>

<!-- ========== R-UPLOAD: ë¦¬ë·° ë°ì´í„° ì—…ë¡œë“œ ========== -->
<div class="page hidden" id="page-r-upload">
  <div class="header-bar"><h2>êµ¬ë§¤ ê³ ê° ë¦¬ë·° ë¶„ì„ â€” ë°ì´í„° ì—…ë¡œë“œ</h2></div>

  <div class="card">
    <h2>ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h2>
    <div class="upload-area" id="reviewUploadArea">
      <div class="icon">ğŸ“</div>
      <p><b>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸</b>í•˜ì—¬ ë¦¬ë·° ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
      <p style="font-size:12px; margin-top:8px; color:#999;">ë„¤ì´ë²„ ìŠ¤í† ì–´ ë¦¬ë·° ë‹¤ìš´ë¡œë“œ íŒŒì¼ (.xlsx) â€” ì—¬ëŸ¬ ë²ˆ ì—…ë¡œë“œí•˜ë©´ ëˆ„ì ë©ë‹ˆë‹¤</p>
      <input type="file" id="reviewFileInput" accept=".xlsx,.xls">
    </div>
    <div id="reviewUploadStatus" class="hidden" style="margin-top:12px;">
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <span id="reviewFileName" style="font-size:13px; color:var(--gray-700);"></span>
        <span id="reviewRowCount" class="badge badge-month"></span>
        <span id="reviewProductCount" class="badge badge-photo"></span>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>ì €ì¥ëœ ë¦¬ë·° ë°ì´í„° (Convex DB)</h2>
    <div id="reviewSessionList" style="font-size:13px; color:var(--gray-500);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
      <button class="btn btn-primary hidden" id="btnSaveReview" onclick="saveReviewToConvex()">DBì— ì €ì¥</button>
      <button class="btn btn-secondary" onclick="loadAllReviewsFromConvex()">ì „ì²´ ëˆ„ì  ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn btn-secondary" onclick="refreshReviewSessions()">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div id="reviewConvexProgress" class="hidden" style="margin-top:12px;">
      <div style="background:var(--gray-200); border-radius:4px; height:8px; overflow:hidden;">
        <div id="reviewProgressBar" style="width:0%; height:100%; background:var(--primary); transition:width 0.3s;"></div>
      </div>
      <div id="reviewProgressText" style="font-size:12px; color:var(--gray-500); margin-top:4px;">ì¤€ë¹„ ì¤‘...</div>
    </div>
    <div id="reviewConvexStatus" style="font-size:12px; color:var(--gray-500); margin-top:8px;"></div>
  </div>
</div>

<!-- ========== R-REVIEWS: ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ========== -->
<div class="page hidden" id="page-r-reviews">
  <div class="header-bar"><h2>êµ¬ë§¤ ê³ ê° ë¦¬ë·° ë¶„ì„ â€” ë¦¬ë·° ë¦¬ìŠ¤íŠ¸</h2></div>

  <!-- ì¹´í…Œê³ ë¦¬ & ìƒí’ˆ í•„í„° (ìƒë‹¨, ë„“ê²Œ) -->
  <div class="card hidden" id="reviewControlCard">
    <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; margin-bottom:12px;">
      <div class="control-group" style="min-width:180px;">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="reviewCategoryFilter" onchange="onCategoryFilterChange()"
          style="width:100%; padding:8px 12px; border:1px solid var(--gray-300); border-radius:6px; font-size:13px; font-family:inherit;">
          <option value="__ALL__">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
        </select>
      </div>
      <div class="control-group" style="flex:1; min-width:300px;">
        <label>ìƒí’ˆ ê²€ìƒ‰ (í´ë¦­í•˜ì—¬ ì„ íƒ)</label>
        <input type="text" id="reviewProductSearch" placeholder="ìƒí’ˆë²ˆí˜¸ ë˜ëŠ” ìƒí’ˆëª… ê²€ìƒ‰..."
          oninput="filterReviewProducts()"
          style="width:100%; padding:8px 12px; border:1px solid var(--gray-300); border-radius:6px; font-size:13px; font-family:inherit;">
      </div>
    </div>

    <!-- ì„ íƒëœ ìƒí’ˆ ì¹© -->
    <div class="chip-container" id="selectedChips"></div>

    <!-- ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (ë„“ê²Œ) -->
    <div class="product-list" id="reviewProductList" style="max-height:200px;"></div>
    <div style="margin-top:6px; font-size:12px; color:var(--gray-500);">
      <span id="reviewFilteredCount">0</span>ê°œ ìƒí’ˆ |
      <a href="#" onclick="selectAllReviewProducts(); return false;" style="color:var(--primary);">ì „ì²´ ì„ íƒ</a> |
      <a href="#" onclick="clearProductSelection(); return false;" style="color:var(--gray-500);">ì„ íƒ í•´ì œ</a>
    </div>
  </div>

  <!-- í•„í„° ë°” + ìš”ì•½ -->
  <div class="card hidden" id="reviewResultCard">
    <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; margin-bottom:12px;">
      <div class="control-group">
        <label>ë¦¬ë·° ìœ í˜•</label>
        <div class="radio-group" id="reviewTypeGroup">
          <label class="active" onclick="selectReviewType(this, 'all')"><span>ì „ì²´</span></label>
          <label onclick="selectReviewType(this, 'general')"><span>ì¼ë°˜</span></label>
          <label onclick="selectReviewType(this, 'month')"><span>í•œë‹¬ì‚¬ìš©</span></label>
        </div>
      </div>
      <div class="control-group">
        <label>ì •ë ¬</label>
        <select id="reviewSort" onchange="renderReviewList()" style="padding:8px 12px; border:1px solid var(--gray-300); border-radius:6px; font-size:13px; font-family:inherit;">
          <option value="date-desc">ìµœì‹ ìˆœ</option>
          <option value="date-asc">ì˜¤ë˜ëœìˆœ</option>
          <option value="rating-desc">í‰ì  ë†’ì€ìˆœ</option>
          <option value="rating-asc">í‰ì  ë‚®ì€ìˆœ</option>
          <option value="helpful-desc">ë„ì›€ìˆ˜ ë†’ì€ìˆœ</option>
        </select>
      </div>
      <div class="control-group">
        <label>í‰ì  í•„í„°</label>
        <select id="reviewRatingFilter" onchange="renderReviewList()" style="padding:8px 12px; border:1px solid var(--gray-300); border-radius:6px; font-size:13px; font-family:inherit;">
          <option value="all">ì „ì²´</option>
          <option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option>
          <option value="4">â˜…â˜…â˜…â˜…â˜† (4)</option>
          <option value="3">â˜…â˜…â˜…â˜†â˜† (3)</option>
          <option value="2">â˜…â˜…â˜†â˜†â˜† (2)</option>
          <option value="1">â˜…â˜†â˜†â˜†â˜† (1)</option>
        </select>
      </div>
    </div>
    <div class="review-summary" id="reviewSummary"></div>
    <div id="reviewListContainer" style="margin-top:16px;"></div>
    <div class="pagination" id="reviewPagination"></div>
  </div>
</div>

<!-- ========== R-KEYWORDS: í‚¤ì›Œë“œ ë¶„ì„ ========== -->
<div class="page hidden" id="page-r-keywords">
  <div class="header-bar"><h2>êµ¬ë§¤ ê³ ê° ë¦¬ë·° ë¶„ì„ â€” í‚¤ì›Œë“œ ë¶„ì„</h2></div>
  <div class="card">
    <div id="keywordCategoryCards" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:20px; margin-bottom:24px;"></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
      <div>
        <h3 style="font-size:15px; margin-bottom:12px;">ì „ì²´ ì˜ë¯¸ í‚¤ì›Œë“œ (ë¹ˆë„ìˆœ)</h3>
        <div class="table-wrapper" id="keywordTable"></div>
      </div>
      <div>
        <h3 style="font-size:15px; margin-bottom:12px;">í‚¤ì›Œë“œ ë¹ˆë„ ì°¨íŠ¸</h3>
        <div class="chart-container" style="height:400px;"><canvas id="keywordChart"></canvas></div>
      </div>
    </div>
    <div class="kw-drilldown hidden" id="kwDrilldown">
      <div class="kw-drilldown-header">
        <h3 style="font-size:15px;"><span id="kwDrilldownTitle"></span> â€” ê´€ë ¨ ë¦¬ë·° <span id="kwDrilldownCount" class="badge badge-photo"></span></h3>
        <button class="btn btn-secondary" onclick="closeKwDrilldown()" style="padding:4px 12px; font-size:12px;">ë‹«ê¸°</button>
      </div>
      <div id="kwDrilldownList"></div>
      <div class="pagination" id="kwDrilldownPagination"></div>
    </div>
  </div>
</div>

<!-- ========== R-NEGATIVE: ë¶€ì •ì  ì˜ê²¬ ========== -->
<div class="page hidden" id="page-r-negative">
  <div class="header-bar"><h2>êµ¬ë§¤ ê³ ê° ë¦¬ë·° ë¶„ì„ â€” ë¶€ì •ì  ì˜ê²¬</h2></div>
  <div class="card">
    <div id="negativeSummary" style="margin-bottom:16px;"></div>
    <div id="negativeListContainer"></div>
    <div class="pagination" id="negativePagination"></div>
  </div>
</div>

</div><!-- /main-content -->

<!-- Image Modal -->
<div class="img-modal" id="imgModal" onclick="closeImageModal()">
  <img id="imgModalSrc" src="" alt="">
</div>

</div><!-- /app-layout -->

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Constants
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIMENSIONS = {
  'ìë…€ë‚˜ì´': ['ì´ˆë“±í•™ìƒ', 'ë¯¸ì·¨í•™', 'ìë…€ì—†ìŒ', 'ì¤‘ê³ ë“±í•™ìƒ', '0-24ê°œì›”', 'ì„±ì¸', '(ì•Œìˆ˜ì—†ìŒ)'],
  'ê²°í˜¼ìƒíƒœ': ['ê¸°í˜¼', 'ë¯¸í˜¼', '(ì•Œìˆ˜ì—†ìŒ)'],
  'ê°€êµ¬ë‹¹ì¸ì›': ['2ì¸ì´ìƒ', '1ì¸', '(ì•Œìˆ˜ì—†ìŒ)'],
};
// ì‹¤ì œ ì—‘ì…€ ì»¬ëŸ¼ëª… ë§¤í•‘
const CATEGORY_COLUMNS = ['ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì„¸)', 'ìƒí’ˆëª…', 'ìƒí’ˆID'];
const PAYMENT_METRICS = ['ê²°ì œê¸ˆì•¡', 'ê²°ì œìˆ˜', 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰'];
const REFUND_METRICS = ['í™˜ë¶ˆê¸ˆì•¡', 'í™˜ë¶ˆê±´ìˆ˜', 'í™˜ë¶ˆìˆ˜ëŸ‰'];
const ALL_METRICS = [...PAYMENT_METRICS, ...REFUND_METRICS];
const UNKNOWN_VALUE = '(ì•Œìˆ˜ì—†ìŒ)';
// 3ë‹¨ê³„ ì¹´í…Œê³ ë¦¬ (ì„¸ë¶„ë¥˜ëŠ” ëŒ€ë¶€ë¶„ "-"ì´ë¯€ë¡œ ì œì™¸)
const LEVEL_HIERARCHY = ['ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)', 'ìƒí’ˆ'];
const LEVEL_DISPLAY = {'ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)':'ëŒ€ë¶„ë¥˜', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)':'ì¤‘ë¶„ë¥˜', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)':'ì†Œë¶„ë¥˜', 'ìƒí’ˆ':'ìƒí’ˆ'};

// Convex ì„¤ì •
const CONVEX_URL = 'https://grateful-cheetah-178.convex.cloud';
const CHART_COLORS = [
  '#1E88E5','#43A047','#FB8C00','#E53935','#8E24AA','#00ACC1','#F4511E',
  '#3949AB','#7CB342','#FDD835','#6D4C41','#546E7A',
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let profileData = {};  // { dimension: { df: [...], attrValues: [...], filename, dateRange } }
let currentResult = null;
let currentMetric = 'ê²°ì œê¸ˆì•¡';
let currentChartType = 'bar-h';
let mainChartInstance = null;
let searchTerm = '';
let availableMonths = [];  // Convexì—ì„œ ë¡œë“œëœ ê¸°ê°„ ëª©ë¡

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// File Upload
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');

uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

function handleFiles(files) {
  for (const file of files) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { defval: 0 });
        if (json.length === 0) { alert(`ë¹ˆ íŒŒì¼ì…ë‹ˆë‹¤: ${file.name}`); return; }
        processFile(file.name, json);
      } catch (err) {
        alert(`íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ${file.name}\n${err.message}`);
      }
    };
    reader.readAsArrayBuffer(file);
  }
}

function processFile(filename, rows) {
  // Identify dimension
  let dimension = identifyFileType(filename, rows);
  if (!dimension) {
    alert(`íŒŒì¼ ìœ í˜•ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${filename}`);
    return;
  }

  // Detect attribute column or wide format
  const parsed = parseRows(rows, dimension);
  const dateRange = parseDateRange(filename);

  profileData[dimension] = {
    df: parsed,
    attrValues: DIMENSIONS[dimension],
    filename: filename,
    dateRange: dateRange,
  };

  updateStatus();
  showControls();
  runAnalysis();
}

function identifyFileType(filename, rows) {
  // Check filename
  for (const dim of Object.keys(DIMENSIONS)) {
    if (filename.includes(dim)) return dim;
  }
  // Check column headers
  const cols = rows.length > 0 ? Object.keys(rows[0]) : [];
  const colStr = cols.join(' ');
  for (const [dim, attrs] of Object.entries(DIMENSIONS)) {
    if (colStr.includes(dim)) return dim;
    const matches = attrs.filter(a => colStr.includes(a)).length;
    if (matches >= 2) return dim;
  }
  return null;
}

function parseDateRange(filename) {
  let m = filename.match(/_(\d{8})_(\d{8})/);
  if (m) {
    const s = m[1], e = m[2];
    return { start: `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`, end: `${e.slice(0,4)}-${e.slice(4,6)}-${e.slice(6,8)}` };
  }
  m = filename.match(/_(\d{4}-\d{2}-\d{2})_(\d{4}-\d{2}-\d{2})/);
  if (m) return { start: m[1], end: m[2] };
  return null;
}

function parseRows(rows, dimension) {
  if (rows.length === 0) return [];
  const cols = Object.keys(rows[0]);

  // Check if dimension name or attribute values exist as a column (long format)
  let attrCol = null;
  if (cols.includes(dimension)) {
    attrCol = dimension;
  } else {
    const attrValues = new Set(DIMENSIONS[dimension]);
    for (const col of cols) {
      if (CATEGORY_COLUMNS.includes(col) || ALL_METRICS.includes(col)) continue;
      const vals = new Set(rows.slice(0, 100).map(r => String(r[col]).trim()));
      const overlap = [...vals].filter(v => attrValues.has(v));
      if (overlap.length >= 2) { attrCol = col; break; }
    }
  }

  if (attrCol) {
    // Long format
    return rows.map(r => {
      const rec = { attribute_value: String(r[attrCol]).trim() };
      for (const cc of CATEGORY_COLUMNS) {
        if (r[cc] !== undefined) rec[cc] = r[cc];
      }
      for (const m of ALL_METRICS) {
        rec[m] = safeNum(r[m]);
      }
      return rec;
    });
  }

  // Wide format: attribute values are column prefixes
  const attrValues = DIMENSIONS[dimension];
  const result = [];
  for (const r of rows) {
    const catData = {};
    for (const cc of CATEGORY_COLUMNS) {
      if (r[cc] !== undefined) catData[cc] = r[cc];
    }
    for (const attr of attrValues) {
      const rec = { ...catData, attribute_value: attr };
      for (const m of ALL_METRICS) {
        const colName = findMetricColumn(Object.keys(r), attr, m);
        rec[m] = colName ? safeNum(r[colName]) : 0;
      }
      result.push(rec);
    }
  }
  return result;
}

function findMetricColumn(cols, attrValue, metric) {
  return cols.find(c => c.includes(attrValue) && c.includes(metric)) || null;
}

function safeNum(v) {
  if (v == null || v === '') return 0;
  const n = Number(v);
  return isNaN(n) ? 0 : n;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI Status
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStatus() {
  for (const dim of Object.keys(DIMENSIONS)) {
    const el = document.getElementById(`status-${dim}`);
    if (profileData[dim]) {
      const d = profileData[dim];
      const nRows = d.df.length;
      const dr = d.dateRange;
      el.className = 'status-card loaded';
      el.innerHTML = `
        <div class="dim-name">${dim} â€” ì—…ë¡œë“œ ì™„ë£Œ</div>
        <div class="dim-info">íŒŒì¼: ${d.filename}</div>
        <div class="dim-info">í–‰ ìˆ˜: ${nRows.toLocaleString()}ê°œ</div>
        ${dr ? `<div class="dim-info">ê¸°ê°„: ${dr.start} ~ ${dr.end}</div>` : ''}
      `;
    } else {
      el.className = 'status-card empty';
      el.innerHTML = `<div class="dim-name">${dim}</div><div class="dim-info">ë¯¸ì—…ë¡œë“œ</div>`;
    }
  }
  document.getElementById('resetBtn').classList.toggle('hidden', Object.keys(profileData).length === 0);
}

function resetData() {
  if (!confirm('ì—…ë¡œë“œëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  profileData = {};
  currentResult = null;
  updateStatus();
  document.getElementById('controlsCard').classList.add('hidden');
  document.getElementById('resultsCard').classList.add('hidden');
  fileInput.value = '';
}

function showControls() {
  const dims = Object.keys(profileData);
  if (dims.length === 0) return;

  document.getElementById('controlsCard').classList.remove('hidden');
  const sel = document.getElementById('selDimension');
  sel.innerHTML = dims.map(d => `<option value="${d}">${d}</option>`).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Analysis
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectMetric(el, metric) {
  currentMetric = metric;
  document.querySelectorAll('#metricGroup label').forEach(l => l.classList.remove('active'));
  el.classList.add('active');
  runAnalysis();
}

function runAnalysis() {
  const dimension = document.getElementById('selDimension').value;
  const level = document.getElementById('selLevel').value;
  const excludeUnknown = document.getElementById('chkExcludeUnknown').checked;

  if (!profileData[dimension]) return;

  const df = profileData[dimension].df;
  const result = computePercentageDistribution(df, level, currentMetric, excludeUnknown);

  let attrValues = DIMENSIONS[dimension].slice();
  if (excludeUnknown) attrValues = attrValues.filter(a => a !== UNKNOWN_VALUE);

  currentResult = { dimension, level, metric: currentMetric, excludeUnknown, data: result, attrValues };

  document.getElementById('resultsCard').classList.remove('hidden');
  renderMetrics();
  renderCurrentTab();
}

function computePercentageDistribution(df, aggLevel, metric, excludeUnknown) {
  let data = df;
  if (excludeUnknown) data = data.filter(r => r.attribute_value !== UNKNOWN_VALUE);

  const groupCol = aggLevel === 'ìƒí’ˆ' ? 'ìƒí’ˆëª…' : aggLevel;
  const displayLevel = LEVEL_DISPLAY[aggLevel] || aggLevel;

  // Group by category + attribute_value â†’ sum metric
  const map = {};
  for (const r of data) {
    const cat = r[groupCol] || '';
    if (!cat) continue;
    if (!map[cat]) map[cat] = {};
    const attr = r.attribute_value;
    map[cat][attr] = (map[cat][attr] || 0) + safeNum(r[metric]);
  }

  // Build result rows
  const rows = [];
  for (const [cat, attrs] of Object.entries(map)) {
    const total = Object.values(attrs).reduce((s, v) => s + v, 0);
    const row = { category: cat, 'í•©ê³„': total };
    for (const [attr, val] of Object.entries(attrs)) {
      row[attr] = total > 0 ? Math.round(val / total * 1000) / 10 : 0;
      row[`${attr}_abs`] = val;
    }
    rows.push(row);
  }

  rows.sort((a, b) => b['í•©ê³„'] - a['í•©ê³„']);
  return rows;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tabs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tabId) {
  const card = document.getElementById('resultsCard');
  if (!card) return;
  card.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  card.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`#tab-${tabId}`).classList.add('active');
  card.querySelectorAll('.tab-btn').forEach(b => {
    if (b.textContent.includes(tabId === 'table' ? 'í…Œì´ë¸”' : tabId === 'chart' ? 'ì°¨íŠ¸' : 'í†µí•©'))
      b.classList.add('active');
  });
  renderCurrentTab();
}

function renderCurrentTab() {
  if (!currentResult) return;
  const card = document.getElementById('resultsCard');
  if (!card) return;
  const active = card.querySelector('.tab-content.active');
  if (!active) return;
  if (active.id === 'tab-table') renderTable();
  else if (active.id === 'tab-chart') renderChart();
  else if (active.id === 'tab-integrated') renderIntegrated();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Metrics Row
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMetrics() {
  if (!currentResult) return;
  const r = currentResult;
  const periodInfo = r.fromConvex && r.sessionIds
    ? (r.sessionIds.length > 1 ? `ëˆ„ì  (${r.sessionIds.length}ê°œì›”)` : 'ë‹¨ì¼ ê¸°ê°„')
    : 'ë¡œì»¬ ë°ì´í„°';
  document.getElementById('metricsRow').innerHTML = `
    <div class="metric-card"><div class="label">ì¹´í…Œê³ ë¦¬ ìˆ˜</div><div class="value">${r.data.length}ê°œ</div></div>
    <div class="metric-card"><div class="label">ë¶„ì„ ì°¨ì›</div><div class="value">${r.dimension}</div></div>
    <div class="metric-card"><div class="label">ì§‘ê³„ ìˆ˜ì¤€</div><div class="value">${LEVEL_DISPLAY[r.level] || r.level}</div></div>
    <div class="metric-card"><div class="label">ê¸°ê°„/ì§€í‘œ</div><div class="value">${periodInfo} Â· ${r.metric}</div></div>
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Table Rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterAndRender() {
  if (currentPage === 'p-product') {
    renderProductDetailView();
  } else {
    searchTerm = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
    renderTable();
  }
}

function getFilteredData() {
  if (!currentResult) return [];
  if (!searchTerm) return currentResult.data;
  return currentResult.data.filter(row =>
    (row.category || '').toLowerCase().includes(searchTerm)
  );
}

function renderTable() {
  if (!currentResult) return;
  const { attrValues, level } = currentResult;
  const data = getFilteredData();
  const showAbs = document.getElementById('chkShowAbsolute').checked;

  const totalCount = currentResult.data.length;
  const filteredCount = data.length;
  const filterInfo = searchTerm ? ` <span style="font-size:12px; color:var(--gray-500);">(${filteredCount}/${totalCount}ê±´ í‘œì‹œ)</span>` : '';

  let html = filterInfo + '<table><thead><tr><th>ì¹´í…Œê³ ë¦¬</th>';
  for (const a of attrValues) html += `<th>${a}</th>`;
  html += '<th>í•©ê³„</th></tr></thead><tbody>';

  for (const row of data) {
    // Find max percentage value in this row
    let maxPct = -1;
    let maxAttr = '';
    for (const a of attrValues) {
      const pct = row[a] || 0;
      if (pct > maxPct) { maxPct = pct; maxAttr = a; }
    }

    html += `<tr><td>${row.category}</td>`;
    for (const a of attrValues) {
      const pct = row[a] || 0;
      const abs = row[`${a}_abs`] || 0;
      const isMax = a === maxAttr && maxPct > 0 ? ' class="max-val"' : '';
      const display = showAbs ? `${pct.toFixed(1)}% (${abs.toLocaleString()})` : `${pct.toFixed(1)}%`;
      html += `<td${isMax}>${display}</td>`;
    }
    html += `<td style="font-weight:600;">${(row['í•©ê³„'] || 0).toLocaleString()}</td></tr>`;
  }
  html += '</tbody></table>';

  document.getElementById('mainTable').innerHTML = html;
  renderDrilldown();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Drilldown
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDrilldown() {
  const { data, level } = currentResult;
  const idx = LEVEL_HIERARCHY.indexOf(level);
  const container = document.getElementById('drilldownControls');
  const resultDiv = document.getElementById('drilldownResult');
  resultDiv.innerHTML = '';

  if (idx >= LEVEL_HIERARCHY.length - 1) {
    container.innerHTML = '<div class="info-box">ìµœí•˜ìœ„ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ë” ì´ìƒ ë“œë¦´ë‹¤ìš´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const childLevel = LEVEL_HIERARCHY[idx + 1];
  const categories = data.map(r => r.category);
  const displayLevel = LEVEL_DISPLAY[level] || level;
  const displayChild = LEVEL_DISPLAY[childLevel] || childLevel;

  container.innerHTML = `
    <div class="control-group">
      <label>ë“œë¦´ë‹¤ìš´: ${displayLevel} â†’ ${displayChild}</label>
      <select id="selDrillCategory" onchange="executeDrilldown()">
        ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
      </select>
    </div>
    <button class="btn btn-primary" onclick="executeDrilldown()">ë¶„ì„</button>
  `;
}

function executeDrilldown() {
  const { dimension, level, metric, excludeUnknown, attrValues } = currentResult;
  const parentValue = document.getElementById('selDrillCategory').value;
  const idx = LEVEL_HIERARCHY.indexOf(level);
  const childLevel = LEVEL_HIERARCHY[idx + 1];

  // Convex ëª¨ë“œë©´ ì„œë²„ì—ì„œ ë“œë¦´ë‹¤ìš´
  if (currentResult.fromConvex && currentResult.sessionIds) {
    const levelMap = { 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)': 'L1', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)': 'L2', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)': 'L3', 'ìƒí’ˆ': 'product' };
    const metricMap = { 'ê²°ì œê¸ˆì•¡': 'paymentAmount', 'ê²°ì œìˆ˜': 'paymentCount', 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰': 'paymentQuantity' };
    convexCall('query', 'queryData:getDrilldown', {
      sessionIds: currentResult.sessionIds,
      dimension,
      parentLevel: levelMap[level] || 'L2',
      parentValue,
      metric: metricMap[metric] || 'paymentAmount',
      excludeUnknown,
    }).then(result => {
      const drillData = result.map(r => {
        const row = { category: r.category, 'í•©ê³„': r.total };
        for (const d of r.distribution) { row[d.attributeValue] = d.percentage; row[`${d.attributeValue}_abs`] = d.absoluteValue; }
        return row;
      });
      renderDrilldownTable(drillData, attrValues, level, childLevel, parentValue);
    }).catch(err => {
      document.getElementById('drilldownResult').innerHTML = `<div class="info-box">ë“œë¦´ë‹¤ìš´ ì‹¤íŒ¨: ${err.message}</div>`;
    });
    return;
  }

  const parentCol = level === 'ìƒí’ˆ' ? 'ìƒí’ˆëª…' : level;
  const df = profileData[dimension].df;
  const filtered = df.filter(r => r[parentCol] === parentValue);
  const drillData = computePercentageDistribution(filtered, childLevel, metric, excludeUnknown);

  renderDrilldownTable(drillData, attrValues, level, childLevel, parentValue);
}

function renderDrilldownTable(drillData, attrValues, level, childLevel, parentValue) {
  const showAbs = document.getElementById('chkShowAbsolute').checked;
  const resultDiv = document.getElementById('drilldownResult');

  if (drillData.length === 0) {
    resultDiv.innerHTML = '<div class="info-box">í•˜ìœ„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const displayLevel = LEVEL_DISPLAY[level] || level;
  const displayChild = LEVEL_DISPLAY[childLevel] || childLevel;
  let html = `<div class="breadcrumb">${displayLevel}: <span>${parentValue}</span> â†’ ${displayChild} í•˜ìœ„ ë¶„ì„</div>`;
  html += '<div class="table-wrapper"><table><thead><tr><th>ì¹´í…Œê³ ë¦¬</th>';
  for (const a of attrValues) html += `<th>${a}</th>`;
  html += '<th>í•©ê³„</th></tr></thead><tbody>';

  for (const row of drillData) {
    let maxPct = -1, maxAttr = '';
    for (const a of attrValues) { if ((row[a]||0) > maxPct) { maxPct = row[a]||0; maxAttr = a; } }

    html += `<tr><td>${row.category}</td>`;
    for (const a of attrValues) {
      const pct = row[a] || 0;
      const abs = row[`${a}_abs`] || 0;
      const isMax = a === maxAttr && maxPct > 0 ? ' class="max-val"' : '';
      const display = showAbs ? `${pct.toFixed(1)}% (${abs.toLocaleString()})` : `${pct.toFixed(1)}%`;
      html += `<td${isMax}>${display}</td>`;
    }
    html += `<td style="font-weight:600;">${(row['í•©ê³„']||0).toLocaleString()}</td></tr>`;
  }
  html += '</tbody></table></div>';
  resultDiv.innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Chart Rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectChartType(type) {
  currentChartType = type;
  document.querySelectorAll('#chartTypeGroup .btn').forEach(b => {
    b.className = 'btn ' + (b.textContent.includes(
      type === 'bar-h' ? 'ê°€ë¡œ' : type === 'bar-v' ? 'ì„¸ë¡œ' : 'íŒŒì´'
    ) ? 'btn-primary' : 'btn-secondary');
  });
  document.getElementById('pieSelector').classList.toggle('hidden', type !== 'pie');
  renderChart();
}

function renderChart() {
  if (!currentResult) return;
  if (currentChartType === 'pie') {
    populatePieSelector();
    renderPieChart();
  } else {
    document.getElementById('pieSelector').classList.add('hidden');
    renderBarChart();
  }
}

function renderBarChart() {
  const { attrValues, dimension, level, metric } = currentResult;
  const data = getFilteredData();
  if (mainChartInstance) mainChartInstance.destroy();

  const isHorizontal = currentChartType === 'bar-h';
  const labels = data.map(r => r.category);

  const datasets = attrValues.map((attr, i) => ({
    label: attr,
    data: data.map(r => r[attr] || 0),
    backgroundColor: CHART_COLORS[i % CHART_COLORS.length],
  }));

  const canvas = document.getElementById('mainChart');
  canvas.style.height = isHorizontal ? Math.max(400, data.length * 40) + 'px' : '500px';

  mainChartInstance = new Chart(canvas, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      indexAxis: isHorizontal ? 'y' : 'x',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: `${dimension} / ${LEVEL_DISPLAY[level] || level} / ${metric} ë¶„í¬`, font: { size: 16 } },
        legend: { position: 'top' },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw.toFixed(1)}%` } },
      },
      scales: {
        x: { stacked: true, ...(isHorizontal ? { max: 100, title: { display: true, text: 'ë¹„ìœ¨ (%)' } } : {}) },
        y: { stacked: true, ...(!isHorizontal ? { max: 100, title: { display: true, text: 'ë¹„ìœ¨ (%)' } } : {}) },
      },
    },
  });
}

function populatePieSelector() {
  if (!currentResult) return;
  const data = getFilteredData();
  const sel = document.getElementById('selPieCategory');
  sel.innerHTML = data.map(r => `<option value="${r.category}">${r.category}</option>`).join('');
}

function renderPieChart() {
  if (!currentResult) return;
  const category = document.getElementById('selPieCategory').value;
  const row = currentResult.data.find(r => r.category === category);
  if (!row) return;

  if (mainChartInstance) mainChartInstance.destroy();

  const labels = currentResult.attrValues;
  const values = labels.map(a => row[a] || 0);

  const canvas = document.getElementById('mainChart');
  canvas.style.height = '500px';

  mainChartInstance = new Chart(canvas, {
    type: 'pie',
    data: {
      labels,
      datasets: [{ data: values, backgroundColor: CHART_COLORS.slice(0, labels.length) }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: `${category} ê³ ê° í”„ë¡œíŒŒì¼`, font: { size: 16 } },
        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw.toFixed(1)}%` } },
      },
    },
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Integrated View
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderIntegrated() {
  const container = document.getElementById('integratedContent');
  const level = document.getElementById('selLevel').value;
  const excludeUnknown = document.getElementById('chkExcludeUnknown').checked;

  // Convex ëª¨ë“œ: í˜„ì¬ ë¶„ì„ ê²°ê³¼ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì‚¬ìš©
  if (currentResult && currentResult.fromConvex && currentResult.sessionIds) {
    const categories = currentResult.data.map(r => r.category);
    if (categories.length === 0) {
      container.innerHTML = '<div class="info-box">ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    container.innerHTML = `
      <div class="control-group" style="max-width:300px; margin-bottom:20px;">
        <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
        <select id="selIntCategory" onchange="renderIntegratedDetail()">
          ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div id="integratedDetail"></div>
    `;
    renderIntegratedDetail();
    return;
  }

  const dims = Object.keys(profileData);

  if (dims.length < 2) {
    container.innerHTML = '<div class="info-box">í†µí•© ë¶„ì„ì„ ìœ„í•´ 2ê°œ ì´ìƒì˜ í”„ë¡œíŒŒì¼ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>';
    return;
  }

  const groupCol = level === 'ìƒí’ˆ' ? 'ìƒí’ˆëª…' : level;

  // Get categories from first dimension
  const firstDf = profileData[dims[0]].df;
  const categories = [...new Set(firstDf.map(r => r[groupCol]).filter(Boolean))].sort();

  if (categories.length === 0) {
    container.innerHTML = '<div class="info-box">í•´ë‹¹ ì§‘ê³„ ìˆ˜ì¤€ì— ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  let html = `
    <div class="control-group" style="max-width:300px; margin-bottom:20px;">
      <label>ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
      <select id="selIntCategory" onchange="renderIntegratedDetail()">
        ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
      </select>
    </div>
    <div id="integratedDetail"></div>
  `;
  container.innerHTML = html;
  renderIntegratedDetail();
}

function renderIntegratedDetail() {
  const category = document.getElementById('selIntCategory').value;
  const level = document.getElementById('selLevel').value;
  const excludeUnknown = document.getElementById('chkExcludeUnknown').checked;
  const container = document.getElementById('integratedDetail');

  // Convex ëª¨ë“œ
  if (currentResult && currentResult.fromConvex && currentResult.sessionIds) {
    const levelMap = { 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)': 'L1', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)': 'L2', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)': 'L3', 'ìƒí’ˆ': 'product' };
    const metricMap = { 'ê²°ì œê¸ˆì•¡': 'paymentAmount', 'ê²°ì œìˆ˜': 'paymentCount', 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰': 'paymentQuantity' };
    container.innerHTML = '<div class="info-box">í†µí•© ë¶„ì„ ë¡œë”© ì¤‘...</div>';
    convexCall('query', 'queryData:getIntegratedView', {
      sessionIds: currentResult.sessionIds,
      aggregationLevel: levelMap[level] || 'L2',
      category,
      metric: metricMap[currentMetric] || 'paymentAmount',
      excludeUnknown,
    }).then(results => {
      let html = '<div class="integrated-grid">';
      for (const dimResult of results) {
        html += `<div class="integrated-card"><h4>${dimResult.dimension}</h4>`;
        if (dimResult.distribution.length === 0) {
          html += '<div class="info-box">ë°ì´í„° ì—†ìŒ</div>';
        } else {
          for (let bi = 0; bi < dimResult.distribution.length; bi++) {
            const d = dimResult.distribution[bi];
            html += `
              <div class="attr-bar">
                <div class="name">${d.attributeValue}</div>
                <div class="bar-bg"><div class="bar-fill" style="width:${d.percentage}%; background:${CHART_COLORS[bi % CHART_COLORS.length]}"></div></div>
                <div class="pct">${d.percentage.toFixed(1)}%</div>
              </div>`;
          }
          html += `<div style="text-align:right; font-size:12px; color:#999; margin-top:8px;">í•©ê³„: ${dimResult.total.toLocaleString()}</div>`;
        }
        html += '</div>';
      }
      html += '</div>';
      container.innerHTML = html;
    }).catch(err => {
      container.innerHTML = `<div class="info-box">í†µí•© ë¶„ì„ ì‹¤íŒ¨: ${err.message}</div>`;
    });
    return;
  }

  const groupCol = level === 'ìƒí’ˆ' ? 'ìƒí’ˆëª…' : level;

  let html = '<div class="integrated-grid">';

  for (const [dim, data] of Object.entries(profileData)) {
    const filtered = data.df.filter(r => r[groupCol] === category);
    let work = filtered;
    if (excludeUnknown) work = work.filter(r => r.attribute_value !== UNKNOWN_VALUE);

    // Sum by attribute_value
    const sums = {};
    for (const r of work) {
      const attr = r.attribute_value;
      sums[attr] = (sums[attr] || 0) + safeNum(r[currentMetric]);
    }
    const total = Object.values(sums).reduce((s, v) => s + v, 0);

    // Sort by value descending
    const sorted = Object.entries(sums).sort((a, b) => b[1] - a[1]);

    html += `<div class="integrated-card"><h4>${dim}</h4>`;
    if (sorted.length === 0) {
      html += '<div class="info-box">ë°ì´í„° ì—†ìŒ</div>';
    } else {
      for (const [attr, val] of sorted) {
        const pct = total > 0 ? (val / total * 100) : 0;
        html += `
          <div class="attr-bar">
            <div class="name">${attr}</div>
            <div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${CHART_COLORS[sorted.indexOf([attr,val]) % CHART_COLORS.length]}"></div></div>
            <div class="pct">${pct.toFixed(1)}%</div>
          </div>
        `;
      }
      html += `<div style="text-align:right; font-size:12px; color:#999; margin-top:8px;">í•©ê³„: ${total.toLocaleString()}</div>`;
    }
    html += '</div>';
  }

  html += '</div>';
  container.innerHTML = html;

  // Fix bar colors (the indexOf trick won't work with array comparison)
  setTimeout(() => {
    document.querySelectorAll('.integrated-card').forEach((card, ci) => {
      card.querySelectorAll('.bar-fill').forEach((bar, bi) => {
        bar.style.background = CHART_COLORS[bi % CHART_COLORS.length];
      });
    });
  }, 0);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Excel Export
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportExcel() {
  if (!currentResult) return;
  const { data, attrValues, dimension, level, metric } = currentResult;
  const displayLevel = LEVEL_DISPLAY[level] || level;

  const rows = data.map(row => {
    const r = { 'ì¹´í…Œê³ ë¦¬': row.category };
    for (const attr of attrValues) {
      r[attr] = (row[attr] || 0) / 100;  // decimal for percentage format
    }
    r['í•©ê³„'] = row['í•©ê³„'] || 0;
    return r;
  });

  const ws = XLSX.utils.json_to_sheet(rows);

  // Set percentage format for attribute columns
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let R = range.s.r + 1; R <= range.e.r; R++) {
    for (let C = 1; C <= attrValues.length; C++) {
      const cell = ws[XLSX.utils.encode_cell({ r: R, c: C })];
      if (cell) cell.z = '0.0%';
    }
    // Number format for total
    const totalCell = ws[XLSX.utils.encode_cell({ r: R, c: attrValues.length + 1 })];
    if (totalCell) totalCell.z = '#,##0';
  }

  // Column widths
  ws['!cols'] = [{ wch: 25 }, ...attrValues.map(() => ({ wch: 14 })), { wch: 15 }];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, `${dimension}_${displayLevel}`);
  XLSX.writeFile(wb, `ê³ ê°í”„ë¡œíŒŒì¼_${dimension}_${displayLevel}_${metric}.xlsx`);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Convex DB Integration
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function convexCall(type, path, args) {
  const url = `${CONVEX_URL}/api/${type}`;
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path, args, format: 'json' }),
  });
  const json = await res.json();
  if (json.status === 'error') throw new Error(json.errorMessage || 'Convex error');
  return json.value;
}

function setProgress(pct, text) {
  document.getElementById('convexProgress').classList.remove('hidden');
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressText').textContent = text;
}

function hideProgress() {
  document.getElementById('convexProgress').classList.add('hidden');
}

function setConvexStatus(text, isError) {
  const el = document.getElementById('convexStatus');
  el.textContent = text;
  el.style.color = isError ? 'var(--danger)' : 'var(--success)';
}

// ê¸°ê°„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function refreshPeriods() {
  try {
    const months = await convexCall('query', 'queryData:getAvailableMonths', {});
    availableMonths = months;
    const sel = document.getElementById('selPeriod');
    sel.innerHTML = '<option value="">-- ê¸°ê°„ ì„ íƒ --</option><option value="__ALL__">ì „ì²´ ëˆ„ì </option>';
    for (const m of months) {
      const date = new Date(m.uploadedAt).toLocaleDateString('ko-KR');
      sel.innerHTML += `<option value="${m.sessionId}">${m.periodStart} ~ ${m.periodEnd} (${m.fileCount}ê°œ íŒŒì¼) - ${date}</option>`;
    }
    setConvexStatus(months.length > 0 ? `${months.length}ê°œ ê¸°ê°„ ë¡œë“œë¨` : 'DBì— ì €ì¥ëœ ë°ì´í„° ì—†ìŒ', false);
  } catch (err) {
    setConvexStatus('ê¸°ê°„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + err.message, true);
  }
}

// í˜„ì¬ ë°ì´í„°ë¥¼ Convexì— ì €ì¥
async function saveToConvex() {
  const dims = Object.keys(profileData);
  if (dims.length === 0) { alert('ì—…ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  if (!confirm(`${dims.length}ê°œ ì°¨ì› ë°ì´í„°ë¥¼ Convex DBì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  try {
    setProgress(5, 'ì„¸ì…˜ ìƒì„± ì¤‘...');
    let periodStart = '2025-01-01', periodEnd = '2025-12-31';
    for (const d of Object.values(profileData)) {
      if (d.dateRange) { periodStart = d.dateRange.start; periodEnd = d.dateRange.end; break; }
    }

    const newSessionId = await convexCall('mutation', 'uploadData:createSession', { periodStart, periodEnd });

    setProgress(10, 'ì¹´í…Œê³ ë¦¬ ë° ìƒí’ˆ ë“±ë¡ ì¤‘...');
    const categoryCache = {};
    const productCache = {};
    const firstDf = profileData[dims[0]].df;

    const uniqueCats = {};
    const uniqueProducts = {};
    for (const row of firstDf) {
      const l1 = row['ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)'] || '', l2 = row['ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)'] || '', l3 = row['ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)'] || '';
      const key = `${l1}|${l2}|${l3}`;
      if (!uniqueCats[key]) uniqueCats[key] = { categoryL1: l1, categoryL2: l2, categoryL3: l3 };
      const pid = row['ìƒí’ˆID'], pname = row['ìƒí’ˆëª…'] || '';
      if (pid && !uniqueProducts[pid]) uniqueProducts[pid] = { productId: Number(pid), productName: pname, catKey: key };
    }

    const catKeys = Object.keys(uniqueCats);
    for (let i = 0; i < catKeys.length; i++) {
      categoryCache[catKeys[i]] = await convexCall('mutation', 'uploadData:upsertCategory', uniqueCats[catKeys[i]]);
      setProgress(10 + Math.round(i / catKeys.length * 15), `ì¹´í…Œê³ ë¦¬ ë“±ë¡ ì¤‘... (${i + 1}/${catKeys.length})`);
    }

    const prodKeys = Object.keys(uniqueProducts);
    for (let i = 0; i < prodKeys.length; i++) {
      const p = uniqueProducts[prodKeys[i]];
      const catId = categoryCache[p.catKey];
      if (!catId) continue;
      productCache[prodKeys[i]] = await convexCall('mutation', 'uploadData:upsertProduct', {
        productId: p.productId, productName: p.productName, categoryId: catId,
      });
      if (i % 50 === 0) setProgress(25 + Math.round(i / prodKeys.length * 20), `ìƒí’ˆ ë“±ë¡ ì¤‘... (${i + 1}/${prodKeys.length})`);
    }

    let dimIdx = 0;
    for (const [dim, data] of Object.entries(profileData)) {
      const base = 45 + dimIdx * 15;
      setProgress(base, `${dim} ë°ì´í„° ì—…ë¡œë“œ ì¤‘...`);
      const records = [];
      for (const row of data.df) {
        const prodConvexId = productCache[row['ìƒí’ˆID']];
        if (!prodConvexId) continue;
        records.push({
          sessionId: newSessionId, productId: prodConvexId, dimension: dim,
          attributeValue: row.attribute_value || '',
          paymentAmount: safeNum(row['ê²°ì œê¸ˆì•¡']), paymentCount: safeNum(row['ê²°ì œìˆ˜']),
          paymentQuantity: safeNum(row['ê²°ì œìƒí’ˆìˆ˜ëŸ‰']), refundAmount: safeNum(row['í™˜ë¶ˆê¸ˆì•¡']),
          refundCount: safeNum(row['í™˜ë¶ˆê±´ìˆ˜']), refundQuantity: safeNum(row['í™˜ë¶ˆìˆ˜ëŸ‰']),
        });
      }
      const BATCH = 100;
      for (let i = 0; i < records.length; i += BATCH) {
        await convexCall('mutation', 'uploadData:insertProfileRecords', { records: records.slice(i, i + BATCH) });
        setProgress(base + Math.round((i / records.length) * 15), `${dim} ì—…ë¡œë“œ ì¤‘... (${Math.min(i + BATCH, records.length)}/${records.length})`);
      }
      await convexCall('mutation', 'uploadData:updateSessionFile', {
        sessionId: newSessionId, dimension: dim, filename: data.filename, rowCount: data.df.length,
      });
      dimIdx++;
    }

    setProgress(100, 'ì €ì¥ ì™„ë£Œ!');
    setConvexStatus('DB ì €ì¥ ì™„ë£Œ!', false);
    await refreshPeriods();
    setTimeout(hideProgress, 3000);
  } catch (err) {
    setConvexStatus('ì €ì¥ ì‹¤íŒ¨: ' + err.message, true);
    console.error('Convex save error:', err);
    hideProgress();
  }
}

// Convexì—ì„œ ê¸°ê°„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì „ì²´ ëˆ„ì  ë˜ëŠ” ì›”ë³„)
async function loadPeriodData() {
  const sel = document.getElementById('selPeriod').value;
  if (!sel) return;

  try {
    setProgress(10, 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

    // ì„¸ì…˜ ID ë°°ì—´ ê²°ì •
    let sessionIds = [];
    let periodLabel = '';

    if (sel === '__ALL__') {
      // ì „ì²´ ëˆ„ì : ëª¨ë“  ì„¸ì…˜ ID
      sessionIds = availableMonths.map(m => m.sessionId);
      periodLabel = 'ì „ì²´ ëˆ„ì ';
    } else {
      // íŠ¹ì • ê¸°ê°„
      sessionIds = [sel];
      const month = availableMonths.find(m => m.sessionId === sel);
      periodLabel = month ? `${month.periodStart} ~ ${month.periodEnd}` : 'ì„ íƒ ê¸°ê°„';
    }

    if (sessionIds.length === 0) {
      setConvexStatus('ì €ì¥ëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.', true);
      hideProgress();
      return;
    }

    // ì°¨ì› ëª©ë¡ ê²°ì • (ëª¨ë“  ì„¸ì…˜ì—ì„œ ê³µí†µ)
    const allDims = new Set();
    for (const m of availableMonths) {
      if (sessionIds.includes(m.sessionId)) {
        for (const d of m.dimensions) allDims.add(d);
      }
    }
    const dims = [...allDims];
    if (dims.length === 0) {
      setConvexStatus('ì„¸ì…˜ì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.', true);
      hideProgress();
      return;
    }

    setProgress(50, 'ë¶„ì„ ê²°ê³¼ ê³„ì‚° ì¤‘...');

    const defaultDim = dims[0];
    const result = await convexCall('query', 'queryData:getPercentageDistribution', {
      sessionIds,
      dimension: defaultDim,
      aggregationLevel: 'L2',
      metric: 'paymentAmount',
      excludeUnknown: true,
    });

    let attrValues = DIMENSIONS[defaultDim].filter(a => a !== UNKNOWN_VALUE);
    const localData = result.map(r => {
      const row = { category: r.category, 'í•©ê³„': r.total };
      for (const d of r.distribution) {
        row[d.attributeValue] = d.percentage;
        row[`${d.attributeValue}_abs`] = d.absoluteValue;
      }
      return row;
    });

    currentResult = {
      dimension: defaultDim, level: 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)', metric: 'ê²°ì œê¸ˆì•¡',
      excludeUnknown: true, data: localData, attrValues,
      fromConvex: true, sessionIds,
    };

    // UI ì—…ë°ì´íŠ¸
    document.getElementById('controlsCard').classList.remove('hidden');
    document.getElementById('selDimension').innerHTML = dims.map(d => `<option value="${d}">${d}</option>`).join('');

    // ìƒíƒœ ì¹´ë“œ ì—…ë°ì´íŠ¸
    for (const dim of dims) {
      const el = document.getElementById(`status-${dim}`);
      el.className = 'status-card loaded';
      el.innerHTML = `
        <div class="dim-name">${dim} â€” DB (${periodLabel})</div>
        <div class="dim-info">${sessionIds.length}ê°œ ì„¸ì…˜ í†µí•©</div>
      `;
    }

    document.getElementById('resultsCard').classList.remove('hidden');
    searchTerm = '';
    renderMetrics();
    renderCurrentTab();

    setProgress(100, 'ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
    setConvexStatus(`${periodLabel} ë¡œë“œ ì™„ë£Œ (${dims.join(', ')})`, false);
    setTimeout(hideProgress, 2000);

    // ìë™ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
    setTimeout(() => navigateTo('p-category'), 500);
  } catch (err) {
    setConvexStatus('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + err.message, true);
    console.error('Convex load error:', err);
    hideProgress();
  }
}

// runAnalysisë¥¼ Convex ëª¨ë“œì—ì„œë„ ë™ì‘í•˜ë„ë¡ í™•ì¥
const _originalRunAnalysis = runAnalysis;
runAnalysis = function() {
  if (currentResult && currentResult.fromConvex && currentResult.sessionIds) {
    const dimension = document.getElementById('selDimension').value;
    const level = document.getElementById('selLevel').value;
    const excludeUnknown = document.getElementById('chkExcludeUnknown').checked;
    const levelMap = { 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)': 'L1', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)': 'L2', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)': 'L3', 'ìƒí’ˆ': 'product' };
    const metricMap = { 'ê²°ì œê¸ˆì•¡': 'paymentAmount', 'ê²°ì œìˆ˜': 'paymentCount', 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰': 'paymentQuantity' };

    convexCall('query', 'queryData:getPercentageDistribution', {
      sessionIds: currentResult.sessionIds, dimension,
      aggregationLevel: levelMap[level] || 'L2',
      metric: metricMap[currentMetric] || 'paymentAmount',
      excludeUnknown,
    }).then(result => {
      let attrValues = DIMENSIONS[dimension].slice();
      if (excludeUnknown) attrValues = attrValues.filter(a => a !== UNKNOWN_VALUE);
      const localData = result.map(r => {
        const row = { category: r.category, 'í•©ê³„': r.total };
        for (const d of r.distribution) { row[d.attributeValue] = d.percentage; row[`${d.attributeValue}_abs`] = d.absoluteValue; }
        return row;
      });
      currentResult = {
        dimension, level, metric: currentMetric, excludeUnknown,
        data: localData, attrValues,
        fromConvex: true, sessionIds: currentResult.sessionIds,
      };
      document.getElementById('resultsCard').classList.remove('hidden');
      renderMetrics();
      renderCurrentTab();
    }).catch(err => {
      setConvexStatus('ë¶„ì„ ì‹¤íŒ¨: ' + err.message, true);
    });
    return;
  }
  _originalRunAnalysis();
};

// ì—…ë¡œë“œ í›„ DB ì €ì¥ ë²„íŠ¼ í‘œì‹œ ë¡œì§ í™•ì¥
const _originalUpdateStatus = updateStatus;
updateStatus = function() {
  _originalUpdateStatus();
  document.getElementById('btnSaveConvex').classList.toggle('hidden', Object.keys(profileData).length === 0);
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Sidebar Navigation
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentPage = 'p-upload';

function navigateTo(pageId) {
  // Hide all pages
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  // Show target
  const target = document.getElementById('page-' + pageId);
  if (target) target.classList.remove('hidden');

  // Update sidebar active state
  document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
  const items = document.querySelectorAll('.sidebar-item');
  items.forEach(item => {
    if (item.getAttribute('onclick')?.includes(`'${pageId}'`)) item.classList.add('active');
  });

  currentPage = pageId;

  // Trigger data refresh on certain pages
  if (pageId === 'p-category') {
    if (!currentResult && Object.keys(profileData).length === 0) {
      document.getElementById('noDataCard').classList.remove('hidden');
    } else {
      document.getElementById('noDataCard').classList.add('hidden');
    }
  }
  if (pageId === 'p-product') {
    renderProductDetailView();
  }
  if (pageId === 'r-upload') refreshReviewSessions();
  if (pageId === 'r-reviews') {
    if (reviewData.length > 0) {
      document.getElementById('reviewControlCard').classList.remove('hidden');
      document.getElementById('reviewResultCard').classList.remove('hidden');
      renderReviewSummary();
      renderReviewList();
    }
  }
  if (pageId === 'r-keywords') renderKeywords();
  if (pageId === 'r-negative') renderNegativeReviews();
}

// ìƒí’ˆë³„ ìƒì„¸ ë·° (ê²€ìƒ‰ + í…Œì´ë¸”)
function renderProductDetailView() {
  if (!currentResult) {
    document.getElementById('productDetailTable').innerHTML = '<div class="info-box">ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ DBì—ì„œ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.</div>';
    return;
  }
  // Use "ìƒí’ˆ" level data
  const dimension = document.getElementById('selDimension')?.value || currentResult.dimension;
  const excludeUnknown = document.getElementById('chkExcludeUnknown')?.checked ?? true;

  if (currentResult.fromConvex && currentResult.sessionIds) {
    const levelMap = { 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ëŒ€)': 'L1', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì¤‘)': 'L2', 'ìƒí’ˆì¹´í…Œê³ ë¦¬(ì†Œ)': 'L3', 'ìƒí’ˆ': 'product' };
    const metricMap = { 'ê²°ì œê¸ˆì•¡': 'paymentAmount', 'ê²°ì œìˆ˜': 'paymentCount', 'ê²°ì œìƒí’ˆìˆ˜ëŸ‰': 'paymentQuantity' };
    convexCall('query', 'queryData:getPercentageDistribution', {
      sessionIds: currentResult.sessionIds, dimension,
      aggregationLevel: 'product',
      metric: metricMap[currentMetric] || 'paymentAmount',
      excludeUnknown,
    }).then(result => {
      let attrValues = DIMENSIONS[dimension].slice();
      if (excludeUnknown) attrValues = attrValues.filter(a => a !== UNKNOWN_VALUE);
      const data = result.map(r => {
        const row = { category: r.category, 'í•©ê³„': r.total };
        for (const d of r.distribution) { row[d.attributeValue] = d.percentage; row[`${d.attributeValue}_abs`] = d.absoluteValue; }
        return row;
      });
      renderProductTable(data, attrValues);
    });
  } else if (profileData[dimension]) {
    const df = profileData[dimension].df;
    const data = computePercentageDistribution(df, 'ìƒí’ˆ', currentMetric, excludeUnknown);
    let attrValues = DIMENSIONS[dimension].slice();
    if (excludeUnknown) attrValues = attrValues.filter(a => a !== UNKNOWN_VALUE);
    renderProductTable(data, attrValues);
  }
}

function renderProductTable(data, attrValues) {
  const search = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
  const filtered = search ? data.filter(r => (r.category||'').toLowerCase().includes(search)) : data;
  const showAbs = document.getElementById('chkShowAbsolute')?.checked;

  let html = `<div style="font-size:12px; color:var(--gray-500); margin-bottom:8px;">${filtered.length}/${data.length}ê°œ ìƒí’ˆ</div>`;
  html += '<table><thead><tr><th>ìƒí’ˆëª…</th>';
  for (const a of attrValues) html += `<th>${a}</th>`;
  html += '<th>í•©ê³„</th></tr></thead><tbody>';
  for (const row of filtered.slice(0, 100)) {
    html += `<tr><td>${row.category}</td>`;
    let maxPct = -1, maxAttr = '';
    for (const a of attrValues) { if ((row[a]||0) > maxPct) { maxPct = row[a]||0; maxAttr = a; } }
    for (const a of attrValues) {
      const pct = row[a]||0, abs = row[`${a}_abs`]||0;
      const isMax = a === maxAttr && maxPct > 0 ? ' class="max-val"' : '';
      html += `<td${isMax}>${showAbs ? `${pct.toFixed(1)}% (${abs.toLocaleString()})` : `${pct.toFixed(1)}%`}</td>`;
    }
    html += `<td style="font-weight:600;">${(row['í•©ê³„']||0).toLocaleString()}</td></tr>`;
  }
  if (filtered.length > 100) html += `<tr><td colspan="${attrValues.length + 2}" style="text-align:center; color:var(--gray-500);">... ì™¸ ${filtered.length - 100}ê°œ ìƒí’ˆ</td></tr>`;
  html += '</tbody></table>';
  document.getElementById('productDetailTable').innerHTML = html;
}

// showControls í™•ì¥: ì¹´í…Œê³ ë¦¬ ê²°ê³¼ í˜ì´ì§€ì—ì„œë„ ë³´ì´ë„ë¡
const _origShowControls = showControls;
showControls = function() {
  _origShowControls();
  if (currentPage === 'p-upload') navigateTo('p-category');
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review Analysis - State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let reviewData = [];         // ì „ì²´ ë¦¬ë·° ë°°ì—´ (ëˆ„ì )
let reviewProducts = {};     // { ìƒí’ˆë²ˆí˜¸: { name, category, count } }
let reviewCategories = [];   // ì¹´í…Œê³ ë¦¬ ëª©ë¡
let selectedProductIds = []; // ì„ íƒëœ ìƒí’ˆë²ˆí˜¸
let selectedCategory = '__ALL__';
let reviewTypeFilter = 'all';
let reviewPage = 1;
const REVIEWS_PER_PAGE = 20;
let negativePage = 1;
let keywordChartInstance = null;
let pendingReviewFile = null; // íŒŒì‹±ëœ íŒŒì¼ (Convex ì €ì¥ ëŒ€ê¸°)

// ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ íŒ¨í„´ (ìƒí’ˆëª…ì—ì„œ ì¹´í…Œê³ ë¦¬ ìë™ ì¶”ì¶œ)
const CATEGORY_PATTERNS = [
  { pattern: /ì±…ìƒ/, category: 'ì±…ìƒ' },
  { pattern: /í…Œì´ë¸”/, category: 'í…Œì´ë¸”' },
  { pattern: /ì±…ì¥/, category: 'ì±…ì¥' },
  { pattern: /ì„ ë°˜/, category: 'ì„ ë°˜ì¥' },
  { pattern: /ì„œë/, category: 'ì„œëì¥' },
  { pattern: /ì˜ì|ì²´ì–´/, category: 'ì˜ì' },
  { pattern: /ìˆ˜ë‚©|ìºë¹„ë‹›/, category: 'ìˆ˜ë‚©ì¥' },
  { pattern: /í–‰ê±°|ì˜·ê±¸ì´/, category: 'í–‰ê±°' },
  { pattern: /ê±°ìš¸/, category: 'ê±°ìš¸' },
  { pattern: /ì¹¨ëŒ€|ë§¤íŠ¸ë¦¬ìŠ¤/, category: 'ì¹¨ëŒ€' },
  { pattern: /ì†ŒíŒŒ/, category: 'ì†ŒíŒŒ' },
  { pattern: /ëª¨ë‹ˆí„°ë°›ì¹¨|ë°›ì¹¨ëŒ€/, category: 'ëª¨ë‹ˆí„°ë°›ì¹¨ëŒ€' },
  { pattern: /íŒŒí‹°ì…˜|ê°€ë¦¼ë§‰/, category: 'íŒŒí‹°ì…˜' },
  { pattern: /ì¡°ëª…|ìŠ¤íƒ ë“œ/, category: 'ì¡°ëª…' },
];

function detectCategory(productName) {
  for (const { pattern, category } of CATEGORY_PATTERNS) {
    if (pattern.test(productName)) return category;
  }
  return 'ê¸°íƒ€';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì˜ë¯¸ í‚¤ì›Œë“œ ì‚¬ì „ (ì‚¬ìš©ë§¥ë½ + í’ˆì§ˆí‰ê°€)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KEYWORD_DICT = {
  'ëˆ„ê°€ (ì‚¬ìš©ì)': [
    'ì•„ì´','ì•„ì´ë“¤','ìë…€','ì•„ë“¤','ë”¸','7ì„¸','6ì‚´','ì´ˆë“±','ì¤‘í•™êµ','ìœ ì¹˜ì›',
    'ê°€ì¡±','ì„¸ì‹êµ¬','3ì¸ê°€ì¡±','5ì¸ê°€ì¡±','4ì¸ê°€ì¡±',
    '1ì¸ê°€êµ¬','í˜¼ì',
    'ë¶€ë¶€','ì™€ì´í”„','ë‚¨í¸','ì•„ë‚´',
    'ì¬íƒê·¼ë¬´','ì‚¬ë¬´ì‹¤','íšŒì‚¬','ì§ì¥ì¸',
  ],
  'ì–´ë””ì„œ (ì„¤ì¹˜ ì¥ì†Œ)': [
    'ê±°ì‹¤','ê±°ì‹¤í…Œì´ë¸”','ê±°ì‹¤ì„œì¬','ê±°ì‹¤ê³µë¶€',
    'ì„œì¬','ê³µë¶€ë°©','ì„œì¬ë°©',
    'ì‚¬ë¬´ì‹¤','íšŒì˜ì‹¤','ë¯¸íŒ…ë£¸',
    'ì•„ì´ë°©','ì•„ë“¤ë°©','ë”¸ë°©',
    'ì£¼ë°©','ì‹íƒ ëŒ€ì‹ ','ì‹íƒ ëŒ€ìš©',
    'ê³µê°„ëŒ€ì—¬ë£¸','ìˆ˜ì—…ìš©','ì¹´í˜',
  ],
  'ì–´ë–»ê²Œ (ì‚¬ìš© ë°©ì‹)': [
    'ê³µë¶€','í•™ìŠµ','ë…ì„œ','ì±…ì½ê¸°','ì›Œí¬ë¶',
    'ì‹íƒ ê²¸','ì‹ì‚¬','ë°¥','ì‹íƒìœ¼ë¡œ',
    'ì¬íƒê·¼ë¬´','ì»´í“¨í„°','ë…¸íŠ¸ë¶','ëª¨ë‹ˆí„°','ì—…ë¬´',
    'ë‹¤ìš©ë„','ê²¸ìš©','ì‘ì—…ëŒ€',
    'ë¯¸ìˆ ë†€ì´','ë¸”ëŸ­ë†€ì´','ê·¸ë¦¼','ìƒ‰ì—°í•„',
    'ë³´ë“œê²Œì„',
    'ì†ë‹˜','8ì¸','ì‹ì‚¬ ê°€ëŠ¥',
  ],
  'ì™œ (êµ¬ë§¤ ì´ìœ )': [
    'ê±°ì‹¤ì„œì¬','ì†ŒíŒŒ ì¹˜ìš°ê³ ','ê±°ì‹¤ ê³µë¶€ë°©',
    'ì…í•™','ì´ˆë“±','ì»¤ì„œ','ì„±ì¥',
    'ì´ì‚¬','ìƒˆì§‘',
    'ë°”ê¿¨ì–´ìš”','êµì²´','ì´ì¼€ì•„',
    'ì‹íƒ ëŒ€ì‹ ',
    'ì¬êµ¬ë§¤','ë‘ê°œì§¸','ë˜ ìƒ€ì–´ìš”','5ê°œì§¸',
    'ê°€ì„±ë¹„','ì €ë ´','ê°€ê²©ëŒ€ë¹„','í• ì¸',
    'ì¶”ì²œë°›ì•„','ë§¤ì¥ì—ì„œ ë³´ê³ ','ë°±í™”ì ',
  ],
  'ë§Œì¡± ì´ìœ ': [
    'ê²¬ê³ ','íŠ¼íŠ¼','ì§±ì§±','ë¬µì§','í”ë“¤ë¦¼ì—†ìŒ','í”ë“¤ë¦¼ ì—†',
    'ë„“ì–´ì„œ','ë„‰ë„‰','ì—¬ìœ ','í¬ê¸° ë§Œì¡±',
    'ê¹”ë”','ì„¸ë ¨','êµ°ë”ë”ê¸°ì—†ëŠ”','ì‹¬í”Œ',
    'ì˜ ë‹¦ì—¬','ì˜ ì§€ì›Œì ¸','ì½”íŒ…','ê¹€ì¹˜êµ­ë¬¼',
    'í™”ì´íŠ¸','ë°ì•„ì„œ','í™˜í•´ì¡Œì–´ìš”',
    'ì„¤ì¹˜ê¸°ì‚¬ ì¹œì ˆ','ë¹ ë¥¸ì„¤ì¹˜','5ë¶„ ì„¤ì¹˜','ë¹ ë¥¸ ì„¤ì¹˜',
    'ë°°ì†¡ ë¹ ë¥´ê³ ','ë¹ ë¥¸ë°°ì†¡','ë¹ ë¥¸ ë°°ì†¡',
    'ê°€ì„±ë¹„','ì´ ê°€ê²©ì—',
  ],
  'ë¶ˆë§Œì¡± ì´ìœ ': [
    'ì–¼ë£©','ì´ì—¼','ìêµ­','íŒŒì—¬ìˆìŒ','ìŠ¤í¬ë˜ì¹˜',
    'ë°°ì†¡ ëŠ¦ì–´','3ì£¼ ê¸°ë‹¤ë¦¼','í•œë‹¬ ê¸°ë‹¤ë¦¼','ë°°ì†¡ ì§€ì—°',
    'ì§€ë¬¸','ì†ìêµ­','ë¸”ë™ ì§€ë¬¸',
    'ëª¨ì„œë¦¬ ì§ê°','ì•„ì´ ìœ„í—˜',
    'ë†’ì´ ë‚®ê²Œ','ì–´ë¥¸ë“¤ì€ ë‚®',
    'ê¸°ì‚¬ë‹˜ ë¶ˆì¹œì ˆ','ë‹´ë°°ëƒ„ìƒˆ','ë‹´ë°° ëƒ„ìƒˆ',
    'êµí™˜ ë²ˆê±°ë¡œì›€','AS ëŠ¦ìŒ','ê³ ê°ì„¼í„°',
    'ì½˜ì„¼íŠ¸ ìœ„ì¹˜ ì¤‘ì•™','ì½”ë“œ ì§§ìŒ',
    'ì§„ë™','ìƒíŒ ì–‡ì•„ì„œ',
    'ë„ˆë¬´ í¼','ë„ˆë¬´ ì‘ìŒ','30í‰ëŒ€ í¼',
    'ë¶ˆí¸','ì‹¤ë§','ë³„ë¡œ',
  ],
};

// ë¶ˆìš©ì–´ (ì¸ì‚¬ì´íŠ¸ ì—†ìŒ)
const REVIEW_STOPWORDS = new Set([
  'ì¢‹ì•„ìš”','ë§Œì¡±í•©ë‹ˆë‹¤','ì˜ ìƒ€ì–´ìš”','ì¶”ì²œí•©ë‹ˆë‹¤','ê°ì‚¬í•©ë‹ˆë‹¤','ì˜ ë°›ì•˜ìŠµë‹ˆë‹¤',
  'ì˜ ì‚¬ìš©ì¤‘','ë§˜ì—ë“¤ì–´ìš”','ì¢‹ìŠµë‹ˆë‹¤','ìµœê³ ','êµ¿','ëŒ€ë§Œì¡±','ê°•ì¶”','ì˜ì“°ê³ ìˆì–´ìš”',
  'ì¢‹ì€','ì¢‹ì•„','ì¢‹ê³ ','ì¢‹ìŠµë‹ˆë‹¤','ì¢‹ì•„ìš”','ìˆì–´','ìˆê³ ','ìˆìŠµë‹ˆë‹¤','í•´ì„œ','í•˜ê³ ',
  'í–ˆëŠ”ë°','ì¸ë°','ì—ìš”','êµ¬ë§¤','ì‚¬ìš©','ì œí’ˆ','ìƒí’ˆ','ë°°ì†¡','ì£¼ë¬¸','êµ¬ì…','ë„¤ì´ë²„',
  'ìŠ¤í† ì–´','ë¦¬ë·°','ì´ê±°','ì €ê±°','ê·¸ê±°','í•©ë‹ˆë‹¤','ì…ë‹ˆë‹¤','ìˆëŠ”','ì—†ëŠ”','í•˜ëŠ”',
]);

// í‚¤ì›Œë“œ â†’ ì¹´í…Œê³ ë¦¬ ë§¤í•‘ (ê¸´ í‚¤ì›Œë“œë¶€í„° ë§¤ì¹­í•˜ë„ë¡ ì •ë ¬)
const KEYWORD_TO_CATEGORY = {};
const SORTED_KEYWORDS = []; // ê¸´ ê²ƒë¶€í„° ë§¤ì¹­ (ë³µí•©í‚¤ì›Œë“œ ìš°ì„ )
for (const [cat, words] of Object.entries(KEYWORD_DICT)) {
  for (const w of words) {
    KEYWORD_TO_CATEGORY[w] = cat;
    SORTED_KEYWORDS.push(w);
  }
}
SORTED_KEYWORDS.sort((a, b) => b.length - a.length); // ê¸´ í‚¤ì›Œë“œë¶€í„° ë§¤ì¹­

// ë¶€ì • í‘œí˜„ íŒ¨í„´
const NEGATION_PATTERNS = [/ì•Šì€/, /ì•Šì•„/, /ì•Šë‹¤/, /ì—†ëŠ”/, /ì—†ì–´/, /ëª»í•œ/, /ì•ˆ /];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - File Upload
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const reviewUploadArea = document.getElementById('reviewUploadArea');
const reviewFileInput = document.getElementById('reviewFileInput');

reviewUploadArea.addEventListener('click', () => reviewFileInput.click());
reviewUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); reviewUploadArea.classList.add('dragover'); });
reviewUploadArea.addEventListener('dragleave', () => reviewUploadArea.classList.remove('dragover'));
reviewUploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  reviewUploadArea.classList.remove('dragover');
  if (e.dataTransfer.files.length) handleReviewFile(e.dataTransfer.files[0]);
});
reviewFileInput.addEventListener('change', (e) => {
  if (e.target.files.length) handleReviewFile(e.target.files[0]);
});

function parseReviewRows(rows) {
  const cols = Object.keys(rows[0]);
  const colMap = {
    productId:  cols.find(c => c.includes('ìƒí’ˆë²ˆí˜¸')) || 'ìƒí’ˆë²ˆí˜¸',
    productName: cols.find(c => c === 'ìƒí’ˆëª…' || c.includes('ìƒí’ˆëª…')) || 'ìƒí’ˆëª…',
    reviewType: cols.find(c => c.includes('ë¦¬ë·°êµ¬ë¶„') || c.includes('êµ¬ë¶„')) || 'ë¦¬ë·°êµ¬ë¶„',
    rating:     cols.find(c => c.includes('êµ¬ë§¤ìí‰ì ') || c.includes('í‰ì ')) || 'êµ¬ë§¤ìí‰ì ',
    hasPhoto:   cols.find(c => c.includes('í¬í† ') || c.includes('ì˜ìƒ')) || 'í¬í† ì˜ìƒ',
    content:    cols.find(c => c.includes('ë¦¬ë·°ìƒì„¸') || c.includes('ë‚´ìš©')) || 'ë¦¬ë·°ìƒì„¸ë‚´ìš©',
    helpful:    cols.find(c => c.includes('ë„ì›€ìˆ˜') || c.includes('ë„ì›€')) || 'ë¦¬ë·°ë„ì›€ìˆ˜',
    author:     cols.find(c => c.includes('ë“±ë¡ì') || c.includes('ì‘ì„±ì')) || 'ë“±ë¡ì',
    date:       cols.find(c => c.includes('ë¦¬ë·°ë“±ë¡ì¼') || c.includes('ë“±ë¡ì¼')) || 'ë¦¬ë·°ë“±ë¡ì¼',
    isBest:     cols.find(c => c.includes('ë² ìŠ¤íŠ¸') || c.includes('BEST')) || 'ë² ìŠ¤íŠ¸ë¦¬ë·°',
    photoUrls:  cols.find(c => c.includes('ë¦¬ë·°ì´ë¯¸ì§€') || c.includes('ì´ë¯¸ì§€URL') || c.includes('ì´ë¯¸ì§€')) || null,
  };

  const parsed = [];
  for (const row of rows) {
    const pid = String(row[colMap.productId] || '').trim();
    if (!pid) continue;
    const pname = String(row[colMap.productName] || '').trim();
    const ratingRaw = row[colMap.rating];
    const rating = typeof ratingRaw === 'number' ? ratingRaw : parseInt(ratingRaw) || 0;
    const content = String(row[colMap.content] || '').trim();
    const dateRaw = row[colMap.date];
    let dateStr = '';
    if (typeof dateRaw === 'number') {
      const d = XLSX.SSF.parse_date_code(dateRaw);
      if (d) dateStr = `${d.y}-${String(d.m).padStart(2,'0')}-${String(d.d).padStart(2,'0')}`;
    } else {
      dateStr = String(dateRaw || '').trim();
    }
    const reviewType = String(row[colMap.reviewType] || '').trim();
    const isMonth = reviewType.includes('í•œë‹¬');
    const hasPhotoRaw = String(row[colMap.hasPhoto] || '').trim();
    const hasPhoto = hasPhotoRaw === 'Y' || hasPhotoRaw === 'ìˆìŒ' || hasPhotoRaw.includes('í¬í† ');
    const isBestRaw = String(row[colMap.isBest] || '').trim();
    const isBest = isBestRaw === 'Y' || isBestRaw === 'ìˆìŒ' || isBestRaw.includes('ë² ìŠ¤íŠ¸');
    const helpful = parseInt(row[colMap.helpful]) || 0;
    const author = String(row[colMap.author] || '').trim();
    let photos = [];
    if (colMap.photoUrls && row[colMap.photoUrls]) {
      const urlStr = String(row[colMap.photoUrls]).trim();
      if (urlStr) photos = urlStr.split(/[,|]/).map(u => u.trim()).filter(u => u.startsWith('http'));
    }
    const category = detectCategory(pname);
    parsed.push({
      productId: pid, productName: pname, category, rating, content, date: dateStr,
      reviewType, isMonth, hasPhoto, isBest, helpful, author, photos,
    });
  }
  return parsed;
}

function mergeReviews(newReviews) {
  // ì¤‘ë³µ ë°©ì§€: productId + date + author ì¡°í•©ìœ¼ë¡œ ì²´í¬
  const existingKeys = new Set(reviewData.map(r => `${r.productId}|${r.date}|${r.author}`));
  let added = 0;
  for (const r of newReviews) {
    const key = `${r.productId}|${r.date}|${r.author}`;
    if (!existingKeys.has(key)) {
      reviewData.push(r);
      existingKeys.add(key);
      added++;
    }
  }
  rebuildReviewIndex();
  return added;
}

function rebuildReviewIndex() {
  reviewProducts = {};
  for (const r of reviewData) {
    if (!reviewProducts[r.productId]) {
      reviewProducts[r.productId] = { name: r.productName, category: r.category, count: 0 };
    }
    reviewProducts[r.productId].count++;
  }
  // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê°±ì‹ 
  const catCounts = {};
  for (const r of reviewData) {
    catCounts[r.category] = (catCounts[r.category] || 0) + 1;
  }
  reviewCategories = Object.entries(catCounts)
    .sort((a, b) => b[1] - a[1])
    .map(([cat, cnt]) => ({ category: cat, count: cnt }));
  updateCategoryDropdown();
}

function updateCategoryDropdown() {
  const sel = document.getElementById('reviewCategoryFilter');
  const prev = sel.value;
  sel.innerHTML = '<option value="__ALL__">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>' +
    reviewCategories.map(c => `<option value="${c.category}">${c.category} (${c.count.toLocaleString()})</option>`).join('');
  sel.value = prev || '__ALL__';
}

function handleReviewFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    if (!rows.length) { alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

    const parsed = parseReviewRows(rows);
    pendingReviewFile = { filename: file.name, reviews: parsed };
    const added = mergeReviews(parsed);

    // Update UI
    document.getElementById('reviewUploadStatus').classList.remove('hidden');
    document.getElementById('reviewFileName').textContent = file.name;
    document.getElementById('reviewRowCount').textContent = `${parsed.length.toLocaleString()}ê°œ ë¦¬ë·° (ì‹ ê·œ ${added})`;
    document.getElementById('reviewProductCount').textContent = `ëˆ„ì  ${reviewData.length.toLocaleString()}ê°œ / ${Object.keys(reviewProducts).length}ê°œ ìƒí’ˆ`;
    document.getElementById('btnSaveReview').classList.remove('hidden');

    // Show controls
    document.getElementById('reviewControlCard').classList.remove('hidden');
    document.getElementById('reviewResultCard').classList.remove('hidden');

    selectedProductIds = [];
    filterReviewProducts();
    renderReviewSummary();
    renderReviewList();

    // ìë™ìœ¼ë¡œ ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
    setTimeout(() => navigateTo('r-reviews'), 300);
  };
  reader.readAsArrayBuffer(file);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - Convex Save/Load
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setReviewConvexStatus(msg, isError) {
  const el = document.getElementById('reviewConvexStatus');
  el.textContent = msg;
  el.style.color = isError ? 'var(--danger)' : 'var(--gray-500)';
}

async function refreshReviewSessions() {
  try {
    const sessions = await convexCall('query', 'queryData:listReviewSessions', {});
    const listEl = document.getElementById('reviewSessionList');
    if (!sessions.length) {
      listEl.innerHTML = '<span style="color:var(--gray-500);">ì €ì¥ëœ ë°ì´í„° ì—†ìŒ</span>';
      return;
    }
    listEl.innerHTML = sessions.map(s => {
      const date = new Date(s.uploadedAt).toLocaleString('ko-KR');
      return `<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid var(--gray-100);">
        <span>${s.filename} â€” ${s.rowCount.toLocaleString()}ê±´, ${s.productCount}ê°œ ìƒí’ˆ</span>
        <span style="font-size:11px; color:var(--gray-500);">${date}</span>
      </div>`;
    }).join('');
  } catch (err) {
    setReviewConvexStatus('ì„¸ì…˜ ì¡°íšŒ ì‹¤íŒ¨: ' + err.message, true);
  }
}

async function saveReviewToConvex() {
  if (!pendingReviewFile) { alert('ì €ì¥í•  íŒŒì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const { filename, reviews } = pendingReviewFile;
  const productIds = new Set(reviews.map(r => r.productId));

  const progEl = document.getElementById('reviewConvexProgress');
  const barEl = document.getElementById('reviewProgressBar');
  const textEl = document.getElementById('reviewProgressText');
  progEl.classList.remove('hidden');
  barEl.style.width = '0%';
  textEl.textContent = 'ì„¸ì…˜ ìƒì„± ì¤‘...';

  try {
    const sessionId = await convexCall('mutation', 'uploadData:createReviewSession', {
      filename, rowCount: reviews.length, productCount: productIds.size,
    });

    // ë°°ì¹˜ ì‚½ì… (100ê°œì”©)
    const BATCH = 100;
    const total = reviews.length;
    for (let i = 0; i < total; i += BATCH) {
      const batch = reviews.slice(i, i + BATCH).map(r => ({
        sessionId,
        productId: r.productId,
        productName: r.productName,
        category: r.category,
        rating: r.rating,
        content: r.content,
        date: r.date,
        reviewType: r.reviewType,
        isMonth: r.isMonth,
        hasPhoto: r.hasPhoto,
        isBest: r.isBest,
        helpful: r.helpful,
        author: r.author,
        photos: r.photos,
      }));
      await convexCall('mutation', 'uploadData:insertReviews', { reviews: batch });
      const pct = Math.round(((i + batch.length) / total) * 100);
      barEl.style.width = pct + '%';
      textEl.textContent = `ì €ì¥ ì¤‘... ${Math.min(i + BATCH, total).toLocaleString()} / ${total.toLocaleString()}`;
    }

    barEl.style.width = '100%';
    textEl.textContent = 'ì™„ë£Œ!';
    setReviewConvexStatus(`${filename} â€” ${total.toLocaleString()}ê±´ ì €ì¥ ì™„ë£Œ`, false);
    pendingReviewFile = null;
    document.getElementById('btnSaveReview').classList.add('hidden');
    setTimeout(() => progEl.classList.add('hidden'), 2000);
    refreshReviewSessions();
  } catch (err) {
    setReviewConvexStatus('ì €ì¥ ì‹¤íŒ¨: ' + err.message, true);
    progEl.classList.add('hidden');
  }
}

async function loadAllReviewsFromConvex() {
  setReviewConvexStatus('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', false);
  try {
    const sessions = await convexCall('query', 'queryData:listReviewSessions', {});
    if (!sessions.length) { setReviewConvexStatus('ì €ì¥ëœ ë°ì´í„° ì—†ìŒ', false); return; }

    const sessionIds = sessions.map(s => s._id);
    const allReviews = await convexCall('query', 'queryData:getReviews', { sessionIds });

    // ë©”ëª¨ë¦¬ì— ëˆ„ì  ë¡œë“œ
    reviewData = [];
    for (const r of allReviews) {
      reviewData.push({
        productId: r.productId, productName: r.productName, category: r.category,
        rating: r.rating, content: r.content, date: r.date,
        reviewType: r.reviewType, isMonth: r.isMonth, hasPhoto: r.hasPhoto,
        isBest: r.isBest, helpful: r.helpful, author: r.author, photos: r.photos,
      });
    }
    rebuildReviewIndex();

    const totalRows = sessions.reduce((s, x) => s + x.rowCount, 0);
    setReviewConvexStatus(`${sessions.length}ê°œ ì„¸ì…˜ì—ì„œ ${reviewData.length.toLocaleString()}ê±´ ë¡œë“œ ì™„ë£Œ`, false);

    document.getElementById('reviewUploadStatus').classList.remove('hidden');
    document.getElementById('reviewFileName').textContent = 'Convex DB (ëˆ„ì )';
    document.getElementById('reviewRowCount').textContent = `${reviewData.length.toLocaleString()}ê°œ ë¦¬ë·°`;
    document.getElementById('reviewProductCount').textContent = `${Object.keys(reviewProducts).length}ê°œ ìƒí’ˆ`;

    document.getElementById('reviewControlCard').classList.remove('hidden');
    document.getElementById('reviewResultCard').classList.remove('hidden');

    selectedProductIds = [];
    filterReviewProducts();
    renderReviewSummary();
    renderReviewList();

    // ìë™ìœ¼ë¡œ ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ì´ë™
    setTimeout(() => navigateTo('r-reviews'), 500);
  } catch (err) {
    setReviewConvexStatus('ë¡œë“œ ì‹¤íŒ¨: ' + err.message, true);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - Category Filter
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onCategoryFilterChange() {
  selectedCategory = document.getElementById('reviewCategoryFilter').value;
  selectedProductIds = [];
  filterReviewProducts();
  reviewPage = 1;
  renderReviewSummary();
  renderReviewList();
}

function clearProductSelection() {
  selectedProductIds = [];
  filterReviewProducts();
  reviewPage = 1;
  renderReviewSummary();
  renderReviewList();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - Product Filter
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterReviewProducts() {
  const search = (document.getElementById('reviewProductSearch').value || '').trim().toLowerCase();
  const listEl = document.getElementById('reviewProductList');
  const entries = Object.entries(reviewProducts)
    .filter(([pid, p]) => {
      if (selectedCategory !== '__ALL__' && p.category !== selectedCategory) return false;
      if (search && !pid.toLowerCase().includes(search) && !p.name.toLowerCase().includes(search)) return false;
      return true;
    })
    .sort((a, b) => b[1].count - a[1].count);

  document.getElementById('reviewFilteredCount').textContent = entries.length;

  const show = entries.slice(0, 200);
  listEl.innerHTML = show.map(([pid, p]) =>
    `<div class="product-item ${selectedProductIds.includes(pid) ? 'selected' : ''}" onclick="toggleReviewProduct('${pid}')" title="${p.name}">
      <span>${p.name} <span style="color:var(--gray-500); font-size:11px;">(${pid})</span></span>
      <span class="cnt" style="white-space:nowrap;">${p.count}ê±´</span>
    </div>`
  ).join('');
  if (entries.length > 200) {
    listEl.innerHTML += `<div style="padding:8px 12px; font-size:12px; color:var(--gray-500); text-align:center;">ì™¸ ${entries.length - 200}ê°œ ìƒí’ˆ...</div>`;
  }
  renderSelectedChips();
}

function renderSelectedChips() {
  const el = document.getElementById('selectedChips');
  if (!el) return;
  if (selectedProductIds.length === 0) {
    el.innerHTML = '<span style="font-size:12px; color:var(--gray-500);">ì„ íƒëœ ìƒí’ˆ ì—†ìŒ (ì „ì²´ ë¦¬ë·° í‘œì‹œ)</span>';
    return;
  }
  el.innerHTML = selectedProductIds.map(pid => {
    const p = reviewProducts[pid];
    const name = p ? p.name : pid;
    const short = name.length > 25 ? name.substring(0, 25) + '...' : name;
    return `<span class="chip" title="${name}">${short} <span class="chip-x" onclick="event.stopPropagation(); removeProductChip('${pid}')">Ã—</span></span>`;
  }).join('');
}

function removeProductChip(pid) {
  const idx = selectedProductIds.indexOf(pid);
  if (idx >= 0) selectedProductIds.splice(idx, 1);
  filterReviewProducts();
  reviewPage = 1;
  renderReviewSummary();
  renderReviewList();
}

function toggleReviewProduct(pid) {
  const idx = selectedProductIds.indexOf(pid);
  if (idx >= 0) selectedProductIds.splice(idx, 1);
  else selectedProductIds.push(pid);
  filterReviewProducts();
  reviewPage = 1;
  renderReviewSummary();
  renderReviewList();
}

function selectAllReviewProducts() {
  const search = (document.getElementById('reviewProductSearch').value || '').trim().toLowerCase();
  selectedProductIds = Object.entries(reviewProducts)
    .filter(([pid, p]) => {
      if (selectedCategory !== '__ALL__' && p.category !== selectedCategory) return false;
      if (search && !pid.toLowerCase().includes(search) && !p.name.toLowerCase().includes(search)) return false;
      return true;
    })
    .map(([pid]) => pid);
  filterReviewProducts();
  reviewPage = 1;
  renderReviewSummary();
  renderReviewList();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - Get Filtered Reviews
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFilteredReviews() {
  let reviews = reviewData;

  // Filter by category
  if (selectedCategory !== '__ALL__') {
    reviews = reviews.filter(r => r.category === selectedCategory);
  }

  // Filter by selected products
  if (selectedProductIds.length > 0) {
    const pidSet = new Set(selectedProductIds);
    reviews = reviews.filter(r => pidSet.has(r.productId));
  }

  // Filter by review type
  if (reviewTypeFilter === 'month') {
    reviews = reviews.filter(r => r.isMonth);
  } else if (reviewTypeFilter === 'general') {
    reviews = reviews.filter(r => !r.isMonth);
  }

  // Filter by rating
  const ratingFilter = document.getElementById('reviewRatingFilter')?.value;
  if (ratingFilter && ratingFilter !== 'all') {
    const rat = parseInt(ratingFilter);
    reviews = reviews.filter(r => r.rating === rat);
  }

  // Sort
  const sort = document.getElementById('reviewSort')?.value || 'date-desc';
  reviews.sort((a, b) => {
    switch (sort) {
      case 'date-desc': return (b.date || '').localeCompare(a.date || '');
      case 'date-asc': return (a.date || '').localeCompare(b.date || '');
      case 'rating-desc': return b.rating - a.rating;
      case 'rating-asc': return a.rating - b.rating;
      case 'helpful-desc': return b.helpful - a.helpful;
      default: return 0;
    }
  });

  return reviews;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - Type Filter
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectReviewType(el, type) {
  reviewTypeFilter = type;
  document.querySelectorAll('#reviewTypeGroup label').forEach(l => l.classList.remove('active'));
  el.classList.add('active');
  reviewPage = 1;
  renderReviewSummary();
  renderReviewList();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - Summary Metrics
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReviewSummary() {
  const reviews = getFilteredReviews();
  const totalCount = reviews.length;
  const avgRating = totalCount > 0 ? (reviews.reduce((s, r) => s + r.rating, 0) / totalCount).toFixed(1) : '-';
  const photoCount = reviews.filter(r => r.hasPhoto).length;
  const monthCount = reviews.filter(r => r.isMonth).length;
  const bestCount = reviews.filter(r => r.isBest).length;

  document.getElementById('reviewSummary').innerHTML = `
    <div class="summary-item"><div class="num">${totalCount.toLocaleString()}</div><div class="lbl">ë¦¬ë·° ìˆ˜</div></div>
    <div class="summary-item"><div class="num">${avgRating}</div><div class="lbl">í‰ê·  í‰ì </div></div>
    <div class="summary-item"><div class="num">${photoCount.toLocaleString()}</div><div class="lbl">í¬í†  ë¦¬ë·°</div></div>
    <div class="summary-item"><div class="num">${monthCount.toLocaleString()}</div><div class="lbl">í•œë‹¬ì‚¬ìš©</div></div>
    <div class="summary-item"><div class="num">${bestCount.toLocaleString()}</div><div class="lbl">ë² ìŠ¤íŠ¸</div></div>
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - List Rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReviewList() {
  const reviews = getFilteredReviews();
  const totalPages = Math.ceil(reviews.length / REVIEWS_PER_PAGE) || 1;
  if (reviewPage > totalPages) reviewPage = totalPages;
  const start = (reviewPage - 1) * REVIEWS_PER_PAGE;
  const pageReviews = reviews.slice(start, start + REVIEWS_PER_PAGE);

  const container = document.getElementById('reviewListContainer');
  if (pageReviews.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--gray-500);">í‘œì‹œí•  ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
    document.getElementById('reviewPagination').innerHTML = '';
    return;
  }

  container.innerHTML = pageReviews.map(r => {
    const stars = 'â˜…'.repeat(r.rating) + 'â˜†'.repeat(Math.max(0, 5 - r.rating));
    const badges = [];
    if (r.isMonth) badges.push('<span class="badge badge-month">í•œë‹¬ì‚¬ìš©</span>');
    if (r.isBest) badges.push('<span class="badge badge-best">ë² ìŠ¤íŠ¸</span>');
    if (r.hasPhoto) badges.push('<span class="badge badge-photo">í¬í† </span>');

    const photoHtml = r.photos.length > 0
      ? `<div class="review-photos">${r.photos.slice(0, 5).map(u => `<img src="${escapeHtml(u)}" alt="ë¦¬ë·° ì´ë¯¸ì§€" onclick="event.stopPropagation(); openImageModal('${escapeHtml(u)}')" onerror="this.style.display='none'">`).join('')}</div>`
      : '';

    return `<div class="review-item">
      <div class="review-header">
        <span class="stars">${stars}</span>
        ${badges.join(' ')}
        <span class="badge" style="background:var(--gray-100); color:var(--gray-700);">${r.category}</span>
      </div>
      <div class="review-product">${escapeHtml(r.productName)} (${r.productId})</div>
      <div class="review-body">${escapeHtml(r.content || '(ë‚´ìš© ì—†ìŒ)')}</div>
      ${photoHtml}
      <div class="review-meta">
        <span>${escapeHtml(r.author || 'ìµëª…')}</span>
        <span>${r.date || '-'}</span>
        ${r.helpful > 0 ? `<span>ë„ì›€ ${r.helpful}</span>` : ''}
      </div>
    </div>`;
  }).join('');

  renderPagination('reviewPagination', reviewPage, totalPages, (p) => { reviewPage = p; renderReviewList(); });
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function renderPagination(containerId, currentPage, totalPages, onPageClick) {
  const el = document.getElementById(containerId);
  if (totalPages <= 1) { el.innerHTML = ''; return; }

  let buttons = [];
  if (currentPage > 1) buttons.push(`<button onclick="void(0)" data-page="${currentPage - 1}">â—€</button>`);

  let startP = Math.max(1, currentPage - 3);
  let endP = Math.min(totalPages, startP + 6);
  if (endP - startP < 6) startP = Math.max(1, endP - 6);

  for (let p = startP; p <= endP; p++) {
    buttons.push(`<button class="${p === currentPage ? 'active' : ''}" onclick="void(0)" data-page="${p}">${p}</button>`);
  }

  if (currentPage < totalPages) buttons.push(`<button onclick="void(0)" data-page="${currentPage + 1}">â–¶</button>`);

  el.innerHTML = `<span style="font-size:12px; color:var(--gray-500); margin-right:8px;">${totalPages}í˜ì´ì§€ ì¤‘ ${currentPage}</span>` + buttons.join('');
  el.querySelectorAll('button[data-page]').forEach(btn => {
    btn.addEventListener('click', () => onPageClick(parseInt(btn.dataset.page)));
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - Keyword Analysis (ì˜ë¯¸ í‚¤ì›Œë“œ)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í‚¤ì›Œë“œ â†’ ë¦¬ë·° ë§¤í•‘ (ë“œë¦´ë‹¤ìš´ìš©)
let kwReviewMap = {}; // { í‚¤ì›Œë“œ: [review, ...] }
let kwDrilldownPage = 1;
const KW_DRILLDOWN_PER_PAGE = 10;

function renderKeywords() {
  const reviews = getFilteredReviews();
  const catFreq = {};
  for (const cat of Object.keys(KEYWORD_DICT)) catFreq[cat] = {};
  const allFreq = {};
  kwReviewMap = {};

  for (const r of reviews) {
    if (!r.content) continue;
    const text = r.content;
    const seen = new Set();

    for (const w of SORTED_KEYWORDS) {
      if (seen.has(w)) continue;
      const idx = text.indexOf(w);
      if (idx === -1) continue;

      const cat = KEYWORD_TO_CATEGORY[w];
      let finalCat = cat;
      if (cat === 'ë§Œì¡± ì´ìœ ') {
        const before = text.substring(Math.max(0, idx - 10), idx + w.length + 5);
        const isNegated = NEGATION_PATTERNS.some(p => p.test(before));
        if (isNegated) finalCat = 'ë¶ˆë§Œì¡± ì´ìœ ';
      }

      seen.add(w);
      if (!catFreq[finalCat]) catFreq[finalCat] = {};
      const displayKey = finalCat !== cat ? w + '(ë¶€ì •)' : w;
      catFreq[finalCat][displayKey] = (catFreq[finalCat][displayKey] || 0) + 1;
      allFreq[displayKey] = (allFreq[displayKey] || 0) + 1;

      // ë¦¬ë·° ë§¤í•‘ ì €ì¥
      if (!kwReviewMap[displayKey]) kwReviewMap[displayKey] = [];
      kwReviewMap[displayKey].push({ review: r, matchedKeyword: w });
    }
  }

  // ì¹´í…Œê³ ë¦¬ë³„ ì¹´ë“œ ë Œë”ë§
  const cardsEl = document.getElementById('keywordCategoryCards');
  const catColors = {
    'ëˆ„ê°€ (ì‚¬ìš©ì)': { bg: '#E8F5E9', color: '#2E7D32', bar: '#43A047' },
    'ì–´ë””ì„œ (ì„¤ì¹˜ ì¥ì†Œ)': { bg: '#E3F2FD', color: '#1565C0', bar: '#1E88E5' },
    'ì–´ë–»ê²Œ (ì‚¬ìš© ë°©ì‹)': { bg: '#FFF3E0', color: '#E65100', bar: '#FB8C00' },
    'ì™œ (êµ¬ë§¤ ì´ìœ )': { bg: '#F3E5F5', color: '#6A1B9A', bar: '#8E24AA' },
    'ë§Œì¡± ì´ìœ ': { bg: '#E8F5E9', color: '#1B5E20', bar: '#2E7D32' },
    'ë¶ˆë§Œì¡± ì´ìœ ': { bg: '#FFEBEE', color: '#B71C1C', bar: '#E53935' },
  };

  cardsEl.innerHTML = Object.entries(catFreq).map(([cat, freq]) => {
    const sorted = Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const maxF = sorted.length > 0 ? sorted[0][1] : 1;
    const style = catColors[cat] || { bg: '#F5F5F5', color: '#333', bar: '#999' };
    const totalMentions = Object.values(freq).reduce((s, v) => s + v, 0);

    return `<div style="border:1px solid var(--gray-200); border-radius:var(--radius); overflow:hidden;">
      <div style="background:${style.bg}; color:${style.color}; padding:12px 16px; font-weight:600; font-size:14px; display:flex; justify-content:space-between;">
        <span>${cat}</span>
        <span style="font-weight:400; font-size:12px;">${totalMentions.toLocaleString()}íšŒ ì–¸ê¸‰</span>
      </div>
      <div style="padding:12px 16px;">
        ${sorted.length === 0 ? '<div style="color:var(--gray-500); font-size:13px;">ë°ì´í„° ì—†ìŒ</div>' :
          sorted.map(([w, cnt]) =>
            `<div class="kw-row" onclick="openKwDrilldown('${escapeHtml(w)}')" title="í´ë¦­í•˜ì—¬ '${w}' ê´€ë ¨ ë¦¬ë·° ë³´ê¸°">
              <span style="min-width:60px; font-size:13px; font-weight:500;">${w}</span>
              <div style="flex:1; background:var(--gray-100); border-radius:3px; height:16px; overflow:hidden;">
                <div style="width:${Math.round(cnt / maxF * 100)}%; height:100%; background:${style.bar}; border-radius:3px;"></div>
              </div>
              <span style="min-width:40px; text-align:right; font-size:12px; color:var(--gray-500);">${cnt}</span>
              <span style="font-size:11px; color:var(--gray-500);">â–¸</span>
            </div>`
          ).join('')}
      </div>
    </div>`;
  }).join('');

  // í†µí•© í…Œì´ë¸” + ì°¨íŠ¸
  const allSorted = Object.entries(allFreq).sort((a, b) => b[1] - a[1]).slice(0, 50);
  const tableEl = document.getElementById('keywordTable');
  if (allSorted.length === 0) {
    tableEl.innerHTML = '<div style="padding:20px; text-align:center; color:var(--gray-500);">í‚¤ì›Œë“œ ë°ì´í„° ì—†ìŒ</div>';
  } else {
    const maxFreq = allSorted[0][1];
    const SHOW_INIT = 10;
    function buildKwRows(items) {
      return items.map(([word, cnt], i) => {
        const cleanWord = word.replace('(ë¶€ì •)', '');
        const cat = KEYWORD_TO_CATEGORY[cleanWord] || (word.includes('(ë¶€ì •)') ? 'ë¶ˆë§Œì¡± ì´ìœ ' : '');
        const shortCat = cat.split(' ')[0];
        return `<tr style="cursor:pointer;" onclick="openKwDrilldown('${escapeHtml(word)}')"><td>${i + 1}</td><td>${word}</td><td style="font-size:11px;">${shortCat}</td><td>${cnt}</td>
        <td><div style="background:var(--primary-light); border-radius:3px; height:18px; width:${Math.round(cnt / maxFreq * 100)}%;">
          <div style="background:var(--primary); height:100%; border-radius:3px; width:100%;"></div>
        </div></td></tr>`;
      }).join('');
    }
    const initRows = buildKwRows(allSorted.slice(0, SHOW_INIT));
    const moreRows = allSorted.length > SHOW_INIT ? buildKwRows(allSorted.slice(SHOW_INIT, 50)) : '';
    tableEl.innerHTML = `<table><thead><tr><th style="width:40px;">#</th><th>í‚¤ì›Œë“œ</th><th style="width:70px;">ì¹´í…Œê³ ë¦¬</th><th style="width:60px;">ë¹ˆë„</th><th>ë¹„ìœ¨</th></tr></thead>
      <tbody>${initRows}</tbody>
      ${moreRows ? `<tbody id="kwMoreRows" class="hidden">${moreRows}</tbody>` : ''}
    </table>
    ${allSorted.length > SHOW_INIT ? `<div style="text-align:center; margin-top:8px;">
      <button class="btn btn-secondary" id="kwShowMoreBtn" onclick="toggleKwMore()" style="padding:6px 20px; font-size:12px;">ë”ë³´ê¸° (${allSorted.length - SHOW_INIT}ê°œ)</button>
    </div>` : ''}`;
  }

  // Chart â€” í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
  if (keywordChartInstance) { keywordChartInstance.destroy(); keywordChartInstance = null; }
  const top20 = allSorted.slice(0, 20);
  if (top20.length > 0) {
    const ctx = document.getElementById('keywordChart').getContext('2d');
    const barColors = top20.map(([w]) => {
      const cleanW = w.replace('(ë¶€ì •)', '');
      const cat = KEYWORD_TO_CATEGORY[cleanW];
      return (catColors[cat] || {}).bar || '#90CAF9';
    });
    keywordChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: top20.map(([w]) => w),
        datasets: [{
          label: 'ë¹ˆë„',
          data: top20.map(([, c]) => c),
          backgroundColor: barColors,
          borderRadius: 4,
        }],
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
          y: { grid: { display: false } },
        },
        onClick: (evt, elements) => {
          if (elements.length > 0) {
            const idx = elements[0].index;
            const keyword = top20[idx][0];
            openKwDrilldown(keyword);
          }
        },
      },
    });
  }

  // ë“œë¦´ë‹¤ìš´ ë‹«ê¸°
  closeKwDrilldown();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Keyword Drilldown (í‚¤ì›Œë“œ í´ë¦­ â†’ ë¦¬ë·° ë³´ê¸°)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openKwDrilldown(keyword) {
  const entries = kwReviewMap[keyword];
  if (!entries || entries.length === 0) return;

  kwDrilldownPage = 1;
  const panel = document.getElementById('kwDrilldown');
  panel.classList.remove('hidden');
  document.getElementById('kwDrilldownTitle').textContent = `"${keyword}"`;
  document.getElementById('kwDrilldownCount').textContent = `${entries.length}ê±´`;

  // ì¹´ë“œ ì¹´ë“œ active í‘œì‹œ
  document.querySelectorAll('.kw-row').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.kw-row').forEach(el => {
    const span = el.querySelector('span');
    if (span && span.textContent.trim() === keyword) el.classList.add('active');
  });

  renderKwDrilldownPage(keyword);
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderKwDrilldownPage(keyword) {
  const entries = kwReviewMap[keyword] || [];
  const totalPages = Math.ceil(entries.length / KW_DRILLDOWN_PER_PAGE) || 1;
  if (kwDrilldownPage > totalPages) kwDrilldownPage = totalPages;
  const start = (kwDrilldownPage - 1) * KW_DRILLDOWN_PER_PAGE;
  const page = entries.slice(start, start + KW_DRILLDOWN_PER_PAGE);

  const container = document.getElementById('kwDrilldownList');
  container.innerHTML = page.map(({ review: r, matchedKeyword: kw }) => {
    const stars = 'â˜…'.repeat(r.rating) + 'â˜†'.repeat(Math.max(0, 5 - r.rating));
    // ë³¸ë¬¸ì—ì„œ í‚¤ì›Œë“œ í•˜ì´ë¼ì´íŠ¸
    const highlighted = escapeHtml(r.content || '').replace(
      new RegExp(kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'),
      `<mark style="background:#FFF176; padding:0 2px; border-radius:2px; font-weight:600;">$&</mark>`
    );
    return `<div class="review-item">
      <div class="review-header">
        <span class="stars">${stars}</span>
        ${r.isMonth ? '<span class="badge badge-month">í•œë‹¬ì‚¬ìš©</span>' : ''}
        <span class="badge" style="background:var(--gray-100); color:var(--gray-700);">${r.category}</span>
      </div>
      <div class="review-product">${escapeHtml(r.productName)} (${r.productId})</div>
      <div class="review-body">${highlighted}</div>
      <div class="review-meta">
        <span>${escapeHtml(r.author || 'ìµëª…')}</span>
        <span>${r.date || '-'}</span>
      </div>
    </div>`;
  }).join('');

  renderPagination('kwDrilldownPagination', kwDrilldownPage, totalPages, (p) => {
    kwDrilldownPage = p;
    renderKwDrilldownPage(keyword);
  });
}

function closeKwDrilldown() {
  document.getElementById('kwDrilldown').classList.add('hidden');
  document.querySelectorAll('.kw-row').forEach(el => el.classList.remove('active'));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - Negative Reviews
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NEGATIVE_PER_PAGE = 20;

// ë¶ˆë§Œì¡± í‚¤ì›Œë“œ (KEYWORD_DICTì—ì„œ ì¶”ì¶œ)
const NEGATIVE_KEYWORDS = KEYWORD_DICT['ë¶ˆë§Œì¡± ì´ìœ '] || [];

function getNegativeReviews() {
  const reviews = getFilteredReviews();
  const results = [];

  for (const r of reviews) {
    if (!r.content) continue;
    const text = r.content;
    const matched = [];

    // ë‚®ì€ í‰ì  (1~2ì )
    const isLowRating = r.rating <= 2;

    // ë¶ˆë§Œì¡± í‚¤ì›Œë“œ ë§¤ì¹­
    for (const kw of NEGATIVE_KEYWORDS) {
      if (text.includes(kw)) matched.push(kw);
    }

    if (isLowRating || matched.length > 0) {
      results.push({ ...r, negativeKeywords: matched, isLowRating });
    }
  }

  // ë¶ˆë§Œì¡± í‚¤ì›Œë“œ ë§ì€ ìˆœ â†’ ë‚®ì€ í‰ì  â†’ ìµœì‹ ìˆœ
  results.sort((a, b) => {
    if (b.negativeKeywords.length !== a.negativeKeywords.length)
      return b.negativeKeywords.length - a.negativeKeywords.length;
    if (a.rating !== b.rating) return a.rating - b.rating;
    return (b.date || '').localeCompare(a.date || '');
  });

  return results;
}

function renderNegativeReviews() {
  const reviews = getNegativeReviews();

  // ìš”ì•½ í†µê³„
  const totalFiltered = getFilteredReviews().length;
  const negCount = reviews.length;
  const negPct = totalFiltered > 0 ? ((negCount / totalFiltered) * 100).toFixed(1) : 0;

  // ë¶ˆë§Œì¡± í‚¤ì›Œë“œ ë¹ˆë„ ì§‘ê³„
  const kwFreq = {};
  for (const r of reviews) {
    for (const kw of r.negativeKeywords) {
      kwFreq[kw] = (kwFreq[kw] || 0) + 1;
    }
  }
  const topKw = Object.entries(kwFreq).sort((a, b) => b[1] - a[1]).slice(0, 10);

  document.getElementById('negativeSummary').innerHTML = `
    <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center; margin-bottom:12px;">
      <div class="summary-item" style="background:#FFEBEE; flex:0 0 auto; padding:12px 20px;">
        <div class="num" style="color:#E53935;">${negCount.toLocaleString()}</div>
        <div class="lbl">ë¶€ì •ì  ì˜ê²¬</div>
      </div>
      <div class="summary-item" style="background:#FFEBEE; flex:0 0 auto; padding:12px 20px;">
        <div class="num" style="color:#E53935;">${negPct}%</div>
        <div class="lbl">ì „ì²´ ëŒ€ë¹„ ë¹„ìœ¨</div>
      </div>
      <div style="flex:1; min-width:200px;">
        <div style="font-size:13px; font-weight:600; margin-bottom:6px; color:var(--gray-700);">ì£¼ìš” ë¶ˆë§Œ í‚¤ì›Œë“œ</div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          ${topKw.map(([kw, cnt]) =>
            `<span style="background:#FFEBEE; color:#C62828; padding:3px 10px; border-radius:12px; font-size:12px; font-weight:500;">${kw} (${cnt})</span>`
          ).join('')}
          ${topKw.length === 0 ? '<span style="color:var(--gray-500); font-size:13px;">í‚¤ì›Œë“œ ì—†ìŒ (ë‚®ì€ í‰ì  ê¸°ë°˜)</span>' : ''}
        </div>
      </div>
    </div>
    <div style="font-size:12px; color:var(--gray-500); margin-bottom:8px;">* í‰ì  1~2ì  ë˜ëŠ” ë¶ˆë§Œì¡± í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë¦¬ë·°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤</div>
  `;

  // í˜ì´ì§€ë„¤ì´ì…˜
  const totalPages = Math.ceil(reviews.length / NEGATIVE_PER_PAGE) || 1;
  if (negativePage > totalPages) negativePage = totalPages;
  const start = (negativePage - 1) * NEGATIVE_PER_PAGE;
  const pageReviews = reviews.slice(start, start + NEGATIVE_PER_PAGE);

  const container = document.getElementById('negativeListContainer');
  if (pageReviews.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--gray-500);">ë¶€ì •ì  ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    document.getElementById('negativePagination').innerHTML = '';
    return;
  }

  container.innerHTML = pageReviews.map(r => {
    const stars = 'â˜…'.repeat(r.rating) + 'â˜†'.repeat(Math.max(0, 5 - r.rating));
    const badges = [];
    if (r.isLowRating) badges.push('<span class="badge" style="background:#FFEBEE; color:#C62828;">ë‚®ì€í‰ì </span>');
    if (r.isMonth) badges.push('<span class="badge badge-month">í•œë‹¬ì‚¬ìš©</span>');
    const kwBadges = r.negativeKeywords.map(kw =>
      `<span class="badge" style="background:#FFEBEE; color:#C62828;">${escapeHtml(kw)}</span>`
    ).join(' ');

    return `<div class="review-item" style="border-left:3px solid #E53935;">
      <div class="review-header">
        <span class="stars">${stars}</span>
        ${badges.join(' ')} ${kwBadges}
      </div>
      <div class="review-product">${escapeHtml(r.productName)} (${r.productId})</div>
      <div class="review-body">${highlightNegative(escapeHtml(r.content || '(ë‚´ìš© ì—†ìŒ)'), r.negativeKeywords)}</div>
      <div class="review-meta">
        <span>${escapeHtml(r.author || 'ìµëª…')}</span>
        <span>${r.date || '-'}</span>
        <span class="badge" style="background:var(--gray-100); color:var(--gray-700);">${r.category}</span>
      </div>
    </div>`;
  }).join('');

  renderPagination('negativePagination', negativePage, totalPages, (p) => { negativePage = p; renderNegativeReviews(); });
}

function highlightNegative(html, keywords) {
  let result = html;
  for (const kw of keywords) {
    const escaped = escapeHtml(kw).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    result = result.replace(new RegExp(escaped, 'g'),
      `<mark style="background:#FFCDD2; padding:0 2px; border-radius:2px;">$&</mark>`);
  }
  return result;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Review - Image Modal
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openImageModal(url) {
  document.getElementById('imgModalSrc').src = url;
  document.getElementById('imgModal').classList.add('show');
}
function closeImageModal() {
  document.getElementById('imgModal').classList.remove('show');
  document.getElementById('imgModalSrc').src = '';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Keyword Table - ë”ë³´ê¸°/ì ‘ê¸°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleKwMore() {
  const moreRows = document.getElementById('kwMoreRows');
  const btn = document.getElementById('kwShowMoreBtn');
  if (!moreRows || !btn) return;
  const isHidden = moreRows.classList.contains('hidden');
  moreRows.classList.toggle('hidden');
  btn.textContent = isHidden ? 'ì ‘ê¸°' : btn.textContent.replace('ì ‘ê¸°', 'ë”ë³´ê¸°');
  if (!isHidden) {
    // Restore "ë”ë³´ê¸° (Nê°œ)" text
    const rowCount = moreRows.querySelectorAll('tr').length;
    btn.textContent = `ë”ë³´ê¸° (${rowCount}ê°œ)`;
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ê°„ ëª©ë¡ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
refreshPeriods();
</script>
</body>
</html>
