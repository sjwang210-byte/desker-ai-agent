<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì œí’ˆ í¬ì§€ì…”ë‹ ë§µ</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
:root {
  --primary: #1E88E5;
  --primary-light: #E3F2FD;
  --primary-dark: #1565C0;
  --success: #43A047;
  --success-light: #E8F5E9;
  --warning: #FB8C00;
  --warning-light: #FFF3E0;
  --danger: #E53935;
  --purple: #9C27B0;
  --gray-50: #FAFAFA;
  --gray-100: #F5F5F5;
  --gray-200: #EEEEEE;
  --gray-300: #E0E0E0;
  --gray-500: #9E9E9E;
  --gray-700: #616161;
  --gray-900: #212121;
  --radius: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
  background: var(--gray-50);
  color: var(--gray-900);
  line-height: 1.6;
}
.app-layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; min-width: 260px; background: #1a2233; color: #ccc; padding: 0;
  display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
  overflow-y: auto;
}
.sidebar-brand { padding: 20px 20px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-brand h1 { font-size: 17px; color: white; font-weight: 700; }
.sidebar-brand p { font-size: 11px; color: #8899aa; margin-top: 2px; }
.sidebar-section { padding: 12px 0 4px; }
.sidebar-section-title { padding: 0 20px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #667788; margin-bottom: 4px; }
.sidebar-item {
  display: block; padding: 9px 20px 9px 24px; font-size: 13px; color: #aabbcc; cursor: pointer;
  transition: all 0.15s; border-left: 3px solid transparent; text-decoration: none;
}
.sidebar-item:hover { background: rgba(255,255,255,0.05); color: white; }
.sidebar-item.active { background: rgba(30,136,229,0.15); color: #64B5F6; border-left-color: #1E88E5; font-weight: 600; }
.sidebar-item .icon { margin-right: 8px; font-size: 14px; }
.main-content { margin-left: 260px; flex: 1; padding: 24px 32px; max-width: 1400px; }

.header-bar {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white; padding: 16px 24px; border-radius: var(--radius); margin-bottom: 20px;
  box-shadow: var(--shadow);
}
.header-bar h2 { font-size: 18px; font-weight: 700; }
.header-bar p { font-size: 12px; opacity: 0.8; margin-top: 2px; }

.card {
  background: white; border-radius: var(--radius); padding: 24px;
  margin-bottom: 20px; box-shadow: var(--shadow);
}
.card h2 {
  font-size: 16px; font-weight: 700; color: var(--primary);
  margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
}

.upload-area {
  border: 2px dashed var(--gray-300); border-radius: var(--radius); padding: 40px;
  text-align: center; cursor: pointer; transition: all 0.2s; background: var(--gray-50);
}
.upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: var(--primary-light); }
.upload-area .icon { font-size: 48px; margin-bottom: 12px; }
.upload-area p { color: var(--gray-700); font-size: 14px; }
.upload-area input { display: none; }

.metric-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
.metric-card {
  padding: 16px; border-radius: var(--radius); border: 1px solid var(--gray-200);
  text-align: center; background: white;
}
.metric-card .value { font-size: 24px; font-weight: 700; color: var(--primary); }
.metric-card .label { font-size: 12px; color: var(--gray-700); margin-top: 4px; }

.tabs { display: flex; gap: 0; border-bottom: 2px solid var(--gray-200); margin-bottom: 16px; }
.tab-btn {
  padding: 10px 20px; font-size: 14px; font-weight: 600; border: none; background: none;
  color: var(--gray-500); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;
  transition: all 0.15s;
}
.tab-btn:hover { color: var(--gray-700); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

.btn {
  padding: 10px 20px; border-radius: var(--radius); font-size: 14px; font-weight: 600;
  cursor: pointer; border: none; transition: all 0.15s;
}
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--gray-200); color: var(--gray-700); }
.btn-secondary:hover { background: var(--gray-300); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

select, input[type="number"], input[type="text"] {
  padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: var(--radius);
  font-size: 13px; font-family: inherit; width: 100%;
}
select:focus, input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(30,136,229,0.15); }
label { display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; }

.controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px; }

table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead th {
  background: var(--primary); color: white; padding: 10px 12px; text-align: left;
  font-weight: 600; position: sticky; top: 0;
}
tbody td { padding: 8px 12px; border-bottom: 1px solid var(--gray-200); }
tbody tr:hover { background: var(--primary-light); }
.table-wrap { max-height: 500px; overflow: auto; border-radius: var(--radius); border: 1px solid var(--gray-200); }

.weight-bar-container { display: flex; flex-direction: column; gap: 8px; }
.weight-row { display: flex; align-items: center; gap: 12px; }
.weight-row .name { min-width: 120px; font-size: 13px; font-weight: 600; text-align: right; }
.weight-row .bar-wrap { flex: 1; height: 24px; background: var(--gray-100); border-radius: 12px; overflow: hidden; }
.weight-row .bar { height: 100%; background: var(--primary); border-radius: 12px; transition: width 0.3s; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; }
.weight-row .bar span { color: white; font-size: 11px; font-weight: 700; }

.slider-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.slider-item label { font-size: 12px; }
.slider-item input[type="range"] { width: 100%; }
.slider-item .val { font-size: 11px; color: var(--primary); font-weight: 700; text-align: right; }

.quadrant-label { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; display: inline-block; }
.q-premium { background: #F3E5F5; color: var(--purple); }
.q-value { background: var(--success-light); color: var(--success); }
.q-economy { background: var(--primary-light); color: var(--primary); }
.q-overprice { background: var(--warning-light); color: var(--warning); }

.category-badge {
  display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;
}
.badge-í”„ë¦¬ë¯¸ì—„ { background: #F3E5F5; color: #9C27B0; }
.badge-ê°€ì„±ë¹„ { background: #E8F5E9; color: #43A047; }
.badge-ë³´ê¸‰í˜• { background: #E3F2FD; color: #1E88E5; }
.badge-ê³¼ì‰ìŠ¤í™ { background: #FFF3E0; color: #FB8C00; }

.sim-result { margin-top: 16px; padding: 16px; background: var(--primary-light); border-radius: var(--radius); border-left: 4px solid var(--primary); }

.strategy-zone { padding: 12px 16px; border-radius: var(--radius); margin-bottom: 8px; font-size: 13px; }
.strategy-red { background: #FFEBEE; border-left: 4px solid var(--danger); }
.strategy-green { background: #E8F5E9; border-left: 4px solid var(--success); }
.strategy-blue { background: #E3F2FD; border-left: 4px solid var(--primary); }

.progress-bar { width: 100%; height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; margin-top: 4px; }
.progress-bar .fill { height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.3s; }

.col-tag {
  display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px;
  border-radius: 16px; font-size: 12px; font-weight: 600; margin: 3px;
}
.col-tag-name { background: #E3F2FD; color: #1565C0; }
.col-tag-price { background: #E8F5E9; color: #2E7D32; }
.col-tag-spec { background: #FFF3E0; color: #E65100; }
.col-tag-ox { background: #F3E5F5; color: #7B1FA2; }
.col-tag-skip { background: var(--gray-100); color: var(--gray-500); text-decoration: line-through; }
.col-tag .tag-label { font-size: 10px; opacity: 0.7; }

.type-btn {
  display: inline-flex; align-items: center; gap: 2px;
  padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;
  cursor: pointer; border: 1px dashed; transition: all 0.15s; flex-shrink: 0;
  user-select: none; white-space: nowrap;
}
.type-btn:hover { filter: brightness(0.92); transform: scale(1.05); }
.type-btn[data-type="numeric"] { background: #FFF3E0; color: #E65100; border-color: #FFB74D; }
.type-btn[data-type="ox"] { background: #F3E5F5; color: #7B1FA2; border-color: #CE93D8; }
.type-btn[data-type="text"] { background: var(--gray-100); color: var(--gray-700); border-color: var(--gray-300); }
.type-btn::after { content: ' â–¾'; font-size: 9px; opacity: 0.6; }

.btn-reset {
  padding: 6px 14px; border-radius: var(--radius); font-size: 12px; font-weight: 600;
  cursor: pointer; border: 1px solid var(--danger); background: white; color: var(--danger);
  transition: all 0.15s;
}
.btn-reset:hover { background: var(--danger); color: white; }

.weight-total-bar {
  display: flex; align-items: center; gap: 8px; padding: 8px 12px; margin-top: 12px;
  background: var(--gray-50); border-radius: var(--radius); border: 1px solid var(--gray-200);
}
.weight-total-bar .total-label { font-size: 12px; font-weight: 600; color: var(--gray-700); }
.weight-total-bar .total-value { font-size: 14px; font-weight: 700; }
.weight-total-bar .total-ok { color: var(--success); }
.weight-total-bar .total-warn { color: var(--danger); }

.hidden { display: none !important; }
.fade-in { animation: fadeIn 0.3s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

@media (max-width: 768px) {
  .sidebar { display: none; }
  .main-content { margin-left: 0; padding: 16px; }
  .metric-grid { grid-template-columns: repeat(2, 1fr); }
  .slider-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="app-layout">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-brand">
      <h1>ë°ìŠ¤ì»¤ AI ì—ì´ì „íŠ¸</h1>
      <p>ì‹œì¥ì¡°ì‚¬ &amp; ë¶„ì„ ë„êµ¬</p>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">ì‹œì¥ ì¡°ì‚¬</div>
      <a class="sidebar-item active" href="product_positioning_map.html">
        <span class="icon">ğŸ“</span>ì œí’ˆ í¬ì§€ì…”ë‹ ë§µ
      </a>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">ê³ ê° ë¶„ì„</div>
      <a class="sidebar-item" href="customer_profile_analyzer.html">
        <span class="icon">ğŸ‘¥</span>ê³ ê° í”„ë¡œíŒŒì¼ ë¶„ì„
      </a>
    </div>
  </nav>

  <!-- Main -->
  <main class="main-content">
    <div class="header-bar" style="display:flex;align-items:center;justify-content:space-between;">
      <div>
        <h2>ğŸ“ ì œí’ˆ í¬ì§€ì…”ë‹ ë§µ</h2>
        <p>ì‹œì¥ ì œí’ˆ ìŠ¤í™ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê°€ì¤‘ ìŠ¤í™ ì ìˆ˜ ê¸°ë°˜ í¬ì§€ì…”ë‹ ë§µì„ ìƒì„±í•©ë‹ˆë‹¤</p>
      </div>
      <button class="btn-reset hidden" id="btn-global-reset" onclick="resetAll()" style="border-color:rgba(255,255,255,0.6);color:white;background:rgba(255,255,255,0.15);flex-shrink:0;">
        ì´ˆê¸°í™”
      </button>
    </div>

    <!-- Step 1: Upload -->
    <div class="card" id="card-upload">
      <h2><span>1</span> ë°ì´í„° ì—…ë¡œë“œ</h2>

      <!-- ì†ŒìŠ¤ íƒ­ -->
      <div style="display:flex;gap:0;margin-bottom:16px;border-bottom:2px solid var(--gray-200);">
        <button class="source-tab active" onclick="switchSource('file')" id="tab-file"
          style="padding:10px 20px;border:none;background:none;cursor:pointer;font-size:13px;font-weight:600;color:var(--primary);border-bottom:2px solid var(--primary);margin-bottom:-2px;">
          ğŸ“Š ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ
        </button>
        <button class="source-tab" onclick="switchSource('convex')" id="tab-convex"
          style="padding:10px 20px;border:none;background:none;cursor:pointer;font-size:13px;font-weight:500;color:var(--gray-500);border-bottom:2px solid transparent;margin-bottom:-2px;">
          ğŸ—„ï¸ ì´ì „ ì‹œì¥ì¡°ì‚¬ ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
      </div>

      <!-- ì—‘ì…€ ì—…ë¡œë“œ -->
      <div id="source-file">
        <div class="upload-area" id="upload-area">
          <div class="icon">ğŸ“Š</div>
          <p><strong>ì‹œì¥ì¡°ì‚¬ ì—‘ì…€ íŒŒì¼</strong>ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
          <p style="font-size:12px;color:var(--gray-500);margin-top:8px">ì „ì¹˜í˜• ì‹œì¥ì¡°ì‚¬ ì—‘ì…€ ë˜ëŠ” ì¼ë°˜ ìŠ¤í™ ì—‘ì…€ (.xlsx / .xls)</p>
          <input type="file" id="file-input" accept=".xlsx,.xls">
        </div>
      </div>

      <!-- Convex ë¶ˆëŸ¬ì˜¤ê¸° -->
      <div id="source-convex" class="hidden">
        <div style="display:flex;gap:8px;align-items:end;margin-bottom:12px;">
          <div style="flex:1;">
            <label style="font-size:12px;font-weight:600;color:var(--gray-700);display:block;margin-bottom:4px;">Convex URL</label>
            <input type="text" id="convex-url" placeholder="https://your-project.convex.cloud"
              style="width:100%;padding:8px 12px;border:1px solid var(--gray-300);border-radius:var(--radius);font-size:13px;">
          </div>
          <button onclick="loadConvexSessions()" style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:var(--radius);cursor:pointer;font-size:13px;white-space:nowrap;">
            ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ
          </button>
        </div>
        <div id="convex-sessions" class="hidden"></div>
        <div id="convex-categories" class="hidden" style="margin-top:12px;"></div>
      </div>

      <div id="upload-status" class="hidden" style="margin-top:16px;"></div>
    </div>

    <!-- Step 2: Sheet/Category Select (for transposed) -->
    <div class="card hidden" id="card-category">
      <h2><span>2</span> ë¶„ì„í•  ì‹œíŠ¸ ì„ íƒ</h2>
      <p style="font-size:13px;color:var(--gray-700);margin-bottom:12px;">ì—‘ì…€ì˜ ê° ì‹œíŠ¸ê°€ í•˜ë‚˜ì˜ ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤. ë¶„ì„í•  ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
      <div id="sheet-list" style="margin-bottom:12px;"></div>
      <div class="controls-grid">
        <div>
          <label>ì‹œíŠ¸ ì„ íƒ</label>
          <select id="sel-category"></select>
        </div>
      </div>
    </div>

    <!-- Step 3: Data Preview -->
    <div class="card hidden" id="card-preview">
      <h2><span>3</span> íŒŒì‹±ëœ ë°ì´í„° í™•ì¸</h2>
      <p style="font-size:13px;color:var(--gray-700);margin-bottom:12px;">ì—‘ì…€ì—ì„œ ì½ì–´ì˜¨ ì œí’ˆ ë°ì´í„°ì…ë‹ˆë‹¤. ì»¬ëŸ¼ ì—­í• ì„ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ˜ì •í•˜ì„¸ìš”.</p>

      <!-- ì»¬ëŸ¼ ì—­í•  íƒœê·¸ -->
      <div id="column-roles" style="margin-bottom:16px;"></div>

      <!-- ì „ì²´ ë°ì´í„° í…Œì´ë¸” -->
      <div id="full-preview-table" style="margin-bottom:16px;"></div>

      <div style="background:var(--gray-50);border-radius:var(--radius);padding:16px;border:1px solid var(--gray-200);">
        <h3 style="font-size:14px;margin-bottom:12px;">ì»¬ëŸ¼ ì—­í•  ìˆ˜ì •</h3>
        <div class="controls-grid">
          <div><label>ì œí’ˆëª… ì»¬ëŸ¼</label><select id="sel-product"></select></div>
          <div><label>ê°€ê²© ì»¬ëŸ¼</label><select id="sel-price"></select></div>
        </div>
        <div style="margin-top:12px;">
          <label style="margin-bottom:4px;">ìŠ¤í™ ì»¬ëŸ¼ (í¬ì§€ì…”ë‹ ë¶„ì„ì— ì‚¬ìš©í•  í•­ëª©)</label>
          <p style="font-size:11px;color:var(--gray-500);margin-bottom:8px;font-weight:400;">íƒ€ì…ì´ ì˜ëª» ê°ì§€ëœ ê²½ìš° <strong style="color:var(--primary);">íƒ€ì… ë¼ë²¨ì„ í´ë¦­</strong>í•˜ë©´ ìˆ«ì â†’ ìœ /ë¬´ â†’ í…ìŠ¤íŠ¸ ìˆœìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.</p>
          <div id="spec-checkboxes" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
      </div>
    </div>

    <!-- Step 4: Weights -->
    <div class="card hidden" id="card-weights">
      <h2><span>4</span> ìŠ¤í™ ê°€ì¤‘ì¹˜ ì„¤ì •</h2>
      <p style="font-size:13px;color:var(--gray-700);margin-bottom:4px;">
        ê° ìŠ¤í™ í•­ëª©ì´ í¬ì§€ì…”ë‹ ì ìˆ˜ì— ì–¼ë§ˆë‚˜ ë°˜ì˜ë ì§€ ì„¤ì •í•©ë‹ˆë‹¤.
      </p>
      <div style="background:var(--primary-light);border-radius:var(--radius);padding:12px 16px;margin-bottom:16px;border-left:4px solid var(--primary);">
        <p style="font-size:12px;color:var(--primary-dark);margin:0;line-height:1.7;">
          <strong>ìë™ ëª¨ë“œ:</strong> ì œí’ˆ ê°„ ì°¨ì´ê°€ í° í•­ëª©ì— ë†’ì€ ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤ (ë³€ë™ê³„ìˆ˜ ê¸°ë°˜).<br>
          <strong>ìœ /ë¬´(O/X) í•­ëª©:</strong> ìˆë‹¤/ì—†ë‹¤ë§Œ êµ¬ë¶„í•˜ë¯€ë¡œ ì°¨ë³„í™” ê¸°ì—¬ë„ê°€ ë‚®ì•„ ìë™ìœ¼ë¡œ ë‚®ì€ ê°€ì¤‘ì¹˜ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.<br>
          <strong>ìˆ˜ë™ ëª¨ë“œ:</strong> ìŠ¬ë¼ì´ë”ë¡œ ì§ì ‘ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•©ê³„ëŠ” ìë™ìœ¼ë¡œ 100%ì— ë§ì¶°ì§‘ë‹ˆë‹¤.
        </p>
      </div>

      <div style="margin-bottom:12px;">
        <label style="display:inline;margin-right:16px;">
          <input type="radio" name="weight-mode" value="auto" checked> ìë™ (ë¶„ì‚° ê¸°ë°˜)
        </label>
        <label style="display:inline;">
          <input type="radio" name="weight-mode" value="manual"> ìˆ˜ë™ ì¡°ì •
        </label>
      </div>
      <div id="weight-auto"></div>
      <div id="weight-manual" class="hidden"></div>
      <div id="weight-summary" style="margin-top:12px;"></div>
      <button class="btn btn-primary" style="margin-top:16px;" onclick="runAnalysis()">í¬ì§€ì…”ë‹ ë¶„ì„ ì‹¤í–‰</button>
    </div>

    <!-- Step 5: Results -->
    <div class="card hidden" id="card-results">
      <h2><span>5</span> ë¶„ì„ ê²°ê³¼</h2>
      <div class="metric-grid" id="metrics"></div>
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab-map',this)">í¬ì§€ì…”ë‹ ë§µ</button>
        <button class="tab-btn" onclick="switchTab('tab-table',this)">ë°ì´í„° í…Œì´ë¸”</button>
      </div>
      <div class="tab-panel active" id="tab-map">
        <div id="positioning-chart" style="width:100%;height:600px;"></div>

        <!-- ì‚¬ë¶„ë©´ ì„¤ëª… -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px;">
          <div style="padding:10px 14px;border-radius:var(--radius);background:#F3E5F5;border-left:4px solid #9C27B0;">
            <div style="font-size:13px;font-weight:700;color:#7B1FA2;">â—† í”„ë¦¬ë¯¸ì—„</div>
            <div style="font-size:12px;color:#6A1B9A;margin-top:2px;">ë†’ì€ ê°€ê²© + ë†’ì€ ìŠ¤í™<br>ì°¨ë³„í™”ëœ ê³ ê¸‰ ì œí’ˆ ì˜ì—­</div>
          </div>
          <div style="padding:10px 14px;border-radius:var(--radius);background:#E8F5E9;border-left:4px solid #4CAF50;">
            <div style="font-size:13px;font-weight:700;color:#2E7D32;">â–² ê°€ì„±ë¹„</div>
            <div style="font-size:12px;color:#1B5E20;margin-top:2px;">ë‚®ì€ ê°€ê²© + ë†’ì€ ìŠ¤í™<br>ì†Œë¹„ìì—ê²Œ ê°€ì¥ ë§¤ë ¥ì ì¸ ì˜ì—­</div>
          </div>
          <div style="padding:10px 14px;border-radius:var(--radius);background:#FFF3E0;border-left:4px solid #FF9800;">
            <div style="font-size:13px;font-weight:700;color:#E65100;">â–  ê³¼ì‰ìŠ¤í™</div>
            <div style="font-size:12px;color:#BF360C;margin-top:2px;">ë†’ì€ ê°€ê²© + ë‚®ì€ ìŠ¤í™<br>ê°€ê²© ëŒ€ë¹„ ìŠ¤í™ ê²½ìŸë ¥ ë¶€ì¡±</div>
          </div>
          <div style="padding:10px 14px;border-radius:var(--radius);background:#E3F2FD;border-left:4px solid #2196F3;">
            <div style="font-size:13px;font-weight:700;color:#1565C0;">â— ë³´ê¸‰í˜•</div>
            <div style="font-size:12px;color:#0D47A1;margin-top:2px;">ë‚®ì€ ê°€ê²© + ë‚®ì€ ìŠ¤í™<br>ê°€ê²© ë¯¼ê° ì‹œì¥ì˜ ê¸°ë³¸ ë¼ì¸ì—…</div>
          </div>
        </div>

        <div class="btn-group" style="margin-top:12px;">
          <button class="btn btn-primary btn-sm" onclick="downloadPNG()">PNG ë‹¤ìš´ë¡œë“œ (ê³ í•´ìƒë„)</button>
          <button class="btn btn-secondary btn-sm" onclick="downloadCSV()">CSV ë‹¤ìš´ë¡œë“œ</button>
        </div>
      </div>
      <div class="tab-panel" id="tab-table">
        <div id="result-table"></div>
      </div>
    </div>

    <!-- Step 6: Simulation -->
    <div class="card hidden" id="card-sim">
      <h2><span>6</span> ìš°ë¦¬ ì œí’ˆ ì‹œë®¬ë ˆì´ì…˜</h2>
      <p style="font-size:13px;color:var(--gray-700);margin-bottom:16px;">ì˜ˆìƒ ìŠ¤í™ê³¼ ê°€ê²©ì„ ì…ë ¥í•˜ë©´ ë§µ ìœ„ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
      <div class="controls-grid" id="sim-fields"></div>
      <button class="btn btn-primary" style="margin-top:12px;" onclick="runSimulation()">ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
      <div id="sim-result" class="hidden"></div>
    </div>

  </main>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€
let rawData = [];       // [{col: val, ...}]
let parsedMarket = null;// {categories: [{name, products, spec_fields}]}
let columns = [];
let productCol = '';
let priceCol = '';
let specCols = [];
let weights = {};
let scored = [];
let categories = {};
let simProduct = null;
let columnTypeOverrides = {};  // {colName: 'numeric'|'ox'|'text'} ì‚¬ìš©ì ìˆ˜ë™ ì§€ì •

// â”€â”€â”€ Reset â”€â”€â”€
function resetAll() {
  rawData = [];
  parsedMarket = null;
  columns = [];
  productCol = '';
  priceCol = '';
  specCols = [];
  weights = {};
  scored = [];
  categories = {};
  simProduct = null;
  columnTypeOverrides = {};

  // ëª¨ë“  ê²°ê³¼ ì¹´ë“œ ìˆ¨ê¸°ê¸°
  ['card-category','card-preview','card-weights','card-results','card-sim'].forEach(id => {
    document.getElementById(id).classList.add('hidden');
  });
  // ì—…ë¡œë“œ ìƒíƒœ ì´ˆê¸°í™”
  document.getElementById('upload-status').innerHTML = '';
  // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
  const fileInput = document.querySelector('#source-file input[type="file"]');
  if (fileInput) fileInput.value = '';
  // ë¦¬ì…‹ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  document.getElementById('btn-global-reset').classList.add('hidden');
}

// â”€â”€â”€ Source Tab Switch â”€â”€â”€
function switchSource(mode) {
  document.getElementById('source-file').classList.toggle('hidden', mode !== 'file');
  document.getElementById('source-convex').classList.toggle('hidden', mode !== 'convex');
  const tabFile = document.getElementById('tab-file');
  const tabConvex = document.getElementById('tab-convex');
  if (mode === 'file') {
    tabFile.style.color = 'var(--primary)'; tabFile.style.borderBottomColor = 'var(--primary)'; tabFile.style.fontWeight = '600';
    tabConvex.style.color = 'var(--gray-500)'; tabConvex.style.borderBottomColor = 'transparent'; tabConvex.style.fontWeight = '500';
  } else {
    tabConvex.style.color = 'var(--primary)'; tabConvex.style.borderBottomColor = 'var(--primary)'; tabConvex.style.fontWeight = '600';
    tabFile.style.color = 'var(--gray-500)'; tabFile.style.borderBottomColor = 'transparent'; tabFile.style.fontWeight = '500';
  }
}

// â”€â”€â”€ Convex API â”€â”€â”€
async function convexQuery(url, fn, args) {
  const resp = await fetch(url.replace(/\/+$/,'') + '/api/query', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({path: fn, args, format:'json'})
  });
  const data = await resp.json();
  if (data.status === 'error') throw new Error(data.errorMessage || 'Convex query error');
  return data.value;
}

async function loadConvexSessions() {
  const url = document.getElementById('convex-url').value.trim();
  if (!url) { alert('Convex URLì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  try {
    const sessions = await convexQuery(url, 'marketResearch:listSessions', {});
    const box = document.getElementById('convex-sessions');
    if (!sessions || sessions.length === 0) {
      box.innerHTML = '<div style="padding:12px;background:var(--warning-light);border-radius:var(--radius);font-size:13px;color:var(--warning);">ì €ì¥ëœ ì‹œì¥ì¡°ì‚¬ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      box.classList.remove('hidden');
      return;
    }
    box.innerHTML = `
      <label style="font-size:12px;font-weight:600;color:var(--gray-700);display:block;margin-bottom:4px;">ì„¸ì…˜ ì„ íƒ</label>
      <select id="sel-convex-session" style="width:100%;padding:8px 12px;border:1px solid var(--gray-300);border-radius:var(--radius);font-size:13px;">
        ${sessions.map(s => `<option value="${s._id}">${s.filename} â€” ${new Date(s.uploadedAt).toLocaleDateString('ko-KR')} (${s.totalProducts}ê°œ ì œí’ˆ, ${s.sheetCount}ê°œ ì¹´í…Œê³ ë¦¬)</option>`).join('')}
      </select>
      <button onclick="loadConvexCategories()" style="margin-top:8px;padding:8px 16px;background:var(--success);color:white;border:none;border-radius:var(--radius);cursor:pointer;font-size:13px;">
        ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
      </button>`;
    box.classList.remove('hidden');
  } catch(e) {
    alert('Convex ì—°ê²° ì‹¤íŒ¨: ' + e.message);
  }
}

async function loadConvexCategories() {
  const url = document.getElementById('convex-url').value.trim();
  const sessionId = document.getElementById('sel-convex-session').value;
  try {
    const cats = await convexQuery(url, 'marketResearch:getCategories', {sessionId});
    const box = document.getElementById('convex-categories');
    if (!cats || cats.length === 0) {
      box.innerHTML = '<div style="padding:12px;background:var(--warning-light);border-radius:var(--radius);font-size:13px;">ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      box.classList.remove('hidden');
      return;
    }
    box.innerHTML = `
      <label style="font-size:12px;font-weight:600;color:var(--gray-700);display:block;margin-bottom:4px;">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
      <select id="sel-convex-cat" style="width:100%;padding:8px 12px;border:1px solid var(--gray-300);border-radius:var(--radius);font-size:13px;">
        ${cats.map(c => `<option value="${c._id}">${c.name} (ìŠ¤í™: ${c.specFields.join(', ')})</option>`).join('')}
      </select>
      <button onclick="loadConvexProducts()" style="margin-top:8px;padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:var(--radius);cursor:pointer;font-size:13px;">
        ì œí’ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      </button>`;
    box.classList.remove('hidden');
  } catch(e) {
    alert('ì¹´í…Œê³ ë¦¬ ì¡°íšŒ ì‹¤íŒ¨: ' + e.message);
  }
}

async function loadConvexProducts() {
  const url = document.getElementById('convex-url').value.trim();
  const categoryId = document.getElementById('sel-convex-cat').value;
  try {
    const products = await convexQuery(url, 'marketResearch:getProductsByCategory', {categoryId});
    if (!products || products.length === 0) {
      alert('ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.'); return;
    }
    // Convex ë°ì´í„°ë¥¼ rawData í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    rawData = products.map(p => {
      const row = { 'ì œí’ˆëª…': p.name, 'ë¸Œëœë“œ': p.brand, 'ê°€ê²©': p.actualPrice || p.price };
      if (p.specs && typeof p.specs === 'object') {
        for (const [k,v] of Object.entries(p.specs)) {
          const n = tryNum(v);
          row[k] = n !== null ? n : v;
        }
      }
      return row;
    });
    columns = Object.keys(rawData[0] || {});
    parsedMarket = null;
    columnTypeOverrides = {};
    document.getElementById('card-category').classList.add('hidden');
    setupColumnMapping();

    const catName = document.getElementById('sel-convex-cat').selectedOptions[0].textContent;
    document.getElementById('upload-status').innerHTML =
      `<div style="padding:12px;background:var(--success-light);border-radius:var(--radius);color:var(--success);font-size:13px;">
        âœ“ Convexì—ì„œ <strong>${catName}</strong> ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ (${products.length}ê°œ ì œí’ˆ)
      </div>`;
    document.getElementById('upload-status').classList.remove('hidden');
  } catch(e) {
    alert('ì œí’ˆ ì¡°íšŒ ì‹¤íŒ¨: ' + e.message);
  }
}

// â”€â”€â”€ Field Mapping (transposed excel) â”€â”€â”€
const FIELD_MAP = {
  'ì´ë¦„':'name','ì œí’ˆëª…':'name','ë¸Œëœë“œ':'brand','ê°€ê²©':'price',
  'ê°€ê²© (+ë°°ì†¡ë¹„)':'price','íŒë§¤ê°€':'price','íŒë§¤ê°€ (ë°°ì†¡ë¹„í¬í•¨)':'price',
  'ë°°ì†¡ë¹„':'shippingFee',
  'ì‹¤íŒë§¤ê°€ (ê°€ê²©+ë°°ì†¡ë¹„)':'actualPrice','ì‹¤íŒë§¤ê°€':'actualPrice',
  '1ê°œë‹¹ íŒë§¤ê°€':'actualPrice','íŒë§¤ì²˜':'seller','ì†Œì¬':'material',
  'ì›ì‚°ì§€':'origin','URL':'url','url':'url'
};
const SKIP_ROWS = new Set(['ì´ë¯¸ì§€','ë¦¬ë·°','']);
// ì „ì¹˜í˜• ê°ì§€ìš© í‚¤ì›Œë“œ (ì²« ì—´ì— ì´ë“¤ì´ í¬í•¨ë˜ë©´ ì „ì¹˜í˜•)
const TRANSPOSED_KEYWORDS = ['ì´ë¦„','ì œí’ˆëª…','ë¸Œëœë“œ','ê°€ê²©','íŒë§¤ê°€','ì†Œì¬','ì›ì‚°ì§€'];

// â”€â”€â”€ Upload â”€â”€â”€
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');
uploadArea.onclick = () => fileInput.click();
uploadArea.ondragover = e => { e.preventDefault(); uploadArea.classList.add('dragover'); };
uploadArea.ondragleave = () => uploadArea.classList.remove('dragover');
uploadArea.ondrop = e => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
fileInput.onchange = e => { if(e.target.files[0]) handleFile(e.target.files[0]); };

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, {type:'array'});

    // 1ì°¨: ì‹œíŠ¸ëª…ì— (ì‹œì¥ì¡°ì‚¬) í¬í•¨ ì—¬ë¶€ í™•ì¸
    let marketSheets = wb.SheetNames.filter(s => s.includes('(ì‹œì¥ì¡°ì‚¬)'));

    // 2ì°¨: ì‹œíŠ¸ëª…ì— (ì‹œì¥ì¡°ì‚¬) ì—†ì–´ë„, ì²« ì—´ì— ì „ì¹˜í˜• í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ì „ì¹˜í˜•ìœ¼ë¡œ ê°ì§€
    if (marketSheets.length === 0) {
      const transposedSheets = [];
      for (const sn of wb.SheetNames) {
        const ws = wb.Sheets[sn];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:null});
        if (!rows || rows.length < 3) continue;
        // ì²« ì—´(Aì—´) ê°’ë“¤ì—ì„œ ì „ì¹˜í˜• í‚¤ì›Œë“œ ë§¤ì¹­ ìˆ˜ í™•ì¸
        const col0 = rows.map(r => r && r[0] ? String(r[0]).trim() : '');
        const matchCount = col0.filter(label =>
          TRANSPOSED_KEYWORDS.some(kw => label.includes(kw)) || FIELD_MAP[label]
        ).length;
        // 3ê°œ ì´ìƒ í‚¤ì›Œë“œê°€ ì²« ì—´ì— ìˆìœ¼ë©´ ì „ì¹˜í˜•ìœ¼ë¡œ íŒë‹¨
        if (matchCount >= 3) transposedSheets.push(sn);
      }
      if (transposedSheets.length > 0) marketSheets = transposedSheets;
    }

    if (marketSheets.length > 0) {
      // Transposed market research format
      parsedMarket = parseMarketResearch(wb, marketSheets);
      if (parsedMarket.categories.length > 1) {
        showCategorySelector(parsedMarket);
      } else if (parsedMarket.categories.length === 1) {
        // ì¹´í…Œê³ ë¦¬ 1ê°œë©´ ë°”ë¡œ ì„ íƒ
        document.getElementById('card-category').classList.add('hidden');
        selectCategory(0);
      }
    } else {
      // Normal format (products = rows)
      parsedMarket = null;
      const ws = wb.Sheets[wb.SheetNames[0]];
      rawData = XLSX.utils.sheet_to_json(ws, {defval:''});
      columns = Object.keys(rawData[0] || {});
      columnTypeOverrides = {};
      document.getElementById('card-category').classList.add('hidden');
      setupColumnMapping();
    }

    const catCount = parsedMarket ? parsedMarket.categories.length : 0;
    const prodCount = parsedMarket
      ? parsedMarket.categories.reduce((s,c) => s + c.products.length, 0)
      : rawData.length;
    document.getElementById('upload-status').innerHTML =
      `<div style="padding:12px;background:var(--success-light);border-radius:var(--radius);color:var(--success);font-size:13px;">
        âœ“ <strong>${file.name}</strong> íŒŒì‹± ì™„ë£Œ (${catCount > 0 ? catCount + 'ê°œ ì¹´í…Œê³ ë¦¬, ' : ''}${prodCount}ê°œ ì œí’ˆ)
      </div>`;
    document.getElementById('upload-status').classList.remove('hidden');
  };
  reader.readAsArrayBuffer(file);
}

// â”€â”€â”€ Parse Transposed Market Research â”€â”€â”€
function parseMarketResearch(wb, sheetNames) {
  const categories = [];
  for (const sn of sheetNames) {
    const ws = wb.Sheets[sn];
    const data = XLSX.utils.sheet_to_json(ws, {header:1, defval:null});
    if (!data || data.length < 3) continue;

    // Find row labels (col 0) and name row
    let nameRow = -1;
    const labels = data.map((r,i) => {
      const v = r[0]; return v ? String(v).trim() : '';
    });
    for (let i=0;i<labels.length;i++) {
      if (labels[i]==='ì´ë¦„' || labels[i]==='ì œí’ˆëª…') { nameRow=i; break; }
    }
    // í´ë°±: 'ì´ë¦„' í–‰ì´ ì—†ìœ¼ë©´, ì²« í–‰ì— ì—¬ëŸ¬ ì…€ ê°’ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ì´ë¦„ í–‰ìœ¼ë¡œ ê°„ì£¼
    if (nameRow < 0) {
      for (let i=0; i<Math.min(3, data.length); i++) {
        const row = data[i] || [];
        const filled = row.slice(1).filter(v => v !== null && v !== undefined && String(v).trim() !== '').length;
        if (filled >= 2) { nameRow = i; break; }
      }
    }
    if (nameRow < 0) continue;

    const products = [];
    const specFields = [];
    const knownSpecs = new Set();

    for (let c=1; c<(data[nameRow]||[]).length; c++) {
      const pName = data[nameRow][c];
      if (!pName || String(pName).trim()==='') continue;

      const product = { name: String(pName).trim(), brand:'', price:0, specs:{}, isOur:false };

      for (let r=0; r<data.length; r++) {
        const lab = labels[r];
        if (!lab || SKIP_ROWS.has(lab)) continue;
        const val = data[r] ? data[r][c] : null;
        if (val===null || val===undefined) continue;
        const sval = String(val).trim();
        if (!sval) continue;

        // ì •í™•í•œ ë§¤í•‘ + ë¶€ë¶„ ë§¤ì¹­ (íŒë§¤ê°€, ê°€ê²© ë“± í¬í•¨ ì—¬ë¶€)
        let std = FIELD_MAP[lab];
        if (!std) {
          const lo = lab.toLowerCase();
          if (lo.includes('íŒë§¤ê°€') || lo.includes('ê°€ê²©')) std = 'price';
          else if (lo.includes('ë°°ì†¡ë¹„')) std = 'shippingFee';
        }
        if (std==='name') continue;
        else if (std==='brand') {
          product.brand = sval;
          if (sval.includes('ë°ìŠ¤ì»¤') || sval.includes('í¼ì‹œìŠ¤')) product.isOur = true;
        }
        else if (std==='price') { const n = tryNum(sval); if(n!==null) product.price=n; }
        else if (std==='actualPrice') { const n = tryNum(sval); if(n!==null) product.actualPrice=n; }
        else if (std==='shippingFee') product.shippingFee = sval;
        else if (std==='seller' || std==='material' || std==='origin' || std==='url') product[std] = sval;
        else if (!std && r !== nameRow) {
          product.specs[lab] = sval;
          if (!knownSpecs.has(lab)) { knownSpecs.add(lab); specFields.push(lab); }
        }
      }
      if (!product.actualPrice && product.price > 0) {
        const ship = tryNum(product.shippingFee);
        product.actualPrice = (ship && ship > 0) ? product.price + ship : product.price;
      }
      products.push(product);
    }

    const catName = sn.replace('(ì‹œì¥ì¡°ì‚¬)','').trim();
    if (products.length > 0) categories.push({ name: catName, products, spec_fields: specFields });
  }
  return { categories };
}

function tryNum(val) {
  if (val===null || val===undefined) return null;
  if (typeof val === 'number') return isNaN(val) ? null : val;
  let s = String(val).replace(/,/g,'').replace(/ì›|â‚©/g,'').trim();
  // ë²”ìœ„ê°’ ì²˜ë¦¬: "72000-74000" â†’ í‰ê· ê°’ ì‚¬ìš©
  const rangeMatch = s.match(/^(\d+(?:\.\d+)?)\s*[-~]\s*(\d+(?:\.\d+)?)$/);
  if (rangeMatch) {
    return (parseFloat(rangeMatch[1]) + parseFloat(rangeMatch[2])) / 2;
  }
  const n = parseFloat(s);
  return isNaN(n) ? null : n;
}

// â”€â”€â”€ Category Selector â”€â”€â”€
function showCategorySelector(parsed) {
  const card = document.getElementById('card-category');
  card.classList.remove('hidden');
  card.classList.add('fade-in');

  // ì‹œíŠ¸ ëª©ë¡ ì¹´ë“œ
  const listBox = document.getElementById('sheet-list');
  listBox.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;">${parsed.categories.map((c,i) =>
    `<div class="sheet-card" data-idx="${i}" onclick="document.getElementById('sel-category').value=${i};selectCategory(${i});"
      style="padding:12px 16px;border:2px solid ${i===0?'var(--primary)':'var(--gray-200)'};border-radius:var(--radius);
      cursor:pointer;background:${i===0?'var(--primary-light)':'white'};flex:1;min-width:180px;transition:all 0.15s;">
      <div style="font-size:14px;font-weight:700;color:${i===0?'var(--primary)':'var(--gray-900)'};">${c.name}</div>
      <div style="font-size:12px;color:var(--gray-500);margin-top:4px;">
        ${c.products.length}ê°œ ì œí’ˆ Â· ${c.spec_fields.length}ê°œ ìŠ¤í™ í•­ëª©
      </div>
      <div style="font-size:11px;color:var(--gray-500);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        ìŠ¤í™: ${c.spec_fields.slice(0,4).join(', ')}${c.spec_fields.length > 4 ? ' ...' : ''}
      </div>
    </div>`
  ).join('')}</div>`;

  const sel = document.getElementById('sel-category');
  sel.innerHTML = parsed.categories.map((c,i) =>
    `<option value="${i}">ğŸ“„ ${c.name} â€” ${c.products.length}ê°œ ì œí’ˆ, ${c.spec_fields.length}ê°œ ìŠ¤í™</option>`
  ).join('');
  sel.onchange = () => {
    const idx = parseInt(sel.value);
    selectCategory(idx);
    // ì‹œíŠ¸ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.sheet-card').forEach((el,i) => {
      el.style.borderColor = i===idx ? 'var(--primary)' : 'var(--gray-200)';
      el.style.background = i===idx ? 'var(--primary-light)' : 'white';
      el.querySelector('div').style.color = i===idx ? 'var(--primary)' : 'var(--gray-900)';
    });
  };
  selectCategory(0);
}

function selectCategory(idx) {
  const cat = parsedMarket.categories[idx];
  // Convert to flat row format
  rawData = cat.products.map(p => {
    const row = { 'ì œí’ˆëª…': p.name, 'ë¸Œëœë“œ': p.brand, 'ê°€ê²©': p.actualPrice || p.price };
    for (const [k,v] of Object.entries(p.specs)) {
      const n = tryNum(v);
      row[k] = n !== null ? n : v;
    }
    return row;
  });
  columns = Object.keys(rawData[0] || {});
  columnTypeOverrides = {};
  setupColumnMapping();
}

// â”€â”€â”€ ì»¬ëŸ¼ íƒ€ì… ë¶„ì„ (O/X, ìˆ«ì, í…ìŠ¤íŠ¸) â”€â”€â”€
function analyzeColumnType(col) {
  // ì‚¬ìš©ì ìˆ˜ë™ ì§€ì •ì´ ìˆìœ¼ë©´ ìš°ì„  ì ìš©
  if (columnTypeOverrides[col]) {
    const t = columnTypeOverrides[col];
    const labelMap = { numeric: 'ìˆ«ì', ox: 'ìœ /ë¬´', text: 'í…ìŠ¤íŠ¸' };
    return { type: t, label: labelMap[t] || t, overridden: true };
  }
  const vals = rawData.map(r => String(r[col] ?? '').trim()).filter(v => v);
  if (vals.length === 0) return { type: 'empty', label: 'ë¹ˆê°’' };
  const upper = vals.map(v => v.toUpperCase());
  const oxCount = upper.filter(v => ['O','X','â—‹','Ã—','â—¯','âœ•'].includes(v)).length;
  if (oxCount >= vals.length * 0.6) return { type: 'ox', label: 'ìœ /ë¬´' };
  const numCount = vals.map(v => specToNum(v)).filter(v => v !== null).length;
  if (numCount >= vals.length * 0.5) return { type: 'numeric', label: 'ìˆ«ì' };
  return { type: 'text', label: 'í…ìŠ¤íŠ¸' };
}

// íƒ€ì… ë²„íŠ¼ í´ë¦­ â†’ ìˆœí™˜: ìˆ«ì â†’ ìœ /ë¬´ â†’ í…ìŠ¤íŠ¸ â†’ ìˆ«ì
function cycleType(btn) {
  const col = btn.dataset.col;
  const cycle = ['numeric', 'ox', 'text'];
  const icons = { numeric: 'ğŸ“Š', ox: 'âš¡', text: 'ğŸ“' };
  const labels = { numeric: 'ìˆ«ì', ox: 'ìœ /ë¬´', text: 'í…ìŠ¤íŠ¸' };
  const curIdx = cycle.indexOf(btn.dataset.type);
  const nextType = cycle[(curIdx + 1) % cycle.length];

  // ì˜¤ë²„ë¼ì´ë“œ ì €ì¥
  columnTypeOverrides[col] = nextType;

  // ë²„íŠ¼ ì—…ë°ì´íŠ¸
  btn.dataset.type = nextType;
  btn.textContent = '';  // clear (::after pseudo is CSS)
  btn.textContent = `${icons[nextType]} ${labels[nextType]}`;

  // ì»¬ëŸ¼ ì—­í•  íƒœê·¸ + ê°€ì¤‘ì¹˜ ì¬ê³„ì‚°
  const rolesBox = document.getElementById('column-roles');
  if (rolesBox) {
    // updateColumnRoleTagsê°€ setupColumnMapping ë‚´ë¶€ í•¨ìˆ˜ì´ë¯€ë¡œ ê°„ë‹¨íˆ íƒœê·¸ ì§ì ‘ ê°±ì‹ 
    const tags = rolesBox.querySelectorAll('.col-tag');
    tags.forEach(tag => {
      if (tag.textContent.includes(col)) {
        const info = analyzeColumnType(col);
        const icon = info.type === 'ox' ? 'âš¡' : info.type === 'numeric' ? 'ğŸ“Š' : 'ğŸ“';
        const cls = info.type === 'ox' ? 'col-tag-ox' : 'col-tag-spec';
        tag.className = `col-tag ${cls}`;
        tag.innerHTML = `${icon} ${col} <span class="tag-label">(${info.label})</span>`;
      }
    });
  }
  setupWeights();
}

// â”€â”€â”€ Column Mapping â”€â”€â”€
function setupColumnMapping() {
  const card = document.getElementById('card-preview');
  card.classList.remove('hidden');
  card.classList.add('fade-in');
  // ë¦¬ì…‹ ë²„íŠ¼ í‘œì‹œ
  document.getElementById('btn-global-reset').classList.remove('hidden');

  // ìë™ ê°ì§€: ì œí’ˆëª…, ê°€ê²© ì»¬ëŸ¼
  let autoProduct = columns.find(c => /^ì œí’ˆëª…$|^ìƒí’ˆëª…$|^ì´ë¦„$/i.test(c)) || columns[0];
  let autoPrice = columns.find(c => /^ê°€ê²©$|^íŒë§¤ê°€$|^price$/i.test(c)) || columns[1];

  const selP = document.getElementById('sel-product');
  const selPr = document.getElementById('sel-price');
  selP.innerHTML = columns.map(c => `<option value="${c}" ${c===autoProduct?'selected':''}>${c}</option>`).join('');
  selPr.innerHTML = columns.map(c => `<option value="${c}" ${c===autoPrice?'selected':''}>${c}</option>`).join('');

  const getFilteredCols = () => {
    const excluded = new Set([selP.value, selPr.value]);
    const skipPattern = /url|ë§í¬|ì´ë¯¸ì§€|image|ë¹„ê³ |ë²ˆí˜¸|^id$|^ë¸Œëœë“œ$|^brand$/i;
    return {
      remaining: columns.filter(c => !excluded.has(c) && !skipPattern.test(c)),
      skipped: columns.filter(c => !excluded.has(c) && skipPattern.test(c)),
    };
  };

  const updateColumnRoleTags = () => {
    const { remaining, skipped } = getFilteredCols();
    const rolesBox = document.getElementById('column-roles');
    let tagsHtml = '<div style="display:flex;flex-wrap:wrap;gap:0;">';
    tagsHtml += `<span class="col-tag col-tag-name">ğŸ“‹ ${selP.value} <span class="tag-label">(ì œí’ˆëª…)</span></span>`;
    tagsHtml += `<span class="col-tag col-tag-price">ğŸ’° ${selPr.value} <span class="tag-label">(ê°€ê²©)</span></span>`;
    for (const c of remaining) {
      const info = analyzeColumnType(c);
      const cls = info.type === 'ox' ? 'col-tag-ox' : 'col-tag-spec';
      const icon = info.type === 'ox' ? 'âš¡' : info.type === 'numeric' ? 'ğŸ“Š' : 'ğŸ“';
      tagsHtml += `<span class="col-tag ${cls}">${icon} ${c} <span class="tag-label">(${info.label})</span></span>`;
    }
    for (const c of skipped) {
      tagsHtml += `<span class="col-tag col-tag-skip">${c}</span>`;
    }
    tagsHtml += '</div>';
    rolesBox.innerHTML = tagsHtml;
  };

  const updateAll = () => {
    const { remaining } = getFilteredCols();

    // ì»¬ëŸ¼ ì—­í•  íƒœê·¸ ë Œë”
    updateColumnRoleTags();

    // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸”
    const showCols = [selP.value, selPr.value, ...remaining];
    let tableHtml = '<div class="table-wrap"><table><thead><tr>';
    tableHtml += showCols.map(c => {
      const info = analyzeColumnType(c);
      const badge = c === selP.value ? 'ğŸ“‹' : c === selPr.value ? 'ğŸ’°' : info.type === 'ox' ? 'âš¡' : '';
      return `<th>${badge} ${c}</th>`;
    }).join('');
    tableHtml += '</tr></thead><tbody>';
    for (const row of rawData) {
      tableHtml += '<tr>';
      for (const c of showCols) {
        let val = row[c] ?? '';
        // O/X í‘œì‹œ ê°•ì¡°
        const sv = String(val).trim().toUpperCase();
        if (sv === 'O' || sv === 'â—‹') val = '<span style="color:#4CAF50;font-weight:700;">O</span>';
        else if (sv === 'X' || sv === 'Ã—') val = '<span style="color:#E53935;font-weight:700;">X</span>';
        else if (c === selPr.value && typeof val === 'number') val = Number(val).toLocaleString();
        tableHtml += `<td>${val}</td>`;
      }
      tableHtml += '</tr>';
    }
    tableHtml += '</tbody></table></div>';
    document.getElementById('full-preview-table').innerHTML = tableHtml;

    // ìŠ¤í™ ì²´í¬ë°•ìŠ¤ + íƒ€ì… ë²„íŠ¼
    const box = document.getElementById('spec-checkboxes');
    box.innerHTML = remaining.map(c => {
      const info = analyzeColumnType(c);
      const icon = info.type === 'ox' ? 'âš¡' : info.type === 'numeric' ? 'ğŸ“Š' : 'ğŸ“';
      return `<div class="spec-item" style="display:inline-flex;align-items:center;gap:6px;padding:4px 6px 4px 10px;border-radius:20px;font-size:13px;background:var(--gray-50);border:1px solid var(--gray-200);">
        <label style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;margin:0;">
          <input type="checkbox" class="spec-chk" value="${c}" checked> ${c}
        </label>
        <span class="type-btn" data-col="${c}" data-type="${info.type}" onclick="cycleType(this)">${icon} ${info.label}</span>
      </div>`;
    }).join('');

    setupWeights();
  };

  selP.onchange = updateAll;
  selPr.onchange = updateAll;
  // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ê°€ì¤‘ì¹˜ ì—…ë°ì´íŠ¸
  document.getElementById('spec-checkboxes').addEventListener('change', e => {
    if (e.target.classList.contains('spec-chk')) setupWeights();
  });

  updateAll();
}

// â”€â”€â”€ Weights â”€â”€â”€
function setupWeights() {
  const card = document.getElementById('card-weights');
  card.classList.remove('hidden');

  productCol = document.getElementById('sel-product').value;
  priceCol = document.getElementById('sel-price').value;
  specCols = [...document.querySelectorAll('.spec-chk:checked')].map(cb => cb.value);

  if (specCols.length === 0) {
    card.classList.add('hidden');
    return;
  }

  // Calculate variance weights
  weights = calcVarianceWeights(rawData, specCols);
  renderWeightBars(weights);
  renderWeightSliders(specCols, weights);

  // Mode toggle
  document.querySelectorAll('[name="weight-mode"]').forEach(r => {
    r.onchange = () => {
      document.getElementById('weight-auto').classList.toggle('hidden', r.value !== 'auto' || !r.checked);
      document.getElementById('weight-manual').classList.toggle('hidden', r.value !== 'manual' || !r.checked);
    };
  });
}

function calcVarianceWeights(data, cols) {
  const cvs = {};
  for (const col of cols) {
    const info = analyzeColumnType(col);
    let vals;
    if (info.type === 'text') {
      // í…ìŠ¤íŠ¸ëŠ” ordinal ì¸ì½”ë”© í›„ ë¶„ì‚° ê³„ì‚°
      const unique = [...new Set(data.map(r => String(r[col] ?? '').trim()))].filter(v => v).sort();
      const map = {};
      unique.forEach((v, i) => { map[v] = unique.length > 1 ? i / (unique.length - 1) : 0.5; });
      vals = data.map(r => map[String(r[col] ?? '').trim()] ?? null).filter(v => v !== null);
    } else {
      vals = data.map(r => specToNum(r[col])).filter(v => v !== null);
    }
    if (vals.length < 2) { cvs[col] = 0; continue; }
    const mean = vals.reduce((s,v)=>s+v,0) / vals.length;
    const std = Math.sqrt(vals.reduce((s,v)=>s+(v-mean)**2,0) / (vals.length-1));
    cvs[col] = Math.abs(mean) > 1e-10 ? std / Math.abs(mean) : std;
  }
  const total = Object.values(cvs).reduce((s,v)=>s+v,0);
  const w = {};
  for (const col of cols) w[col] = total > 0 ? cvs[col]/total : 1/cols.length;
  return w;
}

function renderWeightBars(w) {
  const sorted = Object.entries(w).sort((a,b) => b[1]-a[1]);
  const maxW = Math.max(...Object.values(w), 0.01);
  const totalPct = Object.values(w).reduce((s,v) => s+v, 0) * 100;

  // ìœ /ë¬´ í•­ëª©ê³¼ ìˆ«ì í•­ëª© ë¶„ë¦¬
  const oxCols = sorted.filter(([n]) => analyzeColumnType(n).type === 'ox');
  const numCols = sorted.filter(([n]) => analyzeColumnType(n).type !== 'ox');

  document.getElementById('weight-auto').innerHTML =
    `<div class="weight-bar-container">${sorted.map(([n,v]) => {
      const info = analyzeColumnType(n);
      const icon = info.type === 'ox' ? 'âš¡' : info.type === 'numeric' ? 'ğŸ“Š' : 'ğŸ“';
      const typeLabel = info.type === 'ox' ? '<span style="font-size:10px;color:#7B1FA2;margin-left:4px;">(ìœ /ë¬´)</span>' : '';
      return `<div class="weight-row">
        <div class="name">${icon} ${n}${typeLabel}</div>
        <div class="bar-wrap"><div class="bar" style="width:${(v/maxW*100).toFixed(0)}%;background:${info.type==='ox'?'#CE93D8':'var(--primary)'}"><span>${(v*100).toFixed(1)}%</span></div></div>
      </div>`;
    }).join('')}</div>
    <div class="weight-total-bar">
      <span class="total-label">í•©ê³„:</span>
      <span class="total-value total-ok">${totalPct.toFixed(0)}%</span>
      <span style="font-size:11px;color:var(--gray-500);">(${sorted.length}ê°œ í•­ëª©)</span>
    </div>`;

  // ê°€ì¤‘ì¹˜ ìš”ì•½
  const summary = document.getElementById('weight-summary');
  if (oxCols.length > 0) {
    const oxTotal = oxCols.reduce((s,[,v])=>s+v,0);
    const numTotal = numCols.reduce((s,[,v])=>s+v,0);
    summary.innerHTML = `<div style="font-size:12px;color:var(--gray-700);padding:8px 12px;background:var(--gray-50);border-radius:var(--radius);">
      ğŸ“Š <strong>ìˆ«ìí˜• ìŠ¤í™:</strong> ${numCols.length}ê°œ í•­ëª©, í•©ê³„ ê°€ì¤‘ì¹˜ ${(numTotal*100).toFixed(0)}%
      &nbsp;&nbsp;|&nbsp;&nbsp;
      âš¡ <strong>ìœ /ë¬´ ìŠ¤í™:</strong> ${oxCols.length}ê°œ í•­ëª©, í•©ê³„ ê°€ì¤‘ì¹˜ ${(oxTotal*100).toFixed(0)}%
      <span style="color:var(--gray-500);margin-left:8px;">(ìœ /ë¬´ í•­ëª©ì€ O=1, X=0ìœ¼ë¡œ ë³€í™˜ í›„ ë¶„ì„)</span>
    </div>`;
  } else {
    summary.innerHTML = '';
  }
}

function renderWeightSliders(cols, defaults) {
  const container = document.getElementById('weight-manual');
  container.innerHTML =
    `<p style="font-size:12px;color:var(--gray-500);margin-bottom:12px;">ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”. ê° í•­ëª©ì˜ ë¹„ì¤‘ì„ ì„¤ì •í•˜ë©´ í•©ê³„ ëŒ€ë¹„ ë¹„ìœ¨ë¡œ ìë™ í™˜ì‚°ë©ë‹ˆë‹¤.</p>
    <div class="slider-grid">${cols.map(c => {
      const info = analyzeColumnType(c);
      const icon = info.type === 'ox' ? 'âš¡' : info.type === 'numeric' ? 'ğŸ“Š' : 'ğŸ“';
      return `<div class="slider-item">
        <label>${icon} ${c} <span style="font-size:10px;color:var(--gray-500);font-weight:400;">(${info.label})</span></label>
        <input type="range" min="0" max="100" value="${Math.round((defaults[c]||0.5)*100)}" class="weight-slider" data-col="${c}"
          oninput="updateSliderTotal()">
        <div class="val">${Math.round((defaults[c]||0.5)*100)}%</div>
      </div>`;
    }).join('')}</div>
    <div class="weight-total-bar" id="manual-weight-total">
      <span class="total-label">í•©ê³„:</span>
      <span class="total-value" id="manual-total-value">-</span>
      <span style="font-size:11px;color:var(--gray-500);" id="manual-total-note"></span>
    </div>`;
  updateSliderTotal();
}

function updateSliderTotal() {
  const sliders = document.querySelectorAll('.weight-slider');
  let rawTotal = 0;
  sliders.forEach(s => {
    const v = parseInt(s.value);
    rawTotal += v;
    // ê° ìŠ¬ë¼ì´ë” ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
    s.nextElementSibling.textContent = v + '%';
  });
  const totalEl = document.getElementById('manual-total-value');
  const noteEl = document.getElementById('manual-total-note');
  if (totalEl) {
    totalEl.textContent = rawTotal + '%';
    if (rawTotal === 100) {
      totalEl.className = 'total-value total-ok';
      noteEl.textContent = '(ì •í™•íˆ 100%)';
    } else {
      totalEl.className = 'total-value total-warn';
      noteEl.textContent = `(ë¶„ì„ ì‹œ ${rawTotal > 0 ? '100%ë¡œ ìë™ í™˜ì‚°' : 'ê°€ì¤‘ì¹˜ ì—†ìŒ'})`;
    }
  }
}

function getWeights() {
  const mode = document.querySelector('[name="weight-mode"]:checked').value;
  if (mode === 'auto') return weights;
  const sliders = document.querySelectorAll('.weight-slider');
  const raw = {};
  sliders.forEach(s => { raw[s.dataset.col] = parseInt(s.value); });
  const total = Object.values(raw).reduce((s,v)=>s+v,0) || 1;
  const w = {};
  for (const [k,v] of Object.entries(raw)) w[k] = v/total;
  return w;
}

// â”€â”€â”€ Analysis â”€â”€â”€
function runAnalysis() {
  productCol = document.getElementById('sel-product').value;
  priceCol = document.getElementById('sel-price').value;
  specCols = [...document.querySelectorAll('.spec-chk:checked')].map(cb => cb.value);
  const w = getWeights();

  // Normalize & Score
  scored = normalizeAndScore(rawData, productCol, priceCol, specCols, w);
  categories = classifyProducts(scored, productCol, priceCol);

  // Show results
  const card = document.getElementById('card-results');
  card.classList.remove('hidden');
  card.classList.add('fade-in');

  // Metrics
  const prices = scored.map(r => r[priceCol]);
  document.getElementById('metrics').innerHTML = `
    <div class="metric-card"><div class="value">${scored.length}ê°œ</div><div class="label">ì œí’ˆ ìˆ˜</div></div>
    <div class="metric-card"><div class="value">${specCols.length}ê°œ</div><div class="label">ìŠ¤í™ í•­ëª©</div></div>
    <div class="metric-card"><div class="value">${(scored.reduce((s,r)=>s+r._score,0)/scored.length).toFixed(1)}</div><div class="label">í‰ê·  ìŠ¤í™ ì ìˆ˜</div></div>
    <div class="metric-card"><div class="value">${Math.min(...prices).toLocaleString()} ~ ${Math.max(...prices).toLocaleString()}</div><div class="label">ê°€ê²© ë²”ìœ„</div></div>`;

  renderPositioningMap();
  renderResultTable();
  setupSimulation();

  card.scrollIntoView({ behavior:'smooth', block:'start' });
}

// O/X, ìœ /ë¬´, Y/N ë“± í…ìŠ¤íŠ¸ë¥¼ ìˆ«ìë¡œ ë³€í™˜
function textToNum(val) {
  if (val === null || val === undefined) return null;
  const s = String(val).trim().toUpperCase();
  // O/X íŒ¨í„´
  if (s === 'O' || s === 'â—‹' || s === 'â—¯') return 1;
  if (s === 'X' || s === 'Ã—' || s === 'âœ•') return 0;
  // ìœ /ë¬´ íŒ¨í„´
  if (s === 'ìœ ' || s === 'ìˆìŒ' || s === 'YES' || s === 'Y') return 1;
  if (s === 'ë¬´' || s === 'ì—†ìŒ' || s === 'NO' || s === 'N') return 0;
  return null;
}

// ë‹¨ê³„ í‘œí˜„ì„ ìˆ«ìë¡œ ë³€í™˜: "5ë‹¨ê³„" â†’ 5, "3ë‹¨ê³„/2000LUX" â†’ 3
function stageToNum(val) {
  if (val === null || val === undefined) return null;
  const s = String(val).trim();
  const m = s.match(/(\d+)\s*ë‹¨ê³„/);
  return m ? parseInt(m[1]) : null;
}

// ìŠ¤í™ ê°’ì„ ìˆ«ìë¡œ ë³€í™˜ (tryNum â†’ textToNum â†’ stageToNum ìˆœì„œë¡œ ì‹œë„)
function specToNum(val) {
  let n = tryNum(val);
  if (n !== null) return n;
  n = textToNum(val);
  if (n !== null) return n;
  n = stageToNum(val);
  if (n !== null) return n;
  return null;
}

function normalizeAndScore(data, pCol, prCol, sCols, w) {
  // ì»¬ëŸ¼ë³„ íƒ€ì…: analyzeColumnType() ê²°ê³¼ (ì‚¬ìš©ì ì˜¤ë²„ë¼ì´ë“œ í¬í•¨) ì‚¬ìš©
  const colType = {};  // 'numeric' | 'ordinal'
  const ordinalMaps = {};
  const numericVals = {};

  for (const c of sCols) {
    const info = analyzeColumnType(c);

    if (info.type === 'numeric' || info.type === 'ox') {
      // ìˆ«ì ë˜ëŠ” ìœ /ë¬´ â†’ ìˆ«ì ë³€í™˜
      colType[c] = 'numeric';
      numericVals[c] = data.map(r => specToNum(r[c]));
    } else {
      // í…ìŠ¤íŠ¸ ordinal ì¸ì½”ë”©
      colType[c] = 'ordinal';
      const unique = [...new Set(data.map(r => String(r[c] ?? '').trim()))].filter(v => v).sort();
      const map = {};
      unique.forEach((v, i) => { map[v] = unique.length > 1 ? i / (unique.length - 1) : 0.5; });
      ordinalMaps[c] = map;
    }
  }

  // Min-max per numeric column
  const mins = {}, maxs = {};
  for (const c of sCols) {
    if (colType[c] !== 'numeric') continue;
    const vals = numericVals[c].filter(v => v !== null);
    mins[c] = vals.length ? Math.min(...vals) : 0;
    maxs[c] = vals.length ? Math.max(...vals) : 1;
  }

  const results = data.map((row, idx) => {
    const r = {...row};
    let score = 0;
    for (const c of sCols) {
      let norm = 0.5;
      if (colType[c] === 'numeric') {
        const v = numericVals[c][idx];
        if (v !== null) {
          const range = maxs[c] - mins[c];
          norm = range > 0 ? (v - mins[c]) / range : 0.5;
        }
      } else {
        // ordinal
        const key = String(r[c] ?? '').trim();
        norm = ordinalMaps[c][key] ?? 0.5;
      }
      r['_norm_'+c] = norm;
      score += norm * (w[c] || 0);
    }
    r._rawScore = score * 100;
    return r;
  });

  // â”€â”€ ìˆœìœ„ ê¸°ë°˜ ì ìˆ˜ (5~95) â”€â”€
  // ì›ì‹œ ì ìˆ˜ë¡œ ì •ë ¬ â†’ ìˆœìœ„ ë¶€ì—¬ â†’ ë™ì ì€ í‰ê·  ìˆœìœ„ â†’ 5~95 ë§¤í•‘
  results.sort((a,b) => a._rawScore - b._rawScore); // ì˜¤ë¦„ì°¨ìˆœ

  const n = results.length;
  if (n <= 1) {
    results.forEach(r => r._score = 50);
  } else {
    // ë™ì  ì²˜ë¦¬: ê°™ì€ rawScore â†’ ê°™ì€ ìˆœìœ„ (í‰ê· )
    let i = 0;
    while (i < n) {
      let j = i;
      while (j < n && Math.abs(results[j]._rawScore - results[i]._rawScore) < 0.001) j++;
      const avgRank = (i + j - 1) / 2; // 0-based í‰ê·  ìˆœìœ„
      for (let k = i; k < j; k++) {
        results[k]._rank = avgRank;
        results[k]._score = (avgRank / (n - 1)) * 90 + 5; // ìµœì €=5, ìµœê³ =95
      }
      i = j;
    }
  }

  return results.sort((a,b) => b._score - a._score);
}

function classifyProducts(data, pCol, prCol) {
  const prices = data.map(r => r[prCol]).sort((a,b)=>a-b);
  const scores = data.map(r => r._score).sort((a,b)=>a-b);
  const medianPrice = prices[Math.floor(prices.length/2)];
  const medianScore = scores[Math.floor(scores.length/2)];
  const cats = {};
  for (const r of data) {
    const hp = r[prCol] >= medianPrice, hs = r._score >= medianScore;
    cats[r[pCol]] = hp && hs ? 'í”„ë¦¬ë¯¸ì—„' : !hp && hs ? 'ê°€ì„±ë¹„' : !hp && !hs ? 'ë³´ê¸‰í˜•' : 'ê³¼ì‰ìŠ¤í™';
  }
  cats._medianPrice = medianPrice;
  cats._medianScore = medianScore;
  return cats;
}

// â”€â”€â”€ Positioning Map â”€â”€â”€
function renderPositioningMap() {
  const catColors = { 'í”„ë¦¬ë¯¸ì—„':'#9C27B0', 'ê°€ì„±ë¹„':'#4CAF50', 'ë³´ê¸‰í˜•':'#2196F3', 'ê³¼ì‰ìŠ¤í™':'#FF9800' };
  const catSymbols = { 'í”„ë¦¬ë¯¸ì—„':'diamond', 'ê°€ì„±ë¹„':'triangle-up', 'ë³´ê¸‰í˜•':'circle', 'ê³¼ì‰ìŠ¤í™':'square' };

  // ë¸Œëœë“œ ì»¬ëŸ¼ ì°¾ê¸°
  const brandCol = columns.find(c => /^ë¸Œëœë“œ$|^brand$/i.test(c)) || '';

  // ë¼ë²¨ ê²¹ì¹¨ ë°©ì§€: ì  ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ë°©í–¥ ë¶„ì‚°
  const allPoints = scored.map(r => ({ x: r[priceCol], y: r._score }));

  function getTextPosition(r, idx) {
    const positions = ['top center', 'bottom center', 'top right', 'top left', 'bottom right', 'bottom left', 'middle right', 'middle left'];
    // ê°€ê¹Œìš´ ë‹¤ë¥¸ ì ì´ ìˆëŠ”ì§€ í™•ì¸ â†’ ë°©í–¥ ë¶„ì‚°
    const x = r[priceCol], y = r._score;
    let bestPos = 'top center';
    let minConflict = Infinity;
    for (const pos of positions) {
      let conflict = 0;
      for (let j = 0; j < allPoints.length; j++) {
        if (j === idx) continue;
        const dx = (allPoints[j].x - x) / (Math.max(...allPoints.map(p=>p.x)) - Math.min(...allPoints.map(p=>p.x)) || 1);
        const dy = (allPoints[j].y - y) / 100;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 0.15) conflict += 1 / (dist + 0.01);
      }
      // ìœ„ì¹˜ì— ë”°ë¥¸ ë³´ì • (top center ì„ í˜¸)
      if (pos === 'top center') conflict -= 0.5;
      if (conflict < minConflict) { minConflict = conflict; bestPos = pos; }
    }
    return bestPos;
  }

  // ë¯¸ë¦¬ ì „ì²´ scoredì— ëŒ€í•´ position ê³„ì‚°
  const textPositions = {};
  scored.forEach((r, i) => { textPositions[r[productCol]] = getTextPosition(r, i); });

  const traces = [];
  for (const [cat, color] of Object.entries(catColors)) {
    const items = scored.filter(r => categories[r[productCol]] === cat);
    if (!items.length) continue;
    traces.push({
      x: items.map(r => r[priceCol]),
      y: items.map(r => r._score),
      text: items.map(r => {
        const brand = brandCol && r[brandCol] ? `<b>${r[brandCol]}</b> ` : '';
        const name = r[productCol];
        return brand + name;
      }),
      hovertext: items.map(r => {
        const brand = brandCol && r[brandCol] ? `[${r[brandCol]}] ` : '';
        let h = `<b>${brand}${r[productCol]}</b><br>ê°€ê²©: ${Number(r[priceCol]).toLocaleString()}<br>ìŠ¤í™ ì ìˆ˜: ${r._score.toFixed(1)} (ì›ì‹œ: ${r._rawScore.toFixed(2)})`;
        for (const c of specCols) {
          const numVal = specToNum(r[c]);
          h += `<br>${c}: ${r[c]} â†’ ${numVal !== null ? numVal : '?'}`;
        }
        return h;
      }),
      hoverinfo: 'text',
      mode: 'markers+text',
      type: 'scatter',
      name: cat,
      textposition: items.map(r => textPositions[r[productCol]]),
      textfont: { size: 10 },
      marker: { color, symbol: catSymbols[cat], size: 14, line: { width: 2, color: 'white' } }
    });
  }

  // Our product
  if (simProduct) {
    traces.push({
      x: [simProduct.price], y: [simProduct.score],
      text: [`<b>â˜… ${simProduct.name}</b>`],
      hovertext: [`<b>${simProduct.name}</b><br>ê°€ê²©: ${simProduct.price.toLocaleString()}<br>ìŠ¤í™ ì ìˆ˜: ${simProduct.score.toFixed(1)}<br>ì¹´í…Œê³ ë¦¬: ${simProduct.category}`],
      hoverinfo: 'text',
      mode: 'markers+text', type: 'scatter', name: 'ìš°ë¦¬ ì œí’ˆ',
      textposition: 'top center',
      textfont: { size: 12, color: '#E53935' },
      marker: { color: '#E53935', symbol: 'star', size: 20, line: { width: 2, color: '#B71C1C' } }
    });
  }

  const mp = categories._medianPrice || 0;
  const ms = categories._medianScore || 50;
  const prices = scored.map(r => r[priceCol]);
  const xPad = (Math.max(...prices) - Math.min(...prices)) * 0.08 || 50000;

  const layout = {
    title: {
      text: 'ì œí’ˆ í¬ì§€ì…”ë‹ ë§µ',
      font: { family: 'Malgun Gothic', size: 20, color: '#333' },
      x: 0.5, xanchor: 'center'
    },
    xaxis: {
      title: { text: 'ì œí’ˆ ê°€ê²© (ì›)', font: { size: 13 } },
      tickformat: ',', gridcolor: '#f0f0f0',
      range: [Math.min(...prices) - xPad, Math.max(...prices) + xPad]
    },
    yaxis: {
      title: { text: 'ê°€ì¤‘ ìŠ¤í™ ì ìˆ˜ (0-100)', font: { size: 13 } },
      range: [-5, 110], gridcolor: '#f0f0f0'
    },
    shapes: [
      { type:'line', x0:mp, x1:mp, y0:-5, y1:110, line:{dash:'dot',color:'#ccc',width:1.5} },
      { type:'line', x0:0, x1:1, y0:ms, y1:ms, xref:'paper', line:{dash:'dot',color:'#ccc',width:1.5} }
    ],
    annotations: [
      { x:0.01, y:1.02, xref:'paper', yref:'paper', text:'<b>ê°€ì„±ë¹„</b>', showarrow:false, font:{size:13,color:'rgba(76,175,80,0.3)'}, xanchor:'left' },
      { x:0.99, y:1.02, xref:'paper', yref:'paper', text:'<b>í”„ë¦¬ë¯¸ì—„</b>', showarrow:false, font:{size:13,color:'rgba(156,39,176,0.3)'}, xanchor:'right' },
      { x:0.01, y:-0.02, xref:'paper', yref:'paper', text:'<b>ë³´ê¸‰í˜•</b>', showarrow:false, font:{size:13,color:'rgba(33,150,243,0.3)'}, xanchor:'left' },
      { x:0.99, y:-0.02, xref:'paper', yref:'paper', text:'<b>ê³¼ì‰ ê°€ê²©</b>', showarrow:false, font:{size:13,color:'rgba(255,152,0,0.3)'}, xanchor:'right' }
    ],
    legend: { orientation:'h', y:1.15, x:0.5, xanchor:'center', font:{size:12} },
    template: 'plotly_white',
    font: { family: 'Malgun Gothic, sans-serif' },
    height: 650,
    margin: { t:80, b:70, l:70, r:30 },
    plot_bgcolor: '#fafbfc'
  };

  Plotly.newPlot('positioning-chart', traces, layout, { responsive:true });
}

// â”€â”€â”€ Result Table â”€â”€â”€
function renderResultTable() {
  const cols = [productCol, priceCol, ...specCols, '_rawScore', '_score'];
  const headers = cols.map(c => {
    if (c === '_score') return 'ìµœì¢… ì ìˆ˜';
    if (c === '_rawScore') return 'ì›ì‹œ ì ìˆ˜';
    return c;
  });
  const rows = scored.map(r => {
    const cat = categories[r[productCol]] || '';
    return `<tr>${cols.map(c => {
      if (c === '_score') return `<td><div style="display:flex;align-items:center;gap:8px;"><div class="progress-bar" style="width:80px"><div class="fill" style="width:${r._score}%"></div></div><span style="font-weight:700;">${r._score.toFixed(1)}</span></div></td>`;
      if (c === '_rawScore') return `<td style="font-size:11px;color:var(--gray-500);">${r._rawScore.toFixed(3)}</td>`;
      if (c === productCol) return `<td><strong>${r[c]}</strong> <span class="category-badge badge-${cat}">${cat}</span></td>`;
      if (c === priceCol) return `<td>${Number(r[c]).toLocaleString()}</td>`;
      // ìŠ¤í™ ì»¬ëŸ¼: ì›ë³¸ê°’ + ë³€í™˜ê°’ í‘œì‹œ
      const raw = r[c] ?? '';
      const num = specToNum(r[c]);
      const norm = r['_norm_'+c];
      const numStr = num !== null ? num : '?';
      const color = num === 1 ? '#4CAF50' : num === 0 ? '#E53935' : 'var(--gray-700)';
      return `<td><span style="color:${color};font-weight:600;">${raw}</span> <span style="font-size:10px;color:var(--gray-500);">(${numStr})</span></td>`;
    }).join('')}</tr>`;
  });
  document.getElementById('result-table').innerHTML =
    `<div class="table-wrap"><table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${rows.join('')}</tbody></table></div>`;
}

// â”€â”€â”€ Simulation â”€â”€â”€
function setupSimulation() {
  const card = document.getElementById('card-sim');
  card.classList.remove('hidden');
  card.classList.add('fade-in');
  const fields = document.getElementById('sim-fields');
  const medPrice = scored.map(r=>r[priceCol]).sort((a,b)=>a-b)[Math.floor(scored.length/2)] || 0;

  let html = `<div><label>ì œí’ˆëª…</label><input type="text" id="sim-name" value="ìš°ë¦¬ ì œí’ˆ"></div>`;
  html += `<div><label>ê°€ê²©</label><input type="number" id="sim-price" value="${Math.round(medPrice)}" step="10000"></div>`;
  for (const c of specCols) {
    const info = analyzeColumnType(c);
    if (info.type === 'ox') {
      html += `<div><label>${c} <span style="font-size:10px;color:#9C27B0;">(ìœ /ë¬´)</span></label><select id="sim-${CSS.escape(c)}" class="sim-spec" data-col="${c}" data-type="ox">
        <option value="O">O (ìœ )</option><option value="X">X (ë¬´)</option>
      </select></div>`;
    } else if (info.type === 'text') {
      const unique = [...new Set(rawData.map(r => String(r[c] ?? '').trim()))].filter(v => v).sort();
      html += `<div><label>${c} <span style="font-size:10px;color:var(--gray-500);">(í…ìŠ¤íŠ¸)</span></label><select id="sim-${CSS.escape(c)}" class="sim-spec" data-col="${c}" data-type="text">
        ${unique.map(v => `<option value="${v}">${v}</option>`).join('')}
      </select></div>`;
    } else {
      const vals = rawData.map(r => specToNum(r[c])).filter(v => v !== null);
      const med = vals.length ? vals.sort((a,b)=>a-b)[Math.floor(vals.length/2)] : 0;
      html += `<div><label>${c} <span style="font-size:10px;color:var(--warning);">(ìˆ«ì)</span></label><input type="text" id="sim-${CSS.escape(c)}" value="${med}" class="sim-spec" data-col="${c}" data-type="num"></div>`;
    }
  }
  fields.innerHTML = html;
}

function runSimulation() {
  const name = document.getElementById('sim-name').value || 'ìš°ë¦¬ ì œí’ˆ';
  const price = parseFloat(document.getElementById('sim-price').value) || 0;
  const specs = {};
  document.querySelectorAll('.sim-spec').forEach(inp => {
    const info = analyzeColumnType(inp.dataset.col);
    if (info.type === 'text') {
      specs[inp.dataset.col] = inp.value;  // í…ìŠ¤íŠ¸ëŠ” ì›ë³¸ ìœ ì§€
    } else {
      specs[inp.dataset.col] = specToNum(inp.value);
    }
  });

  const w = getWeights();
  // Normalize using existing min/max
  let score = 0;
  for (const c of specCols) {
    const info = analyzeColumnType(c);
    let norm = 0.5;
    if (info.type === 'text') {
      // ordinal ì¸ì½”ë”©
      const unique = [...new Set(rawData.map(r => String(r[c] ?? '').trim()))].filter(v => v).sort();
      const idx = unique.indexOf(String(specs[c] ?? ''));
      norm = unique.length > 1 && idx >= 0 ? idx / (unique.length - 1) : 0.5;
    } else {
      const vals = rawData.map(r => specToNum(r[c])).filter(v => v !== null);
      const mn = vals.length ? Math.min(...vals) : 0;
      const mx = vals.length ? Math.max(...vals) : 1;
      const range = mx - mn || 1;
      norm = ((specs[c] ?? 0) - mn) / range;
      norm = Math.max(0, Math.min(1, norm));
    }
    score += norm * (w[c] || 0);
  }
  score *= 100;

  // ê¸°ì¡´ ì œí’ˆë“¤ ìˆœìœ„ ì•ˆì—ì„œ ì‹œë®¬ë ˆì´ì…˜ ì œí’ˆì˜ ìœ„ì¹˜ ê³„ì‚°
  const allRawScores = [...scored.map(r => r._rawScore), score].sort((a,b) => a-b);
  const simIdx = allRawScores.indexOf(score);
  const totalN = allRawScores.length;
  score = totalN > 1 ? (simIdx / (totalN - 1)) * 90 + 5 : 50;

  const mp = categories._medianPrice, ms = categories._medianScore;
  const hp = price >= mp, hs = score >= ms;
  const cat = hp&&hs?'í”„ë¦¬ë¯¸ì—„':!hp&&hs?'ê°€ì„±ë¹„':!hp&&!hs?'ë³´ê¸‰í˜•':'ê³¼ì‰ìŠ¤í™';

  const allScores = [...scored.map(r=>r._score), score].sort((a,b)=>b-a);
  const rank = allScores.indexOf(score) + 1;
  const pct = ((1 - (rank-1)/allScores.length) * 100).toFixed(0);

  simProduct = { name, price, score, category: cat, rank, pct };

  document.getElementById('sim-result').classList.remove('hidden');
  document.getElementById('sim-result').innerHTML = `
    <div class="sim-result">
      <div class="metric-grid" style="margin-bottom:12px;">
        <div class="metric-card"><div class="value">${score.toFixed(1)}</div><div class="label">ìŠ¤í™ ì ìˆ˜</div></div>
        <div class="metric-card"><div class="value"><span class="category-badge badge-${cat}">${cat}</span></div><div class="label">í¬ì§€ì…”ë‹</div></div>
        <div class="metric-card"><div class="value">${rank}ìœ„ / ${allScores.length}ê°œ</div><div class="label">ìˆœìœ„</div></div>
        <div class="metric-card"><div class="value">${pct}%</div><div class="label">ìƒìœ„ ë°±ë¶„ìœ„</div></div>
      </div>
      <p style="font-size:13px;"><strong>${name}</strong>ì€(ëŠ”) ê°€ê²© ${price.toLocaleString()}ì›, ìŠ¤í™ ì ìˆ˜ ${score.toFixed(1)}ì ìœ¼ë¡œ <strong>${cat}</strong> ì˜ì—­ì— ìœ„ì¹˜í•©ë‹ˆë‹¤. (ìƒìœ„ ${pct}%)</p>
    </div>`;

  renderPositioningMap(); // Redraw with our product
}

// â”€â”€â”€ Download â”€â”€â”€
function downloadPNG() {
  Plotly.downloadImage('positioning-chart', {
    format: 'png', width: 1800, height: 1200, scale: 2, filename: 'positioning_map'
  });
}

function downloadCSV() {
  if (!scored.length) return;
  const cols = [productCol, priceCol, ...specCols, '_score'];
  const headers = cols.map(c => c==='_score'?'ìŠ¤í™ì ìˆ˜':c);
  let csv = '\uFEFF' + headers.join(',') + '\n';
  for (const r of scored) {
    csv += cols.map(c => {
      let v = c==='_score' ? r._score.toFixed(1) : (r[c]??'');
      if (String(v).includes(',')) v = `"${v}"`;
      return v;
    }).join(',') + '\n';
  }
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'cleaned_market_data.csv';
  a.click();
}

// â”€â”€â”€ Tabs â”€â”€â”€
function switchTab(id, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
}

// â”€â”€â”€ Table Builder â”€â”€â”€
function buildTable(data, cols) {
  if (!data.length) return '<p style="color:var(--gray-500);font-size:13px;">ë°ì´í„° ì—†ìŒ</p>';
  return `<div class="table-wrap"><table>
    <thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>
    <tbody>${data.map(r=>`<tr>${cols.map(c=>`<td>${r[c]??''}</td>`).join('')}</tr>`).join('')}</tbody>
  </table></div>`;
}
</script>
</body>
</html>
